# ××¨×›×™×˜×§×˜×•×¨×ª ××¢×¨×›×ª × ×™×”×•×œ × ×ª×•× ×™× - ×“×™×¨×•×’ ×¦×™×•× ×•×ª

## ×¡×§×™×¨×” ×›×œ×œ×™×ª

××¢×¨×›×ª × ×™×”×•×œ × ×ª×•× ×™× ×œ× ×™×”×•×œ ×•× ×™×ª×•×— ×§×™×©×•×¨×™ URL ×”×§×©×•×¨×™× ×œ×–×”×•×ª ×™×©×¨××œ×™×ª ×•×¦×™×•× ×•×ª. ×”××¢×¨×›×ª ×××¤×©×¨×ª ×—×™×œ×•×¥ ××˜×-×“××˜×” ××•×˜×•××˜×™, ×™×¦×™×¨×ª ×¡×™×›×•××™×, ×•× ×™×”×•×œ × ×ª×•× ×™× ××ª×§×“×.

---

## ××‘× ×” ×”××¢×¨×›×ª

### 1. ×©×›×‘×•×ª ×”××¤×œ×™×§×¦×™×”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend Layer (HTML/CSS/JavaScript)  â”‚
â”‚   - index.html                          â”‚
â”‚   - assets/css/style.css                â”‚
â”‚   - assets/js/app.js                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Layer (PHP)                       â”‚
â”‚   - api/get_records.php                 â”‚
â”‚   - api/get_record.php                  â”‚
â”‚   - api/save_record.php                 â”‚
â”‚   - api/delete_record.php               â”‚
â”‚   - api/create_summary.php              â”‚
â”‚   - api/retry_extraction.php            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Business Logic Layer                  â”‚
â”‚   - lib/url_fetcher.php                 â”‚
â”‚   - extract_metadata.php                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Data Access Layer                     â”‚
â”‚   - config/database.php                  â”‚
â”‚   - ensure_metadata_columns.php         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Database Layer                        â”‚
â”‚   - ranking_urls table                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ×¤×¡××•×“×• ×§×•×“ - ×–×¨×™××ª × ×ª×•× ×™× ××œ××”

### 2.1 ×˜×¢×™× ×ª ×¨×©×•××•×ª (Load Records)

```
FUNCTION loadRecords():
    // ×©×œ×‘ 1: ×”×›× ×ª ×¤×¨××˜×¨×™×
    pageSize = GET value from "pageSize" dropdown
    sortBy = GET value from "sortBy" dropdown  
    sortOrder = GET value from "sortOrder" dropdown
    currentFilters = GET all filter values (URL search, status, orgType, topic, year)
    
    // ×©×œ×‘ 2: ×‘× ×™×™×ª URL ×¢× ×¤×¨××˜×¨×™×
    params = BUILD URLSearchParams({
        page: currentPage,
        pageSize: pageSize,
        sortBy: sortBy,
        sortOrder: sortOrder,
        ...currentFilters
    })
    
    // ×©×œ×‘ 3: ×§×¨×™××” ×œ-API
    TRY:
        response = FETCH "api/get_records.php?" + params
        IF response.status != 200:
            THROW error
        
        data = PARSE JSON from response
        
        IF data.success == true:
            // ×©×œ×‘ 4: ×”×¦×’×ª × ×ª×•× ×™×
            displayRecords(data.records)
            updatePagination(data.pagination)
            updateStats(data.stats)
        ELSE:
            SHOW error message: data.error
            DISPLAY error in table
    CATCH error:
        LOG error to console
        SHOW error message to user
        DISPLAY error in table
END FUNCTION
```

### 2.2 ×”×¦×’×ª ×¨×©×•××•×ª ×‘×˜×‘×œ×” (Display Records)

```
FUNCTION displayRecords(records):
    tbody = GET element by ID "tableBody"
    
    IF records.length == 0:
        SET tbody.innerHTML = "<tr><td colspan='9'>×œ× × ××¦××• ×¨×©×•××•×ª</td></tr>"
        RETURN
    END IF
    
    // ×¢×™×‘×•×“ ×›×œ ×¨×©×•××”
    htmlRows = []
    FOR EACH record IN records:
        // ×‘×“×™×§×ª ×¡×™×›×•×
        hasSummary = false
        summaryText = ""
        
        IF record.short_summary != null AND 
           record.short_summary != undefined AND 
           record.short_summary != "":
            summaryText = TRIM(record.short_summary)
            hasSummary = (summaryText.length > 0)
        END IF
        
        // ×‘× ×™×™×ª ×ª× ×¡×™×›×•×
        IF hasSummary:
            summaryCell = "<span class='summary-text'>" + 
                         TRUNCATE(summaryText, 50) + 
                         "</span>"
        ELSE:
            summaryCell = "<button class='btn-summarize' " +
                         "onclick='createSummary(" + record.id + ")' " +
                         "id='summary-btn-" + record.id + "'>" +
                         "×¦×•×¨ ×ª×™××•×¨" +
                         "</button>"
        END IF
        
        // ×‘× ×™×™×ª ×©×•×¨×” ×‘×˜×‘×œ×”
        row = BUILD HTML row with:
            - record.id
            - record.url (as link)
            - status badge (record.metadata_status)
            - organization_type (translated)
            - topic_category (translated)
            - record.year or "-"
            - summaryCell
            - formatted created_at date
            - action buttons (view, edit, summarize, retry if failed, delete)
        
        ADD row to htmlRows
    END FOR
    
    SET tbody.innerHTML = JOIN htmlRows with ""
END FUNCTION
```

### 2.3 ×™×¦×™×¨×ª ×¡×™×›×•× (Create Summary)

```
FUNCTION createSummary(recordId):
    // ×©×œ×‘ 1: ××¦×™××ª ×”×›×¤×ª×•×¨ ×•×¢×“×›×•×Ÿ ××¦×‘
    btn = GET element by ID "summary-btn-" + recordId
    IF btn == null:
        RETURN
    END IF
    
    // ×©×œ×‘ 2: ×¢×“×›×•×Ÿ UI ×œ××¦×‘ ×˜×¢×™× ×”
    SET btn.disabled = true
    SET btn.innerHTML = "×™×•×¦×¨..."
    SET btn.title = "×™×•×¦×¨ ×¡×™×›×•×..."
    
    // ×©×œ×‘ 3: ×§×¨×™××” ×œ-API
    TRY:
        response = FETCH "api/create_summary.php" WITH:
            method: POST
            headers: { "Content-Type": "application/json" }
            body: JSON.stringify({ id: recordId })
        
        IF response.status != 200:
            THROW error
        
        data = PARSE JSON from response
        
        IF data.success == true:
            // ×©×œ×‘ 4: ×¨×¢× ×•×Ÿ ×”×˜×‘×œ×”
            loadRecords()
            SHOW success message: data.message
        ELSE:
            SHOW error message: data.error
            // ×©×œ×‘ 5: ×”×—×–×¨×ª ×”×›×¤×ª×•×¨ ×œ××¦×‘ ×¨×’×™×œ
            SET btn.disabled = false
            SET btn.innerHTML = "×¦×•×¨ ×ª×™××•×¨"
            SET btn.title = "×¦×•×¨ ×ª×™××•×¨"
        END IF
    CATCH error:
        LOG error to console
        SHOW error message to user
        // ×”×—×–×¨×ª ×”×›×¤×ª×•×¨ ×œ××¦×‘ ×¨×’×™×œ
        SET btn.disabled = false
        SET btn.innerHTML = "×¦×•×¨ ×ª×™××•×¨"
        SET btn.title = "×¦×•×¨ ×ª×™××•×¨"
    END TRY
END FUNCTION
```

### 2.4 API: ×™×¦×™×¨×ª ×¡×™×›×•× (Backend)

```
FUNCTION create_summary.php:
    // ×©×œ×‘ 1: ×§×‘×œ×ª × ×ª×•× ×™×
    input = PARSE JSON from request body
    recordId = input.id
    
    IF recordId is empty:
        RETURN error 400: "××–×”×” ×¨×©×•××” × ×“×¨×©"
    END IF
    
    // ×©×œ×‘ 2: ×—×™×‘×•×¨ ×œ××¡×“ × ×ª×•× ×™×
    conn = GET database connection
    
    // ×©×œ×‘ 3: ×§×‘×œ×ª ×¨×©×•××”
    query = "SELECT * FROM ranking_urls WHERE id = ?"
    record = EXECUTE query with recordId
    
    IF record not found:
        RETURN error 404: "×¨×©×•××” ×œ× × ××¦××”"
    END IF
    
    // ×©×œ×‘ 4: ××©×™×›×ª ×ª×•×›×Ÿ ××”-URL
    TRY:
        urlContent = fetchWebpageContent(record.url)
    CATCH error:
        urlContent = "[×œ× × ×™×ª×Ÿ ×œ××©×•×š ×ª×•×›×Ÿ: " + error + "]"
    END TRY
    
    // ×©×œ×‘ 5: ×‘× ×™×™×ª ××˜×-×“××˜×” ×§×™×™××ª
    metadataParts = []
    IF record.source_type: ADD "×¡×•×’ ××§×•×¨: " + record.source_type
    IF record.year: ADD "×©× ×”: " + record.year
    IF record.organization_type: ADD "×¡×•×’ ××¨×’×•×Ÿ: " + record.organization_type
    ... (×›×œ ×”×©×“×•×ª ×”×¨×œ×•×•× ×˜×™×™×)
    
    metadataString = JOIN metadataParts with ", "
    
    // ×©×œ×‘ 6: ×‘× ×™×™×ª prompt ×œ-GPT-4o
    prompt = "×¢×œ ×‘×¡×™×¡ ×”×ª×•×›×Ÿ ×”×‘× ×•×”××˜×-×“××˜×” ×”×§×™×™××ª, " +
             "×¦×•×¨ ×¡×™×›×•× ×§×¦×¨ ×‘×¢×‘×¨×™×ª (2-3 ××©×¤×˜×™×) ×©×œ ×”××¡××š.\n" +
             "×”×ª××§×“ ×‘× ×•×©× ×”××¨×›×–×™, × ×•×©××™ ××¤×ª×—, " +
             "×•×”×¨×œ×•×•× ×˜×™×•×ª ×œ×–×”×•×ª ×™×©×¨××œ×™×ª ×•×¦×™×•× ×•×ª.\n\n" +
             "URL: " + record.url + "\n\n" +
             "×ª×•×›×Ÿ ×”×“×£:\n" + SUBSTRING(urlContent, 0, 5000) + "\n\n" +
             "××˜×-×“××˜×” ×§×™×™××ª:\n" + metadataString + "\n\n" +
             "×¦×•×¨ ×¡×™×›×•× ×§×¦×¨ ×•××“×•×™×§ ×‘×¢×‘×¨×™×ª (2-3 ××©×¤×˜×™× ×‘×œ×‘×“)."
    
    // ×©×œ×‘ 7: ×§×¨×™××” ×œ-OpenAI API
    apiRequest = {
        model: "gpt-4o",
        messages: [
            {
                role: "system",
                content: "××ª×” ×¢×•×–×¨ ××§×¦×•×¢×™ ×œ×™×¦×™×¨×ª ×¡×™×›×•××™× ×‘×¢×‘×¨×™×ª..."
            },
            {
                role: "user",
                content: prompt
            }
        ],
        temperature: 0.5,
        max_tokens: 500
    }
    
    response = CALL OpenAI API with apiRequest
    
    IF response.error:
        THROW error: response.error
    END IF
    
    summary = TRIM(response.choices[0].message.content)
    summary = REMOVE markdown code blocks from summary
    
    // ×©×œ×‘ 8: ×©××™×¨×” ×œ××¡×“ × ×ª×•× ×™×
    updateQuery = "UPDATE ranking_urls SET short_summary = ? WHERE id = ?"
    EXECUTE updateQuery with (summary, recordId)
    
    // ×©×œ×‘ 9: ×”×—×–×¨×ª ×ª×©×•×‘×”
    RETURN {
        success: true,
        message: "×¡×™×›×•× × ×•×¦×¨ ×‘×”×¦×œ×—×”",
        summary: summary
    }
END FUNCTION
```

### 2.5 × ×™×¡×™×•×Ÿ ×—×™×œ×•×¥ ××—×“×© (Retry Extraction)

```
FUNCTION retryExtraction(recordId):
    // ×©×œ×‘ 1: ××™×©×•×¨ ××©×ª××©
    IF NOT confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×¡×•×ª ×©×•×‘?"):
        RETURN
    END IF
    
    // ×©×œ×‘ 2: ××¦×™××ª ×”×›×¤×ª×•×¨ ×•×¢×“×›×•×Ÿ ××¦×‘
    btn = GET element by ID "retry-btn-" + recordId
    SET btn.disabled = true
    SET btn.innerHTML = "â³"
    SET btn.title = "×× ×¡×” ×©×•×‘..."
    
    // ×©×œ×‘ 3: ×§×¨×™××” ×œ-API
    TRY:
        response = FETCH "api/retry_extraction.php" WITH:
            method: POST
            headers: { "Content-Type": "application/json" }
            body: JSON.stringify({ id: recordId })
        
        data = PARSE JSON from response
        
        IF data.success == true:
            loadRecords()
            SHOW success message: data.message
        ELSE:
            errorMsg = data.error
            IF data.failure_reason:
                errorMsg += "\n\n×¡×™×‘×ª ×›×©×œ×•×Ÿ:\n" + data.failure_reason
            END IF
            ALERT errorMsg
        END IF
    CATCH error:
        SHOW error message
    FINALLY:
        SET btn.disabled = false
        SET btn.innerHTML = "ğŸ”„"
        SET btn.title = "× ×¡×” ×©×•×‘"
    END TRY
END FUNCTION
```

### 2.6 API: × ×™×¡×™×•×Ÿ ×—×™×œ×•×¥ ××—×“×© (Backend)

```
FUNCTION retry_extraction.php:
    // ×©×œ×‘ 1: ×§×‘×œ×ª × ×ª×•× ×™×
    input = PARSE JSON from request body
    recordId = input.id
    
    // ×©×œ×‘ 2: ×§×‘×œ×ª ×¨×©×•××”
    record = GET record from database WHERE id = recordId
    
    // ×©×œ×‘ 3: ××©×™×›×ª ×ª×•×›×Ÿ
    TRY:
        content = fetchWebpageContent(record.url)
        urlInfo = PARSE URL(record.url)
        domain = urlInfo.host
        path = urlInfo.path
    CATCH error:
        content = "[Error: " + error + "]"
    END TRY
    
    // ×©×œ×‘ 4: ×—×™×œ×•×¥ ××˜×-×“××˜×” ×¢× GPT-4o
    TRY:
        metadata = extractMetadataWithOpenAI(
            record.url, 
            domain, 
            path, 
            content, 
            existingContentTypes
        )
        
        IF metadata AND metadata.source_type:
            // ×©×œ×‘ 5: ×¢×“×›×•×Ÿ ××¡×“ × ×ª×•× ×™× - ×”×¦×œ×—×”
            UPDATE ranking_urls SET:
                source_type = metadata.source_type
                year = metadata.year
                organization_type = metadata.organization_type
                ... (×›×œ ×”×©×“×•×ª)
                metadata_status = 'extracted'
                failure_reason = NULL
                metadata_extracted_at = NOW()
            WHERE id = recordId
            
            RETURN {
                success: true,
                message: "××˜×-×“××˜×” ×—×•×œ×¦×” ×‘×”×¦×œ×—×”",
                metadata: metadata
            }
        ELSE:
            THROW error: "Failed to extract metadata"
        END IF
    CATCH error:
        // ×©×œ×‘ 6: ×”×¡×‘×¨ ×›×©×œ×•×Ÿ ×¢× GPT-4o
        failureReason = explainFailure(record.url, content, error.message)
        
        // ×©×œ×‘ 7: ×¢×“×›×•×Ÿ ××¡×“ × ×ª×•× ×™× - ×›×©×œ×•×Ÿ
        UPDATE ranking_urls SET:
            metadata_status = 'failed'
            failure_reason = failureReason
            metadata_extracted_at = NOW()
        WHERE id = recordId
        
        RETURN {
            success: false,
            message: "×—×™×œ×•×¥ ××˜×-×“××˜×” × ×›×©×œ",
            failure_reason: failureReason
        }
    END TRY
END FUNCTION
```

---

## ××‘× ×” ××¡×“ ×”× ×ª×•× ×™×

### 3.1 ×˜×‘×œ×ª ranking_urls

```
TABLE ranking_urls:
    PRIMARY KEY: id (INT AUTO_INCREMENT)
    
    // ×©×“×•×ª ×‘×¡×™×¡×™×™×
    url (VARCHAR(2048) UNIQUE NOT NULL)
    created_at (TIMESTAMP DEFAULT CURRENT_TIMESTAMP)
    
    // ××˜×-×“××˜×” ×‘×¡×™×¡×™
    source_type (VARCHAR(100) NULL)
    year (INT NULL)
    metadata_extracted_at (TIMESTAMP NULL)
    metadata_status (ENUM: 'pending', 'extracted', 'failed')
    
    // ×”×§×©×¨ ××•×¡×“×™
    organization_type (ENUM: 'municipality', 'government_agency', ...)
    jurisdiction_level (ENUM: 'local', 'regional', 'national', 'international')
    geographic_scope (VARCHAR(200) NULL)
    
    // ×ª×—×•× ×ª×•×›×Ÿ
    topic_category (ENUM: 'education', 'culture', 'policy', ...)
    document_type (ENUM: 'report', 'article', 'policy_document', ...)
    target_audience (ENUM: 'general_public', 'educators', ...)
    content_type (VARCHAR(200) NULL)
    
    // ××™× ×“×™×§×˜×•×¨×™× ××™×“×™××•×œ×•×’×™×™×
    values_orientation (JSON NULL)
    cultural_focus (ENUM: 'hebrew_culture', 'jewish_heritage', ...)
    
    // ×–×”×•×ª ×•×¦×™×•× ×•×ª
    zionism_references (ENUM: 'explicit', 'implicit', 'none', 'unclear')
    identity_theme (JSON NULL)
    historical_periods (JSON NULL)
    
    // ×©×§×™×¤×•×ª ×•×©×¤×”
    language (ENUM: 'hebrew', 'english', 'arabic', ...)
    accessibility_level (ENUM: 'public', 'restricted', 'unclear')
    publication_format (ENUM: 'pdf', 'html', 'text', ...)
    
    // ×¡×× ×™× ×–×× ×™×™×
    period_referenced (VARCHAR(100) NULL)
    temporal_scope (ENUM: 'current', 'historical', 'future', 'mixed')
    
    // ××™×›×•×ª ××§×•×¨
    completeness (ENUM: 'full_document', 'excerpt', 'summary', 'unclear')
    reliability_indicators (JSON NULL)
    
    // ×¡×™×›×•× ×•×›×©×œ×•× ×•×ª
    short_summary (TEXT NULL)  // ×¡×™×›×•× ×§×¦×¨ ×‘×¢×‘×¨×™×ª
    failure_reason (TEXT NULL)  // ×¡×™×‘×ª ×›×©×œ×•×Ÿ ×‘×—×™×œ×•×¥
END TABLE
```

---

## ×–×¨×™××ª ×¢×‘×•×“×” ××œ××”

### 4.1 ×ª×”×œ×™×š ×™×¦×™×¨×ª ×¡×™×›×•× (Complete Flow)

```
USER ACTION: Click "×¦×•×¨ ×ª×™××•×¨" button
    â†“
FRONTEND: createSummary(recordId)
    â†“
    - Disable button
    - Show "×™×•×¦×¨..." text
    â†“
API CALL: POST api/create_summary.php
    â†“
BACKEND: create_summary.php
    â†“
    STEP 1: Validate input (recordId)
    STEP 2: Get record from database
    STEP 3: Fetch URL content (fetchWebpageContent)
        - Use cURL to fetch webpage
        - Handle PDFs, binary files, errors
        - Clean HTML, limit to 8000 chars
    STEP 4: Build existing metadata string
    STEP 5: Build GPT-4o prompt
        - Include URL
        - Include content excerpt (5000 chars)
        - Include existing metadata
        - Request Hebrew summary (2-3 sentences)
    STEP 6: Call OpenAI API
        - Model: gpt-4o
        - Temperature: 0.5
        - Max tokens: 500
    STEP 7: Parse response
        - Extract summary text
        - Remove markdown formatting
    STEP 8: Save to database
        UPDATE ranking_urls SET short_summary = ?
    STEP 9: Return success response
    â†“
FRONTEND: Receive response
    â†“
    IF success:
        - Refresh table (loadRecords)
        - Show success message
    ELSE:
        - Show error message
        - Re-enable button
    â†“
RESULT: Summary appears in table, button replaced with text
```

### 4.2 ×ª×”×œ×™×š × ×™×¡×™×•×Ÿ ×—×™×œ×•×¥ ××—×“×© (Complete Flow)

```
USER ACTION: Click "ğŸ”„ × ×¡×” ×©×•×‘" button (only for failed records)
    â†“
FRONTEND: retryExtraction(recordId)
    â†“
    - Confirm action
    - Disable button
    - Show loading state
    â†“
API CALL: POST api/retry_extraction.php
    â†“
BACKEND: retry_extraction.php
    â†“
    STEP 1: Get record from database
    STEP 2: Parse URL (domain, path)
    STEP 3: Fetch URL content
    STEP 4: Get existing content types for context
    STEP 5: Call extractMetadataWithOpenAI
        - Build comprehensive prompt
        - Call GPT-4o API
        - Parse JSON response
        - Validate required fields
    â†“
    IF SUCCESS:
        STEP 6A: Update all metadata fields
        STEP 7A: Set status = 'extracted'
        STEP 8A: Clear failure_reason
        STEP 9A: Return success
    ELSE:
        STEP 6B: Call explainFailure (GPT-4o)
            - Build diagnostic prompt
            - Get failure explanation in Hebrew
        STEP 7B: Update status = 'failed'
        STEP 8B: Save failure_reason
        STEP 9B: Return failure with explanation
    â†“
FRONTEND: Receive response
    â†“
    IF success:
        - Refresh table
        - Show success message
        - Status badge changes to "×—×•×œ×¥"
    ELSE:
        - Show error with failure_reason
        - Status badge remains "× ×›×©×œ"
    â†“
RESULT: Record updated, status changed, failure reason displayed
```

---

## ×¤×•× ×§×¦×™×•×ª ×¢×–×¨

### 5.1 fetchWebpageContent (URL Fetcher)

```
FUNCTION fetchWebpageContent(url):
    // ×©×œ×‘ 1: ×”×›× ×ª cURL request
    ch = INIT cURL session
    
    SET cURL options:
        - URL: url
        - RETURNTRANSFER: true
        - FOLLOWLOCATION: true
        - MAXREDIRS: 5
        - TIMEOUT: 30 seconds
        - USERAGENT: Mozilla/5.0...
        - SSL_VERIFYPEER: false
        - HEADER: true (to get headers)
    
    // ×©×œ×‘ 2: ×‘×™×¦×•×¢ request
    response = EXECUTE cURL request
    httpCode = GET HTTP status code
    headerSize = GET header size
    contentType = GET Content-Type header
    error = GET cURL error if any
    
    CLOSE cURL session
    
    // ×©×œ×‘ 3: ×‘×“×™×§×ª ×©×’×™××•×ª
    IF error:
        THROW Exception: "cURL error: " + error
    END IF
    
    IF httpCode != 200:
        THROW Exception: "HTTP error: " + httpCode
    END IF
    
    // ×©×œ×‘ 4: ×”×¤×¨×“×ª headers ××ª×•×›×Ÿ
    headers = SUBSTRING(response, 0, headerSize)
    content = SUBSTRING(response, headerSize)
    
    // ×©×œ×‘ 5: ×‘×“×™×§×ª ×¡×•×’ ×§×•×‘×¥
    IF contentType contains "application/pdf" OR content starts with "%PDF":
        RETURN "[PDF File] - Cannot extract text..."
    END IF
    
    IF content is not UTF-8:
        RETURN "[Binary File] - Cannot extract text..."
    END IF
    
    // ×©×œ×‘ 6: × ×™×§×•×™ HTML
    content = STRIP_TAGS(content)
    content = HTML_ENTITY_DECODE(content)
    content = REPLACE multiple spaces with single space
    content = TRIM(content)
    
    // ×©×œ×‘ 7: ×”×’×‘×œ×ª ××•×¨×š
    IF LENGTH(content) > 8000:
        content = SUBSTRING(content, 0, 8000) + "..."
    END IF
    
    RETURN content
END FUNCTION
```

### 5.2 extractMetadataWithOpenAI

```
FUNCTION extractMetadataWithOpenAI(url, domain, path, content, existingContentTypes):
    // ×©×œ×‘ 1: ×‘× ×™×™×ª prompt ××§×™×£
    prompt = BUILD comprehensive prompt with:
        - URL information
        - Content excerpt (5000 chars)
        - Instructions for all metadata fields
        - Existing content types for consistency
        - JSON format requirements
    
    // ×©×œ×‘ 2: ×§×¨×™××” ×œ-OpenAI API
    apiRequest = {
        model: "gpt-4o",
        messages: [
            { role: "system", content: "..." },
            { role: "user", content: prompt }
        ],
        temperature: 0.3,
        max_tokens: 1500
    }
    
    response = CALL OpenAI API
    
    // ×©×œ×‘ 3: ×¤×¨×¡×•×¨ ×ª×©×•×‘×”
    apiContent = EXTRACT content from response
    apiContent = REMOVE markdown code blocks
    metadata = PARSE JSON(apiContent)
    
    // ×©×œ×‘ 4: ×•×œ×™×“×¦×™×”
    IF metadata.source_type is missing:
        THROW Exception: "Missing source_type"
    END IF
    
    // ×©×œ×‘ 5: ××™×œ×•×™ ×©×“×•×ª ×—×¡×¨×™× ×‘-null
    requiredFields = [
        'source_type', 'year', 'organization_type', 
        'jurisdiction_level', 'geographic_scope',
        'topic_category', 'document_type', 'target_audience',
        'content_type', 'values_orientation', 'cultural_focus',
        'zionism_references', 'identity_theme', 'historical_periods',
        'language', 'accessibility_level', 'publication_format',
        'period_referenced', 'temporal_scope', 'completeness',
        'reliability_indicators'
    ]
    
    FOR EACH field IN requiredFields:
        IF field not in metadata:
            SET metadata[field] = null
        END IF
    END FOR
    
    RETURN metadata
END FUNCTION
```

### 5.3 explainFailure

```
FUNCTION explainFailure(url, content, errorMessage):
    // ×‘× ×™×™×ª prompt ×œ×”×¡×‘×¨ ×›×©×œ×•×Ÿ
    prompt = "×”×¡×‘×¨ ×‘×¢×‘×¨×™×ª ××“×•×¢ × ×›×©×œ ×—×™×œ×•×¥ ×”××˜×-×“××˜×”:\n\n" +
             "URL: " + url + "\n" +
             "×©×’×™××”: " + errorMessage + "\n\n" +
             "×ª×•×›×Ÿ ×©× ×©×œ×£:\n" + SUBSTRING(content, 0, 2000) + "\n\n" +
             "×”×¡×‘×¨ ××ª ×”×¡×™×‘×” ×œ×›×©×œ×•×Ÿ ×‘×¦×•×¨×” ×‘×¨×•×¨×” ×•××§×¦×•×¢×™×ª ×‘×¢×‘×¨×™×ª (2-3 ××©×¤×˜×™×)."
    
    // ×§×¨×™××” ×œ-GPT-4o
    apiRequest = {
        model: "gpt-4o",
        messages: [
            { role: "system", content: "..." },
            { role: "user", content: prompt }
        ],
        temperature: 0.5,
        max_tokens: 300
    }
    
    TRY:
        response = CALL OpenAI API
        explanation = EXTRACT content from response
        RETURN TRIM(explanation)
    CATCH error:
        RETURN "×œ× × ×™×ª×Ÿ ×œ×—×œ×¥ ××˜×-×“××˜×” ××”×§×™×©×•×¨. ×©×’×™××”: " + errorMessage
    END TRY
END FUNCTION
```

---

## ××¦×‘×™ UI ×•×”×ª× ×”×’×•×ª

### 6.1 ××¦×‘×™ ×›×¤×ª×•×¨ "×¦×•×¨ ×ª×™××•×¨"

```
STATE: Initial (No Summary)
    - Button visible: YES
    - Button text: "×¦×•×¨ ×ª×™××•×¨"
    - Button enabled: YES
    - Button color: Green (#4CAF50)
    - On click: createSummary()

STATE: Loading (Creating Summary)
    - Button visible: YES
    - Button text: "×™×•×¦×¨..."
    - Button enabled: NO
    - Button color: Gray (disabled)
    - On click: (disabled)

STATE: Success (Summary Created)
    - Button visible: NO
    - Summary text visible: YES
    - Summary text: Truncated summary (50 chars)
    - On hover: Full summary in tooltip

STATE: Error (Failed to Create)
    - Button visible: YES
    - Button text: "×¦×•×¨ ×ª×™××•×¨"
    - Button enabled: YES
    - Error message: Shown to user
    - User can retry
```

### 6.2 ××¦×‘×™ ×›×¤×ª×•×¨ "× ×¡×” ×©×•×‘"

```
STATE: Visible Condition
    - Only shown when: metadata_status == 'failed'
    - Position: Actions column

STATE: Initial
    - Button visible: YES (if failed)
    - Button icon: ğŸ”„
    - Button enabled: YES
    - On click: retryExtraction()

STATE: Loading
    - Button visible: YES
    - Button icon: â³
    - Button enabled: NO
    - On click: (disabled)

STATE: After Retry
    - If success: Button disappears, status changes to "×—×•×œ×¥"
    - If failed: Button remains, failure_reason displayed
```

---

## ×˜×™×¤×•×œ ×‘×©×’×™××•×ª

### 7.1 ×©×’×™××•×ª × ×¤×•×¦×•×ª ×•×˜×™×¤×•×œ

```
ERROR: Network Error
    FRONTEND: Show "×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª"
    ACTION: User can retry

ERROR: API Returns 404
    FRONTEND: Show "×¨×©×•××” ×œ× × ××¦××”"
    ACTION: Refresh page

ERROR: API Returns 500
    FRONTEND: Show error message from API
    BACKEND: Log full error details
    ACTION: Check server logs

ERROR: OpenAI API Error
    BACKEND: Catch exception
    FRONTEND: Show "×©×’×™××” ×‘×™×¦×™×¨×ª ×¡×™×›×•×: [error message]"
    ACTION: User can retry

ERROR: Database Column Missing
    BACKEND: ensureMetadataColumns() creates it automatically
    FRONTEND: No user impact

ERROR: Invalid JSON Response
    BACKEND: Return error with details
    FRONTEND: Show error, log to console
    ACTION: Check API response format
```

---

## ××•×¤×˜×™××™×–×¦×™×•×ª ×•×‘×™×¦×•×¢×™×

### 8.1 ××•×¤×˜×™××™×–×¦×™×•×ª

```
1. Caching:
    - No caching for now (always fresh data)
    - Future: Cache summaries for X hours

2. Rate Limiting:
    - OpenAI API: Built-in rate limits
    - Add delay between requests (500ms)

3. Batch Operations:
    - Future: Batch summary creation
    - Future: Batch retry for failed records

4. Lazy Loading:
    - Load summaries on demand
    - Pagination reduces initial load

5. Error Recovery:
    - Automatic retry with exponential backoff
    - Queue failed operations for later
```

---

## ××‘×˜×—×”

### 9.1 ×××¦×¢×™ ××‘×˜×—×”

```
1. Input Validation:
    - All user inputs validated
    - SQL injection prevention (prepared statements)
    - XSS prevention (HTML escaping)

2. API Security:
    - No authentication required (internal use)
    - Future: Add API keys

3. Database Security:
    - Prepared statements only
    - No direct SQL concatenation
    - Column existence checks

4. OpenAI API:
    - API key stored securely
    - Not exposed to frontend
    - Rate limiting respected
```

---

## ××‘× ×” ×§×‘×¦×™×

```
/
â”œâ”€â”€ index.html                          # ×¢××•×“ ×¨××©×™
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ style.css                   # ×¢×™×¦×•×‘
â”‚   â””â”€â”€ js/
â”‚       â””â”€â”€ app.js                      # ×œ×•×’×™×§×” frontend
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ get_records.php                 # ×§×‘×œ×ª ×¨×©×•××•×ª
â”‚   â”œâ”€â”€ get_record.php                  # ×§×‘×œ×ª ×¨×©×•××” ×‘×•×“×“×ª
â”‚   â”œâ”€â”€ save_record.php                 # ×©××™×¨×ª ×¨×©×•××”
â”‚   â”œâ”€â”€ delete_record.php               # ××—×™×§×ª ×¨×©×•××”
â”‚   â”œâ”€â”€ create_summary.php              # ×™×¦×™×¨×ª ×¡×™×›×•×
â”‚   â””â”€â”€ retry_extraction.php            # × ×™×¡×™×•×Ÿ ×—×™×œ×•×¥ ××—×“×©
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ database.php                    # ×”×’×“×¨×•×ª ××¡×“ × ×ª×•× ×™×
â”‚   â””â”€â”€ api_key.php                     # ××¤×ª×— OpenAI API
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ url_fetcher.php                 # ××©×™×›×ª ×ª×•×›×Ÿ ×-URL
â”œâ”€â”€ database/
â”‚   â”œâ”€â”€ schema.sql                      # ×¡×›××ª ××¡×“ × ×ª×•× ×™×
â”‚   â”œâ”€â”€ migrate_add_metadata_columns.php
â”‚   â””â”€â”€ migrate_add_summary_columns.php
â”œâ”€â”€ ensure_metadata_columns.php         # ×•×™×“×•× ×¢××•×“×•×ª ×§×™×™××•×ª
â””â”€â”€ extract_metadata.php               # ×—×™×œ×•×¥ ××˜×-×“××˜×” (CLI)
```

---

## ×¡×™×›×•×

××¢×¨×›×ª ×–×• ××¡×¤×§×ª:
1. × ×™×”×•×œ × ×ª×•× ×™× ××œ× ×¢× CRUD operations
2. ×—×™×œ×•×¥ ××˜×-×“××˜×” ××•×˜×•××˜×™ ×¢× GPT-4o
3. ×™×¦×™×¨×ª ×¡×™×›×•××™× ×‘×¢×‘×¨×™×ª
4. × ×™×¡×™×•×Ÿ ×—×™×œ×•×¥ ××—×“×© ×¢× ×”×¡×‘×¨ ×›×©×œ×•× ×•×ª
5. ×××©×§ ××©×ª××© ××™× ×˜×•××™×˜×™×‘×™ ×•× ×•×—

×›×œ ×”×¤×•× ×§×¦×™×•× ×œ×™×•×ª ××ª×•×¢×“×ª ×•××ª×•×›× × ×ª ×œ×¢×‘×•×“×” ×—×œ×§×” ×•×™×¢×™×œ×”.

