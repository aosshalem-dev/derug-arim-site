<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>דירוג ערים — ציון ראיות</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f8;
            color: #222;
            direction: rtl;
            line-height: 1.5;
            overflow-wrap: break-word;
        }

        /* ── Top Navigation ── */
        .top-nav {
            background: #1a1a2e; color: #fff; padding: 0;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .nav-inner {
            max-width: 1200px; margin: 0 auto;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
        }
        .nav-title {
            font-size: 1.1em; font-weight: 700; padding: 12px 0;
            white-space: nowrap;
        }
        .nav-tabs {
            display: flex; gap: 0; margin: 0;
        }
        .nav-tab {
            padding: 14px 18px; cursor: pointer; font-size: 0.85em;
            border-bottom: 3px solid transparent; transition: all 0.2s;
            color: #aab; white-space: nowrap;
        }
        .nav-tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-tab.active { color: #fff; border-bottom-color: #ff8800; font-weight: 600; }

        .main-content { padding: 20px; max-width: 1200px; margin: 0 auto; }

        h1 { text-align: center; margin: 20px 0 5px; font-size: 1.8em; color: #1a1a2e; }
        .subtitle { text-align: center; color: #666; margin-bottom: 25px; font-size: 0.95em; }

        /* ── Search bar ── */
        .search-bar {
            max-width: 500px; margin: 0 auto 20px; position: relative;
        }
        .search-bar input {
            width: 100%; padding: 10px 16px 10px 40px; border: 2px solid #ddd;
            border-radius: 8px; font-size: 0.95em; direction: rtl;
            transition: border-color 0.2s;
        }
        .search-bar input:focus { outline: none; border-color: #2a5a8a; }
        .search-icon {
            position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
            color: #999; font-size: 1.1em;
        }

        .method-box {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            padding: 20px; margin: 0 auto 25px; max-width: 900px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .method-box h3 { color: #2a5a8a; margin-bottom: 10px; }
        .method-box ul { list-style: none; padding: 0; }
        .method-box li { padding: 4px 0; color: #555; }
        .method-box li strong { color: #222; }
        .weight {
            display: inline-block; background: #e8f0f8; padding: 2px 8px;
            border-radius: 4px; font-size: 0.85em; color: #2a5a8a; margin-left: 8px;
        }

        table { width: 100%; max-width: 1100px; margin: 0 auto 40px; border-collapse: collapse; }
        th {
            background: #2a5a8a; color: #fff; padding: 12px 8px;
            text-align: center; font-weight: 600; border-bottom: 2px solid #1a4a7a; font-size: 0.85em;
            cursor: pointer; user-select: none; position: relative;
        }
        th:hover { background: #345f8a; }
        th .sort-arrow { margin-right: 4px; font-size: 0.7em; opacity: 0.5; }
        th.sorted .sort-arrow { opacity: 1; }
        td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #e0e0e0; }
        .city-row { cursor: pointer; transition: background 0.15s; background: #fff; }
        .city-row:hover { background: #e8f0f8; }
        .city-row.active { background: #dde8f4; }
        .city { text-align: right; font-weight: 600; color: #1a1a2e; }
        .rank { font-size: 1.2em; color: #2a5a8a; }
        .score { font-size: 1.1em; }
        .dim { color: #999; font-size: 0.85em; }
        .partial td { color: #888; }
        .partial td::after { content: ''; }
        .partial .city::after { content: ' (חלקי)'; font-size: 0.75em; color: #aaa; font-weight: normal; }

        .legend { display: flex; justify-content: center; gap: 20px; margin: 10px 0 25px; font-size: 0.85em; }
        .legend span { display: flex; align-items: center; gap: 5px; }
        .dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }

        /* ── Drill-down panel ── */
        .detail-row { display: none; }
        .detail-row.visible { display: table-row; }
        .detail-cell {
            background: #f0f2f5; padding: 20px; text-align: right; border-bottom: 2px solid #ddd;
        }
        .detail-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1000px;
        }
        .detail-section {
            background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        .detail-section h4 { color: #2a5a8a; margin-bottom: 10px; font-size: 0.95em; }
        .kw-list { list-style: none; padding: 0; }
        .kw-list li {
            display: inline-block; background: #e8f0f8; padding: 3px 10px;
            border-radius: 12px; margin: 3px; font-size: 0.8em; color: #333;
        }
        .kw-list li .count { color: #2a5a8a; margin-right: 4px; font-weight: 600; }

        /* ── Program cards ── */
        .program-list { list-style: none; padding: 0; }
        .program-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 6px;
            padding: 10px 14px; margin: 6px 0; cursor: pointer; transition: border-color 0.15s;
        }
        .program-card:hover { border-color: #2a5a8a; }
        .program-card.expanded { border-color: #ff8800; }
        .prog-header { display: flex; justify-content: space-between; align-items: center; }
        .prog-name { font-weight: 600; font-size: 0.9em; }
        .prog-rating {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.8em; font-weight: 700;
        }
        .r5 { background: #ff4444; color: #fff; }
        .r4 { background: #ff8800; color: #fff; }
        .r3 { background: #ffcc00; color: #000; }
        .r2 { background: #88aa44; color: #fff; }
        .r1 { background: #aaa; color: #fff; }
        .prog-meta { color: #777; font-size: 0.8em; margin-top: 4px; }
        .research-badge {
            display: inline-block; background: #2a5a8a; color: #fff; padding: 1px 6px;
            border-radius: 3px; font-size: 0.7em; vertical-align: middle; margin-right: 4px;
        }
        .cluster-badge {
            display: inline-block; background: #8b0000; color: #fff; padding: 2px 8px;
            border-radius: 3px; font-size: 0.7em; vertical-align: middle; margin-right: 4px;
        }
        .research-comment {
            background: #f0f5fa; border-right: 3px solid #2a5a8a; padding: 8px 12px;
            margin-bottom: 8px; border-radius: 0 4px 4px 0;
        }
        .prog-detail {
            display: none; margin-top: 10px; padding-top: 10px;
            border-top: 1px solid #e0e0e0; font-size: 0.85em; color: #444; line-height: 1.6;
        }
        .prog-detail.visible { display: block; }

        /* ── Research panel inside program detail ── */
        .research-panel {
            background: #fff5f5; border: 1px solid #e8aaaa; border-radius: 6px;
            padding: 12px; margin-top: 10px;
        }
        .research-panel h5 {
            color: #8b0000; margin-bottom: 8px; font-size: 0.95em;
            display: flex; align-items: center; gap: 6px;
        }
        .research-panel .risk-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.75em; font-weight: 700; color: #fff;
        }
        .risk-high { background: #cc0000; }
        .risk-medium-high { background: #ff6600; }
        .risk-medium { background: #dd9900; }
        .risk-low { background: #66aa44; }
        .finding-list { list-style: none; padding: 0; margin: 8px 0; }
        .finding-list li {
            padding: 4px 0; font-size: 0.85em; color: #444;
            border-bottom: 1px solid #f0e0e0;
        }
        .finding-list li:before { content: ''; color: #cc0000; margin-left: 6px; }
        .report-link {
            display: inline-block; margin-top: 8px; padding: 4px 12px;
            background: #8b0000; color: #fff; border-radius: 4px;
            text-decoration: none; font-size: 0.8em;
        }
        .report-link:hover { background: #a00; }

        /* ── Organization profile cards ── */
        .org-profiles-section {
            grid-column: 1 / -1;
        }
        .org-profiles-section h4 { color: #2a5a8a; margin-bottom: 10px; font-size: 0.95em; }
        .org-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 6px;
            padding: 12px 14px; margin: 8px 0;
            border-right: 4px solid #cc8800;
        }
        .org-card.risk-high { border-right-color: #cc0000; }
        .org-card.risk-medium-high { border-right-color: #ff6600; }
        .org-card.risk-medium { border-right-color: #dd9900; }
        .org-card.risk-low { border-right-color: #66aa44; }
        .org-card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 6px;
        }
        .org-card-name { font-weight: 700; font-size: 0.95em; color: #1a1a2e; }
        .org-card-reg { font-size: 0.75em; color: #999; }
        .org-card-thesis {
            font-size: 0.85em; color: #444; line-height: 1.5;
            margin-bottom: 8px; padding: 6px 10px;
            background: #faf8f0; border-radius: 4px;
        }
        .org-card-stats {
            display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 8px;
            font-size: 0.8em; color: #555;
        }
        .org-stat { display: flex; align-items: center; gap: 4px; }
        .org-stat strong { color: #222; }
        .org-findings { list-style: none; padding: 0; margin: 0; }
        .org-findings li {
            padding: 2px 0; font-size: 0.8em; color: #555;
            border-bottom: 1px solid #f5f5f5;
        }
        .org-findings li:before { content: '\25C6'; color: #cc8800; margin-left: 6px; font-size: 0.7em; }
        .org-risk-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.75em; font-weight: 700; color: #fff;
        }
        .org-card.expanded .org-expand-hint { display: none; }
        .org-source-link {
            display: inline-block; padding: 3px 10px; background: #e8f0f8;
            border: 1px solid #c0d0e8; border-radius: 4px; font-size: 0.75em;
            color: #2a5a8a; text-decoration: none; white-space: nowrap;
        }
        .org-source-link:hover { background: #d0e0f0; border-color: #2a5a8a; }
        .org-report-link {
            display: inline-block; padding: 4px 12px; background: #8b0000;
            color: #fff; border-radius: 4px; text-decoration: none;
            font-size: 0.8em; font-weight: 600;
        }
        .org-report-link:hover { background: #a00; }

        /* ── Pole bars ── */
        .pole-bar-container { margin: 8px 0; }
        .pole-bar-label { font-size: 0.8em; color: #777; margin-bottom: 3px; }
        .pole-bar-bg {
            background: #e8e8e8; border-radius: 4px; height: 18px; position: relative; overflow: hidden;
        }
        .pole-bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; min-width: 2px; }
        .pole-bar-value {
            position: absolute; left: 8px; top: 0; line-height: 18px;
            font-size: 0.75em; color: #fff; font-weight: 600;
        }

        /* ── Research clusters section ── */
        .clusters-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px; max-width: 1100px; margin: 20px auto;
        }
        .cluster-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border-right: 4px solid #cc0000;
        }
        .cluster-card h4 { color: #1a1a2e; margin-bottom: 8px; }
        .cluster-orgs { color: #666; font-size: 0.8em; margin-bottom: 8px; }
        .cluster-summary { font-size: 0.85em; color: #444; line-height: 1.5; margin-bottom: 10px; }
        .cluster-findings { list-style: none; padding: 0; }
        .cluster-findings li {
            padding: 3px 0; font-size: 0.8em; color: #555;
            border-bottom: 1px solid #f0f0f0;
        }
        .cluster-findings li:before { content: ''; color: #cc0000; margin-left: 4px; }

        .links { text-align: center; margin: 30px 0; }
        .links a { color: #2a5a8a; text-decoration: none; margin: 0 15px; font-weight: 500; }
        .links a:hover { text-decoration: underline; }

        /* ── Hero section ── */
        .hero {
            background: linear-gradient(135deg, #1a1a2e 0%, #2a3a5e 100%);
            color: #fff; border-radius: 12px; padding: 28px 30px 24px;
            margin: 0 auto 24px; max-width: 900px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        .hero-headline {
            font-size: 1.15em; line-height: 1.6; margin-bottom: 18px; color: #e8eaf0;
        }
        .hero-headline strong { color: #ff8800; }
        .hero-stats {
            display: flex; gap: 16px; flex-wrap: wrap; justify-content: center;
        }
        .hero-stat {
            background: rgba(255,255,255,0.1); border-radius: 8px;
            padding: 10px 18px; text-align: center; min-width: 100px;
            border: 1px solid rgba(255,255,255,0.15);
        }
        .hero-stat .val { font-size: 1.6em; font-weight: 800; color: #ff8800; }
        .hero-stat .lbl { font-size: 0.75em; color: #aab8d0; margin-top: 2px; }

        /* ── Collapsible method-box ── */
        .method-toggle {
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; user-select: none;
        }
        .method-toggle .arrow { transition: transform 0.2s; font-size: 0.8em; color: #888; }
        .method-toggle.open .arrow { transform: rotate(180deg); }
        .method-body { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .method-body.open { max-height: 400px; }

        /* ── About section ── */
        .about-section {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            padding: 20px 24px; margin: 30px auto 0; max-width: 900px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }
        .about-section h3 { color: #2a5a8a; margin-bottom: 10px; font-size: 1em; }
        .about-section p { font-size: 0.85em; color: #555; line-height: 1.6; margin-bottom: 8px; }
        .about-section .data-sources {
            display: flex; gap: 16px; flex-wrap: wrap; margin-top: 10px;
        }
        .about-section .source-tag {
            background: #e8f0f8; padding: 4px 12px; border-radius: 4px;
            font-size: 0.8em; color: #2a5a8a; text-decoration: none;
        }
        .about-section a.source-tag:hover {
            background: #d0e0f0; text-decoration: underline;
        }

        footer {
            text-align: center; color: #999; font-size: 0.8em;
            margin-top: 20px; padding: 20px 0; border-top: 1px solid #ddd;
        }

        /* ── Sections (tabs) ── */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ── Stats bar ── */
        .stats-bar {
            display: flex; justify-content: center; gap: 30px; margin: 15px 0 20px;
            flex-wrap: wrap;
        }
        .stat-item {
            text-align: center; padding: 10px 20px;
            background: #fff; border-radius: 8px; border: 1px solid #ddd;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            min-width: 120px;
        }
        .stat-value { font-size: 1.5em; font-weight: 700; color: #2a5a8a; }
        .stat-label { font-size: 0.75em; color: #888; margin-top: 2px; }

        .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }

        /* ── Protocol browser ── */
        .proto-browser-header {
            max-width: 1000px; margin: 30px auto 10px;
            border-top: 2px solid #ddd; padding-top: 20px;
        }
        .proto-browser-header h2 {
            color: #1a1a2e; font-size: 1.15em; margin-bottom: 6px;
        }
        .proto-filter-bar {
            display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
            max-width: 1000px; margin: 10px auto 16px;
        }
        .proto-filter-bar select {
            padding: 8px 12px; border: 2px solid #ddd; border-radius: 8px;
            font-size: 0.9em; direction: rtl; background: #fff;
        }
        .proto-filter-bar select:focus { outline: none; border-color: #2a5a8a; }
        .proto-filter-bar .proto-count { color: #888; font-size: 0.85em; }

        .proto-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 14px 18px; margin: 8px auto; max-width: 1000px;
            cursor: pointer; transition: border-color 0.15s;
        }
        .proto-card:hover { border-color: #2a5a8a; }
        .proto-card.expanded { border-color: #ff8800; }
        .proto-card-header {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 6px;
        }
        .proto-card-title { font-weight: 600; font-size: 0.9em; color: #1a1a2e; }
        .proto-card-meta { font-size: 0.8em; color: #888; }
        .proto-card-badges { display: flex; gap: 6px; align-items: center; }
        .proto-hit-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.75em; font-weight: 700; color: #fff;
        }
        .proto-hit-high { background: #cc0000; }
        .proto-hit-medium { background: #ff8800; }
        .proto-hit-low { background: #88aa44; }
        .proto-hit-none { background: #ccc; }
        .proto-card-text {
            display: none; margin-top: 12px; padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            font-size: 0.85em; color: #333; line-height: 1.8;
            max-height: 500px; overflow-y: auto;
            white-space: pre-wrap; direction: rtl;
        }
        .proto-card-text.visible { display: block; }
        .proto-card-text mark.pole-b {
            background: #fff3cd; padding: 1px 3px; border-radius: 2px;
        }
        .proto-card-text mark.red-flag {
            background: #ffcccc; padding: 1px 3px; border-radius: 2px;
            font-weight: 600;
        }
        .proto-kw-summary {
            display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;
        }
        .proto-kw-pill {
            display: inline-block; background: #e8f0f8; padding: 2px 8px;
            border-radius: 10px; font-size: 0.75em; color: #333;
        }
        .proto-kw-pill.red { background: #ffe0e0; color: #8b0000; }
        .proto-view-link {
            display: inline-block; margin-top: 6px; padding: 4px 12px;
            background: #2a5a8a; color: #fff; border-radius: 4px;
            text-decoration: none; font-size: 0.8em; cursor: pointer;
        }
        .proto-view-link:hover { background: #345f8a; }

        /* ── Protocol Findings (context-analyzed) ── */
        .findings-section {
            max-width: 1000px; margin: 0 auto 30px;
        }
        .findings-header {
            background: linear-gradient(135deg, #1a1a2e 0%, #2a3a5e 100%);
            color: #fff; padding: 20px 24px; border-radius: 10px 10px 0 0;
        }
        .findings-header h2 { margin: 0 0 8px; font-size: 1.2em; }
        .findings-header p { margin: 0; font-size: 0.88em; opacity: 0.85; }
        .findings-stats {
            display: flex; gap: 20px; margin-top: 12px; flex-wrap: wrap;
        }
        .findings-stat {
            background: rgba(255,255,255,0.12); padding: 6px 14px;
            border-radius: 6px; font-size: 0.85em;
        }
        .findings-stat strong { color: #ff8800; }
        .findings-filter-bar {
            background: #f0f2f5; padding: 10px 20px;
            border: 1px solid #ddd; border-top: none;
            display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
        }
        .findings-filter-bar select {
            padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px;
            font-size: 0.85em; direction: rtl;
        }
        .findings-filter-bar .filter-label {
            font-size: 0.85em; color: #666;
        }
        .findings-list {
            border: 1px solid #ddd; border-top: none;
            border-radius: 0 0 10px 10px; overflow: hidden;
        }
        .finding-card {
            background: #fff; border-bottom: 1px solid #eee;
            padding: 16px 20px; transition: background 0.15s;
        }
        .finding-card:last-child { border-bottom: none; }
        .finding-card:hover { background: #fafafa; }
        .finding-top {
            display: flex; justify-content: space-between; align-items: flex-start;
            flex-wrap: wrap; gap: 8px; margin-bottom: 8px;
        }
        .finding-city {
            font-weight: 700; color: #1a1a2e; font-size: 0.95em;
        }
        .finding-badges { display: flex; gap: 6px; flex-wrap: wrap; }
        .finding-badge {
            display: inline-block; padding: 2px 10px; border-radius: 4px;
            font-size: 0.75em; font-weight: 600;
        }
        .badge-approved { background: #d4edda; color: #155724; }
        .badge-rejected { background: #f8d7da; color: #721c24; }
        .badge-declaration { background: #d1ecf1; color: #0c5460; }
        .badge-proposal { background: #fff3cd; color: #856404; }
        .badge-policy { background: #e2d5f1; color: #432874; }
        .badge-signed { background: #d4edda; color: #155724; }
        .badge-established { background: #d1ecf1; color: #0c5460; }
        .badge-appointed { background: #e2e3e5; color: #383d41; }
        .badge-agenda { background: #e2e3e5; color: #383d41; }
        .badge-active { background: #d1ecf1; color: #0c5460; }
        .badge-confirmed { background: #d4edda; color: #155724; }
        .badge-removed { background: #f8d7da; color: #721c24; }
        .badge-cat {
            background: #e8f0f8; color: #2a5a8a;
        }
        .finding-summary {
            font-size: 0.9em; color: #333; line-height: 1.6; margin-bottom: 10px;
        }
        .finding-quote {
            background: #fffbf0; border-right: 4px solid #ff8800;
            padding: 12px 16px; margin: 10px 0;
            border-radius: 0 6px 6px 0;
            font-size: 0.88em; color: #444; line-height: 1.8;
            direction: rtl; cursor: pointer;
            max-height: 80px; overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .finding-quote.expanded {
            max-height: 2000px;
        }
        .finding-quote::after {
            content: '...לחצו להרחבה';
            display: block; text-align: center;
            font-size: 0.8em; color: #888; margin-top: 4px;
        }
        .finding-quote.expanded::after {
            content: '';
        }
        .finding-meta {
            font-size: 0.8em; color: #888; display: flex; gap: 12px; flex-wrap: wrap;
        }
        .finding-meta a { color: #2a5a8a; text-decoration: none; }
        .finding-meta a:hover { text-decoration: underline; }

        @media (max-width: 768px) {
            .main-content { padding: 10px; }
            th, td { padding: 8px 4px; font-size: 0.8em; }
            h1 { font-size: 1.3em; }
            .detail-grid { grid-template-columns: 1fr; }
            .nav-inner { flex-direction: column; padding: 8px; }
            .nav-tabs { flex-wrap: wrap; justify-content: center; }
            .nav-tab { padding: 8px 12px; font-size: 0.8em; min-height: 40px; display: flex; align-items: center; }
            .clusters-grid { grid-template-columns: 1fr; }
            .hero { padding: 20px 16px; }
            .hero-headline { font-size: 1em; }
            .hero-stat { min-width: 70px; padding: 8px 10px; }
            .hero-stat .val { font-size: 1.2em; }
            .about-section { padding: 14px 16px; }
            .stats-bar { gap: 10px; }
            .stat-item { min-width: 80px; padding: 8px 12px; }
            .stat-value { font-size: 1.2em; }
            /* Hide low-priority columns on tablet */
            th:nth-child(5), td:nth-child(5),
            th:nth-child(8), td:nth-child(8),
            th:nth-child(9), td:nth-child(9) { display: none; }
            .detail-cell { padding: 12px; }
            .detail-section { padding: 10px; }
            .report-link { padding: 10px 16px; }
            .links a { display: inline-block; padding: 10px 14px; }
            .prog-header { flex-wrap: wrap; gap: 4px; }
            .prog-name { word-break: break-word; }
        }

        @media (max-width: 480px) {
            .nav-tab { padding: 6px 8px; font-size: 0.75em; }
            .nav-title { font-size: 0.9em; }
            th, td { padding: 6px 3px; font-size: 0.75em; }
            /* Also hide red_flag column on small phones */
            th:nth-child(7), td:nth-child(7) { display: none; }
        }

        /* ── Research Background tab ── */
        .bg-hero {
            background: linear-gradient(135deg, #2c1810 0%, #4a2520 40%, #1a1a2e 100%);
            color: #fff; border-radius: 12px; padding: 32px 30px;
            margin: 0 auto 28px; max-width: 900px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        .bg-hero h2 { font-size: 1.5em; margin-bottom: 10px; color: #fff; }
        .bg-hero p { color: #d0c8c0; font-size: 1em; line-height: 1.7; }
        .bg-hero strong { color: #ff8800; }

        .bg-section {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            padding: 24px; margin: 0 auto 20px; max-width: 900px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .bg-section h3 {
            color: #1a1a2e; font-size: 1.1em; margin-bottom: 14px;
            padding-bottom: 8px; border-bottom: 2px solid #ff8800;
        }
        .bg-section h4 { color: #2a5a8a; font-size: 0.95em; margin: 14px 0 8px; }

        .bg-unknown {
            display: flex; align-items: flex-start; gap: 12px;
            padding: 10px 14px; margin: 8px 0; background: #faf5f0;
            border-radius: 6px; border-right: 3px solid #cc8800;
        }
        .bg-unknown-icon { font-size: 1.2em; flex-shrink: 0; margin-top: 2px; }
        .bg-unknown-text { font-size: 0.9em; color: #444; line-height: 1.6; }
        .bg-unknown-text strong { color: #222; }

        .bg-quote {
            background: #f8f0e8; border-right: 4px solid #8b0000;
            padding: 16px 20px; margin: 14px 0; border-radius: 0 8px 8px 0;
        }
        .bg-quote p {
            font-size: 0.95em; color: #333; line-height: 1.7; margin-bottom: 6px;
            font-style: italic;
        }
        .bg-quote .bg-quote-src {
            font-size: 0.8em; color: #888; font-style: normal;
        }
        .bg-quote .bg-quote-src a { color: #2a5a8a; text-decoration: none; }
        .bg-quote .bg-quote-src a:hover { text-decoration: underline; }

        .bg-evidence {
            background: #fff5f5; border: 1px solid #e8cccc; border-radius: 8px;
            padding: 16px 20px; margin: 12px 0;
        }
        .bg-evidence h4 { color: #8b0000; margin: 0 0 8px; font-size: 0.95em; }
        .bg-evidence p { font-size: 0.88em; color: #444; line-height: 1.6; }

        .bg-compare {
            display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px;
            align-items: center; margin: 16px 0;
        }
        .bg-compare-box {
            background: #f5f5f8; border-radius: 8px; padding: 16px;
            text-align: center; border: 1px solid #ddd;
        }
        .bg-compare-box.bad { background: #fff5f0; border-color: #e8cccc; }
        .bg-compare-box.good { background: #f0f8f0; border-color: #cce8cc; }
        .bg-compare-arrow { font-size: 1.5em; color: #888; }
        .bg-compare-box h5 { margin-bottom: 6px; font-size: 0.9em; }
        .bg-compare-box p { font-size: 0.8em; color: #555; }

        .bg-links {
            display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px;
        }
        .bg-link {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 8px 16px; border-radius: 6px;
            font-size: 0.85em; font-weight: 600; text-decoration: none;
            transition: filter 0.2s;
        }
        .bg-link:hover { filter: brightness(1.15); }
        .bg-link.rosetta { background: #8b0000; color: #fff; }
        .bg-link.sel { background: #2a5a8a; color: #fff; }
        .bg-link.shefi { background: #6b2fa0; color: #fff; }
        .bg-link.gnost { background: #1a1a2e; color: #fff; }

        .bg-bottom-line {
            background: linear-gradient(135deg, #1a1a2e 0%, #2a3a5e 100%);
            color: #fff; border-radius: 8px; padding: 20px 24px;
            margin: 20px auto 0; max-width: 900px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .bg-bottom-line h3 { color: #ff8800; margin-bottom: 8px; }
        .bg-bottom-line p { color: #d0d8e8; font-size: 0.9em; line-height: 1.7; }

        @media (max-width: 768px) {
            .bg-compare { grid-template-columns: 1fr; }
            .bg-compare-arrow { transform: rotate(90deg); text-align: center; }
            .bg-hero { padding: 20px 16px; }
            .bg-section { padding: 16px; }
        }

        /* ── Concept badges & evidence modal ── */
        .concept-badge {
            display: inline-block; padding: 1px 7px; border-radius: 3px;
            font-size: 0.72em; font-weight: 600; cursor: pointer;
            margin-right: 4px; border: 1px solid transparent;
            transition: filter 0.15s, transform 0.1s;
            color: #fff; vertical-align: middle;
        }
        .concept-badge:hover { filter: brightness(1.2); transform: scale(1.05); }

        .concept-evidence-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.55);
            z-index: 2000; display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.15s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .concept-evidence-panel {
            background: #fff; border-radius: 12px; max-width: 700px; width: 92%;
            max-height: 85vh; overflow-y: auto; padding: 28px 32px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.25); direction: rtl;
            position: relative;
        }
        .concept-evidence-panel h3 {
            margin: 0 0 16px; font-size: 1.2em; color: #1a1a2e;
            padding-left: 40px;
        }
        .concept-evidence-close {
            position: absolute; top: 12px; left: 16px; background: none;
            border: none; font-size: 1.6em; cursor: pointer; color: #888;
            line-height: 1; padding: 4px 8px; border-radius: 4px;
        }
        .concept-evidence-close:hover { background: #f0f0f0; color: #333; }

        .concept-dual-meaning {
            display: grid; grid-template-columns: 1fr 1fr; gap: 14px;
            margin-bottom: 18px;
        }
        .meaning-surface {
            background: #f0f8f0; border: 1px solid #c8e6c9; border-radius: 8px;
            padding: 14px;
        }
        .meaning-hidden {
            background: #fff5f0; border: 1px solid #ffccbc; border-radius: 8px;
            padding: 14px;
        }
        .meaning-surface h5, .meaning-hidden h5 {
            font-size: 0.8em; margin: 0 0 6px; text-transform: uppercase;
        }
        .meaning-surface h5 { color: #2e7d32; }
        .meaning-hidden h5 { color: #c62828; }
        .meaning-surface p, .meaning-hidden p { font-size: 0.88em; color: #444; margin: 0; line-height: 1.6; }

        .concept-evidence-quote {
            background: #f8f0e8; border-right: 4px solid #8b0000;
            padding: 12px 16px; margin: 10px 0; border-radius: 0 8px 8px 0;
        }
        .concept-evidence-quote p { font-size: 0.88em; color: #333; line-height: 1.6; font-style: italic; margin: 0 0 4px; }
        .concept-evidence-quote .quote-src { font-size: 0.78em; color: #888; font-style: normal; }
        .concept-evidence-quote .quote-src a { color: #2a5a8a; text-decoration: none; }
        .concept-evidence-quote .quote-src a:hover { text-decoration: underline; }

        .concept-evidence-links {
            display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px;
            padding-top: 14px; border-top: 1px solid #eee;
        }
        .concept-evidence-links a {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 6px 14px; border-radius: 6px; font-size: 0.82em;
            font-weight: 600; text-decoration: none; transition: filter 0.2s;
        }
        .concept-evidence-links a:hover { filter: brightness(1.15); }
        .concept-evidence-links .link-rosetta { background: #8b0000; color: #fff; }
        .concept-evidence-links .link-research { background: #2a5a8a; color: #fff; }

        .clearance-section {
            background: #f5f5f8; border: 1px solid #ddd; border-radius: 8px;
            margin-top: 10px; overflow: hidden;
        }
        .clearance-toggle {
            padding: 8px 14px; cursor: pointer; font-size: 0.82em;
            font-weight: 600; color: #555; display: flex;
            align-items: center; gap: 6px;
        }
        .clearance-toggle:hover { background: #eee; }
        .clearance-toggle .arrow { transition: transform 0.2s; font-size: 0.8em; }
        .clearance-section.open .clearance-toggle .arrow { transform: rotate(90deg); }
        .clearance-body {
            display: none; padding: 0 14px 12px; font-size: 0.82em; color: #555;
        }
        .clearance-section.open .clearance-body { display: block; }
        .clearance-body ul { margin: 6px 0; padding-right: 18px; }
        .clearance-body li { padding: 2px 0; }

        /* ── Suspicion dossier sections ── */
        .dossier-section {
            background: #fff8f0; border: 1px solid #eed; border-radius: 8px;
            padding: 12px 16px; margin: 8px 0;
        }
        .dossier-section h5 {
            margin: 0 0 8px; font-size: 0.88em; color: #8b0000;
            display: flex; align-items: center; gap: 6px;
        }
        .dossier-section p, .dossier-section li {
            font-size: 0.84em; color: #444; line-height: 1.6;
        }
        .dossier-section ul { margin: 4px 0; padding-right: 18px; }
        .dossier-section a { color: #2a5a8a; text-decoration: none; }
        .dossier-section a:hover { text-decoration: underline; }

        .dossier-nif {
            background: #f5eef8; border-color: #d5c0e8;
        }
        .dossier-nif h5 { color: #6a1b9a; }

        .dossier-missing {
            background: #f0f0f5; border-color: #ccc;
        }
        .dossier-missing h5 { color: #555; }

        .dossier-terms {
            display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;
        }
        .dossier-term-link {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 4px 10px; border-radius: 4px; font-size: 0.8em;
            font-weight: 600; color: #fff; text-decoration: none;
            transition: filter 0.15s;
        }
        .dossier-term-link:hover { filter: brightness(1.2); color: #fff; }

        .dossier-deep-links {
            display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;
            padding-top: 8px; border-top: 1px solid #e0d0c0;
        }
        .dossier-deep-links a {
            padding: 5px 12px; border-radius: 5px; font-size: 0.78em;
            font-weight: 600; text-decoration: none; color: #fff;
        }
        .dossier-deep-links a:hover { filter: brightness(1.15); color: #fff; }

        @media (max-width: 600px) {
            .concept-dual-meaning { grid-template-columns: 1fr; }
            .concept-evidence-panel { padding: 20px 16px; }
        }

        /* ── Depth Chain — "Go Deeper" sections ── */
        .depth-section {
            margin-top: 16px; padding-top: 12px; border-top: 2px solid #cc0000;
        }
        .depth-section h5 {
            color: #8b0000; font-size: 0.95em; margin-bottom: 12px;
            display: flex; align-items: center; gap: 6px;
        }
        .depth-level {
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            margin: 8px 0; overflow: hidden; transition: border-color 0.2s;
        }
        .depth-level:hover { border-color: #888; }
        .depth-level.open { border-color: #cc0000; }
        .depth-header {
            padding: 12px 16px; cursor: pointer; display: flex;
            align-items: center; gap: 10px; user-select: none;
        }
        .depth-header:hover { background: #fafafa; }
        .depth-icon { font-size: 1.3em; flex-shrink: 0; }
        .depth-header-text { flex: 1; }
        .depth-title { font-weight: 700; font-size: 0.92em; color: #222; }
        .depth-subtitle { font-size: 0.8em; color: #777; margin-top: 2px; }
        .depth-arrow {
            font-size: 0.8em; color: #999; transition: transform 0.2s; flex-shrink: 0;
        }
        .depth-level.open .depth-arrow { transform: rotate(180deg); }
        .depth-body {
            display: none; padding: 0 16px 14px; font-size: 0.88em;
            line-height: 1.7; color: #333;
        }
        .depth-level.open .depth-body { display: block; }
        .depth-summary { margin-bottom: 10px; }
        .depth-quote {
            background: #fff5f0; border-right: 3px solid #cc0000; padding: 8px 14px;
            margin: 8px 0; border-radius: 0 4px 4px 0; font-style: italic;
            font-size: 0.95em; color: #444; direction: rtl;
        }
        .depth-next-prompt {
            text-align: center; padding: 8px; font-size: 0.82em; color: #888;
            font-style: italic; border-top: 1px dashed #ddd; margin-top: 4px;
        }
        .depth-related {
            margin-top: 14px; padding-top: 12px; border-top: 1px solid #eee;
        }
        .depth-related h6 { color: #555; font-size: 0.88em; margin-bottom: 8px; }
        .depth-link {
            display: flex; align-items: flex-start; gap: 8px; padding: 8px 12px;
            background: #f8f8fa; border-radius: 6px; margin: 6px 0;
            text-decoration: none; color: #222; transition: background 0.15s;
            border: 1px solid #e8e8ee;
        }
        .depth-link:hover { background: #eef0f5; border-color: #ccc; color: #222; }
        .depth-link-icon { font-size: 1.1em; flex-shrink: 0; margin-top: 2px; }
        .depth-link-text { flex: 1; }
        .depth-link-title { font-weight: 600; font-size: 0.88em; color: #2a5a8a; }
        .depth-link-desc { font-size: 0.78em; color: #666; margin-top: 2px; }

        .prog-close-btn {
            float: left; cursor: pointer; font-size: 1.2em; color: #999;
            padding: 0 4px; line-height: 1;
        }
        .prog-close-btn:hover { color: #333; }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-inner">
            <span class="nav-title">דירוג ערים</span>
            <div class="nav-tabs">
                <div class="nav-tab" onclick="switchTab('background',this)">רקע מחקרי</div>
                <div class="nav-tab active" onclick="switchTab('ranking',this)">דירוג ראיות</div>
                <div class="nav-tab" onclick="switchTab('education',this)">תוכניות חינוך</div>
                <div class="nav-tab" onclick="switchTab('protocols',this)">פרוטוקולים</div>
                <div class="nav-tab" onclick="switchTab('redflags',this)">דגלים אדומים</div>
                <div class="nav-tab" onclick="switchTab('research',this)">מחקר מעמיק</div>
            </div>
        </div>
    </nav>

    <div class="main-content">

    <!-- ═══ TAB: RESEARCH BACKGROUND ═══ -->
    <div id="tab-background" class="tab-content">

        <div class="bg-hero">
            <h2>למה קשה לדעת מה באמת קורה בבתי הספר</h2>
            <p>
                מטרת המחקר הזה היא לדרג ערים לפי מידת החדירה האידיאולוגית-פרוגרסיבית למערכת החינוך העירונית.
                חלק מהותי מהמשימה הוא להבין <strong>מה נלמד בפועל בכיתות</strong>.
                בעמוד הזה נסביר למה זה קשה — ונציג ראיות שהקושי הזה <strong>אינו מקרי</strong>.
            </p>
        </div>

        <!-- Section 1: What we don't know -->
        <div class="bg-section">
            <h3>מה אנחנו לא יודעים</h3>
            <p style="font-size:0.9em;color:#555;margin-bottom:14px;">
                נתוני מאגר גפ"ן של משרד החינוך מכסים כשנתיים בלבד, ומספקים מידע ברזולוציה נמוכה מאוד.
                אנחנו יודעים ששולמו כספים. אנחנו לא יודעים מה קרה בכיתה.
            </p>

            <div class="bg-unknown">
                <span class="bg-unknown-icon">&#x2753;</span>
                <div class="bg-unknown-text">
                    <strong>שעות חשיפה של תלמידים</strong> — תוכנית יכולה להיות סדנה חד-פעמית של שעתיים,
                    או מפגש שבועי לאורך כל השנה. אין לנו מידע על היקף החשיפה בפועל.
                </div>
            </div>

            <div class="bg-unknown">
                <span class="bg-unknown-icon">&#x2753;</span>
                <div class="bg-unknown-text">
                    <strong>שעות הכשרת מורים</strong> — חלק מהתוכניות כוללות הכשרות למורים שמשפיעות
                    על כל שיעור שהמורה מעביר. אין לנו מידע על היקף ההכשרות.
                </div>
            </div>

            <div class="bg-unknown">
                <span class="bg-unknown-icon">&#x2753;</span>
                <div class="bg-unknown-text">
                    <strong>הנחיות יישום מערכתיות</strong> — האם ההנחיה היא "ליישם את העקרונות בכל שיעור"?
                    "לשלב SEL בכל השיעורים"? הנחיות כאלה הופכות שעה אחת של הכשרה למאות שעות של חשיפה.
                    <strong>אין לנו גישה להנחיות אלה.</strong>
                </div>
            </div>

            <div class="bg-unknown">
                <span class="bg-unknown-icon">&#x2753;</span>
                <div class="bg-unknown-text">
                    <strong>תוכן בפועל</strong> — תוכניות כמו SafeSchool (2.4 מיליון &#x20AA;, 838 בתי ספר)
                    פועלות מאחורי חומת תשלום. הורים מדווחים שילדים חוזרים הביתה ומדברים על "ספקטרום מגדרי" —
                    אבל לא ניתן לאמת מבחוץ מה בדיוק מוצג לתלמידים.
                </div>
            </div>

            <div class="bg-unknown">
                <span class="bg-unknown-icon">&#x2753;</span>
                <div class="bg-unknown-text">
                    <strong>תיאורים מטושטשים בכוונה</strong> — שמות תוכניות כמו "כישורי חיים",
                    "אקלים מיטבי" או "אזרחות פעילה" לא מגלים כמעט שום דבר על התוכן בפועל.
                    זה כמו לנסות להבין מה בתפריט של מסעדה לפי הכותרת "אוכל טוב".
                </div>
            </div>

            <h4>השוו בעצמכם</h4>
            <div class="bg-compare">
                <div class="bg-compare-box good">
                    <h5>ספר לימוד</h5>
                    <p>כל הורה יכול לקנות, לקרוא, ולדעת בדיוק מה הילד לומד בכיתה. תוכן גלוי ושקוף.</p>
                </div>
                <div class="bg-compare-arrow">&#x2B05;</div>
                <div class="bg-compare-box bad">
                    <h5>תוכנית חיצונית</h5>
                    <p>מנחה חיצוני נכנס לכיתה. תוכן מאחורי חומת תשלום. שם מטושטש.
                    ההורים מקבלים הודעה בדיעבד — אם בכלל.</p>
                </div>
            </div>
        </div>

        <!-- Section 2: By design -->
        <div class="bg-section">
            <h3>ראיות שהאטימות היא בכוונה</h3>
            <p style="font-size:0.9em;color:#555;margin-bottom:14px;">
                הקושי לדעת מה קורה בכיתות לא נובע רק ממגבלות טכניות.
                אנשים בעלי השפעה במערכת החינוך מביעים עמדות מפורשות נגד שקיפות — ובעד ניצול האטימות.
            </p>

            <div class="bg-quote">
                <p>
                    &#x201F;כל פעם שדברים על ביג דאטה, קופצת לי הטראומה של פרסום נתוני המיצ"ב...
                    ואנחנו צריכים להיות מאוד מאוד זהירים באיזה מידע אנחנו אוספים ואיזה מידע אנחנו לא אוספים&#x201E;
                </p>
                <div class="bg-quote-src">
                    — <strong>ד"ר ניר מיכאלי</strong>, ערוץ משרד החינוך, דקה 02:25
                    (<a href="https://www.youtube.com/watch?v=WUhBXXgCVsQ&t=145" target="_blank" rel="noopener">YouTube</a>)
                </div>
            </div>

            <div class="bg-quote">
                <p>
                    &#x201F;אני הרבה פעמים הייתה לי תחושה כמורה שאני יכול לארגן הפיכה קומוניסטית בכיתה
                    ואף אחד לא בכלל לא ירגיש וזה לא יזיז לאף אחד והם אפילו לא ידעו בדיוק להגיד בבית
                    על מה בדיוק דיברנו בכיתה&#x201E;
                </p>
                <div class="bg-quote-src">
                    — <strong>ד"ר ניר מיכאלי</strong>, הרצאה בקדמה, דקה 55:00
                    (<a href="https://www.youtube.com/watch?v=lTtg0gbU-ZU&t=3300" target="_blank" rel="noopener">YouTube</a>)
                </div>
            </div>

            <div class="bg-evidence">
                <h4>מי זה ניר מיכאלי?</h4>
                <p>
                    לא פרשן שולי — מחבר משותף של דו"ח <strong>המדענית הראשית של משרד החינוך</strong> (2024)
                    בנושא "חינוך פוליטי בעת משבר לאומי", יחד עם ד"ר קרן קטקו-איילי.
                    אותו דו"ח ממומן על ידי לשכת המדענית הראשית
                    ומציע מודל שהמחברים עצמם כינו במאמר אקדמי קודם (2020)
                    <strong>"פדגוגיה אקטיביסטית"</strong> — כלומר הכשרת מורים כסוכני שינוי חברתי.
                </p>
            </div>
        </div>

        <!-- Section 3: The language game -->
        <div class="bg-section">
            <h3>משחק השפה — אותו תוכן, אריזה אחרת</h3>

            <p style="font-size:0.9em;color:#555;margin-bottom:14px;">
                ד"ר קרן קטקו-איילי פרסמה <strong>את אותו מודל פדגוגי</strong> בשני מסמכים:
            </p>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
                <div style="background:#fff5f0;border:1px solid #e8cccc;border-radius:8px;padding:14px;">
                    <div style="font-size:0.75em;color:#8b0000;font-weight:700;margin-bottom:4px;">2020 — מאמר אקדמי באנגלית</div>
                    <p style="font-size:0.85em;color:#444;">
                        "Activist Pedagogy" — שפה אקטיביסטית גלויה.
                        מורים כ"סוכני שינוי חברתי". מבוסס על פאולו פריירה (פדגוגיה ביקורתית = מרקסיזם).
                        פורסם בכתב עת ברומניה.
                    </p>
                </div>
                <div style="background:#f0f5ff;border:1px solid #ccd8e8;border-radius:8px;padding:14px;">
                    <div style="font-size:0.75em;color:#2a5a8a;font-weight:700;margin-bottom:4px;">2024 — דו"ח למשרד החינוך</div>
                    <p style="font-size:0.85em;color:#444;">
                        "חינוך פוליטי בעת משבר לאומי" — שפה מרוככת ומוסדית.
                        ממוסגר כ"מענה למשבר 7 באוקטובר". המודל זהה, האריזה הפוכה.
                        ממומן על ידי המדענית הראשית.
                    </p>
                </div>
            </div>

            <div class="bg-evidence">
                <h4>המעבר מחינוך ציוני ל"אזרחות פעילה"</h4>
                <p>
                    המשרד עצמו עובר מדגש על חינוך ציוני לעבר "אזרחות פעילה" (Active Citizenship).
                    קטקו-איילי מסבירה במאמר 2020 מה המונח הזה באמת אומר:
                    <strong>Activist Pedagogy — פדגוגיה אקטיביסטית</strong>, שהיא Critical Pedagogy —
                    פדגוגיה ביקורתית, שמשמעותה פרוגרסיביזם רדיקלי.
                    היא מצטטת את פאולו פריירה, הרברט מרקוזה והנרי ג'ירו.
                    היא מקדמת הכשרת מורים ברדיקליזם, ובמקביל מזדהה עם מורים המסתירים מה הם באמת עושים בכיתה.
                    התוכן מפורט ב<a href="https://aosshalem-dev.github.io/progressive-rosetta-stone/" target="_blank" rel="noopener" style="color:#8b0000;font-weight:600;">אבן רוזטה הפרוגרסיבית</a>.
                </p>
            </div>
        </div>

        <!-- Section 4: NIF funding -->
        <div class="bg-section">
            <h3>הקרן החדשה לישראל (NIF) — ממימון מניפולציה לתוכניות בבתי ספר</h3>

            <p style="font-size:0.9em;color:#555;margin-bottom:14px;">
                הקרן החדשה לישראל מממנת ארגונים שמפעילים תוכניות חינוכיות בבתי ספר.
                באותו זמן, היא מממנת ארגונים שמלמדים <strong>טכניקות מניפולציה מפורשות</strong>.
            </p>

            <div class="bg-quote">
                <p>
                    &#x201F;קודם כל להבין איך הבן אדם האחר חושב על הסוגיה, ואז מתוך ההסתכלות שלו,
                    לנסח לו את הבעיה באופן ש<strong>התשובה האפשרית היחידה</strong> לשאלה שאני שואל אותו,
                    היא לעשות את הדבר שאני רוצה שהוא יעשה.
                    [...] הדבר היחיד שמעניין זה מה הם עושים&#x201E;
                </p>
                <div class="bg-quote-src">
                    — <strong>חגי אלקיים</strong>, סדנת "הנדסת תודעה" של ארגון מחזקים (ממומן ע"י הקרן החדשה)
                    (<a href="https://www.gnostocracy.com/?quote=534" target="_blank" rel="noopener">מקור + וידאו</a>)
                </div>
            </div>

            <div class="bg-evidence">
                <h4>הקשר לחינוך</h4>
                <p>
                    אותה קרן חדשה שמממנת סדנאות "הנדסת תודעה" מממנת גם ארגונים שמפעילים
                    תוכניות חינוך בבתי ספר:
                </p>
                <ul style="list-style:none;padding:0;margin:10px 0 0;">
                    <li style="padding:4px 0;font-size:0.88em;color:#444;">
                        <strong style="color:#8b0000;">דרור ישראל</strong> — 16 תוכניות, דירוג 5, ~690,000 &#x20AA;,
                        חשיפת תלמידים ל"שינוי חברתי", תלונות הורים על גיוס כיתתי
                    </li>
                    <li style="padding:4px 0;font-size:0.88em;color:#444;">
                        <strong style="color:#8b0000;">רשת מרכזי הסיוע (ARCCI)</strong> — 5 תוכניות, דירוג 4-5, ~419,000 &#x20AA;,
                        מזדהה כ"סוכנות לשינוי חברתי", לובי 50+ חוקים
                    </li>
                    <li style="padding:4px 0;font-size:0.88em;color:#444;">
                        <strong style="color:#8b0000;">מצמיחים</strong> — דירוג 5, ~1,823,000 &#x20AA;, 348 בתי ספר,
                        "מדינת כל אזרחיה" במסגור של מניעת אלימות
                    </li>
                </ul>
                <p style="margin-top:10px;font-size:0.88em;color:#444;">
                    <strong>זו הסיבה שקשר לקרן החדשה מוריד דירוג.</strong>
                    לא אשמה בזיקה — אלא שהמממן מלמד את הרשת שלו טכניקות מניפולציה,
                    ואותה רשת מפעילה תוכניות בבתי ספר.
                </p>
            </div>
        </div>

        <!-- Section 5: The Israeli Pipeline -->
        <div class="bg-section">
            <h3>הצינור הישראלי — איך אידיאולוגיה גלובלית מגיעה לכיתה</h3>
            <p style="font-size:0.9em;color:#555;margin-bottom:14px;">
                זה לא מקרי. יש צינור מתועד שמתחיל באמנות בינלאומיות ומסתיים בכיתת בית הספר של הילד שלכם.
            </p>

            <div style="background:#f5f5f8;border-radius:8px;padding:20px;margin:16px 0;font-family:monospace;font-size:0.82em;line-height:2;direction:ltr;text-align:center;">
                <div style="direction:rtl;text-align:center;">
                    <strong style="color:#8b0000;">UNESCO</strong> (מדיניות גלובלית + מימון)<br>
                    <span style="color:#888;">&#x2193; מצטט את מרקוזה במפורש (2022)</span><br>
                    <strong style="color:#8b0000;">כסא UNESCO — מכללת קיבוצים</strong> (פרופ' נמרוד אלוני)<br>
                    <span style="color:#888;">&#x2193; אותו מוסד מארח:</span><br>
                    <strong style="color:#8b0000;">המרכז לפדגוגיה ביקורתית</strong> (גלית זלמנסון)<br>
                    <span style="color:#888;">&#x2193; מכשיר מורים ישראלים. "מרקס" לא מופיע באתר</span><br>
                    <span style="color:#888;">&#x2193; אבל האקדמיה הלאומית מבהירה: "פדגוגיה ביקורתית = מרקסיזם"</span><br>
                    <strong>מכון מופ"ת</strong> (הכשרת מורים)<br>
                    <span style="color:#888;">&#x2193; 75% מהמחקרים: דיווח עצמי. 66%: ע"י מעצבי התוכנית</span><br>
                    <strong>SEL.IL — אוניברסיטת רייכמן</strong><br>
                    <span style="color:#888;">&#x2193; תוכנית א.י.ל לגנים</span><br>
                    <strong>שפ"י</strong> (שירות פסיכולוגי-ייעוצי, משרד החינוך)<br>
                    <span style="color:#888;">&#x2193; הזרוע המבצעית של המשרד</span><br>
                    <strong>אבני ראשה</strong> (מנהיגות בית ספרית)<br>
                    <span style="color:#888;">&#x2193; 10 מדדים ליישום SEL מערכתי</span><br>
                    <strong>יוזמה / האקדמיה הלאומית</strong><br>
                    <span style="color:#888;">&#x2193; המלצות למשרד — ה"הצדקה המדעית"</span><br>
                    <strong style="color:#b71c1c;">&#x2192; הכיתה של הילד שלכם</strong>
                </div>
            </div>

            <div class="bg-evidence">
                <h4>ממנים את הצינור</h4>
                <p>
                    <strong>יד הנדיב</strong> (קרן רוטשילד) מופיעה ב"פרויקט ריבונות בחינוך" כמממנת חדירת SEL.
                    <strong>תכנית חותם</strong> (משרד החינוך) השמיעה 1,400 אקדמאים בבתי ספר מאז 2010 — הצינור הישיר ביותר מאקדמיה לכיתה.
                    <strong>קרן מנדל</strong> מכשירה מנהיגות חינוכית — בוגריה מאיישים עמדות מפתח בארגוני חינוך.
                </p>
            </div>
        </div>

        <!-- Section 6: Yozma contradictions -->
        <div class="bg-section">
            <h3>המסמך שסותר את עצמו — המלצות יוזמה (האקדמיה הלאומית)</h3>
            <p style="font-size:0.9em;color:#555;margin-bottom:14px;">
                המלצות יוזמה (2020) הן ההצדקה ה"מדעית" ליישום SEL בישראל.
                אבל קריאה צמודה חושפת סתירות עצמיות מפתיעות:
            </p>

            <div class="bg-quote">
                <p>
                    &#x201F;אין נתונים אמפיריים ישירים המקשרים בין התנהגויות ספציפיות... לתוצאות&#x201E;
                </p>
                <div class="bg-quote-src">
                    — <strong>יוזמה / האקדמיה הלאומית למדעים</strong> — מודים שאין בסיס ראייתי
                </div>
            </div>

            <p style="font-size:0.9em;color:#555;margin:12px 0;">
                ובמקביל ממליצים על:
            </p>

            <div class="bg-quote">
                <p>
                    &#x201F;לא רפורמה אלא שינוי עמוק, רחב ויסודי של שינוי תרבותי וארגוני ואימוץ דרך חיים&#x201E;
                    שחייב &#x201F;לחצות את כל ההיררכיה של המערכת&#x201E;
                </p>
                <div class="bg-quote-src">
                    — <strong>יוזמה</strong> — ממליצים על שינוי מערכתי מוחלט ללא בסיס ראייתי
                </div>
            </div>

            <p style="font-size:0.9em;color:#555;margin:12px 0;">
                ואיך מתמודדים עם הורים שיתנגדו?
            </p>

            <div class="bg-quote">
                <p>
                    &#x201F;הבנה מצד ההורים תוביל להפחתת התנגדויות&#x201E;
                </p>
                <div class="bg-quote-src">
                    — <strong>יוזמה</strong> — אסטרטגיית שיווק מפורשת: הציגו SEL כמיומנות ניטרלית כדי למנוע התנגדות
                </div>
            </div>

            <div class="bg-evidence">
                <h4>לסיכום: שלוש טענות במסמך אחד</h4>
                <p>
                    1. <strong>אין ראיות</strong> שזה עובד<br>
                    2. <strong>צריך לשנות הכל</strong> — "לחצות את כל ההיררכיה"<br>
                    3. <strong>צריך למנוע התנגדות</strong> — לשווק להורים כמיומנות ניטרלית<br><br>
                    זה לא מדע. זה אסטרטגיית הטמעה.
                </p>
            </div>
        </div>

        <!-- Section 7: Why -->
        <div class="bg-section">
            <h3>למה לשמור על אטימות?</h3>
            <p style="font-size:0.95em;color:#333;line-height:1.7;">
                פשוט — <strong>כי רוב ההורים לא היו מסכימים.</strong>
            </p>
            <p style="font-size:0.9em;color:#555;line-height:1.7;margin-top:8px;">
                מורה שמארגן "הפיכה קומוניסטית" בכיתה לא עושה את זה בגלוי —
                כי הוא יודע שהורים היו מתנגדים.
                ארגון שמלמד "הנדסת תודעה" לא מפרסם את זה בעלון לבית —
                כי הוא יודע שההורים לא היו שולחים את הילדים.
                תוכנית שמלמדת "ספקטרום מגדרי" שמה את התוכן מאחורי חומת תשלום —
                כי בגלוי זה לא היה עובר.
            </p>
            <p style="font-size:0.9em;color:#555;line-height:1.7;margin-top:8px;">
                יש כוחות חזקים שרוצים שהורים ידעו כמה שפחות.
                זה לא תיאוריית קונספירציה — זה ציטוטים ישירים של אנשים מרכזיים במערכת, עם מקורות.
            </p>
        </div>

        <!-- Section 6: Despite all this -->
        <div class="bg-bottom-line">
            <h3>בכל זאת — מאמץ מיטבי</h3>
            <p>
                בתנאים האלה, אנחנו עדיין מנסים למפות היכן עיריות דוחפות תוכן פרוגרסיבי.
                אנחנו משתמשים ב<strong>מחקר עומק</strong> על תוכניות ספציפיות (181 ביקורות אנושיות, 46 דוחות מחקר מעמיק),
                <strong>מיפוי ארגוני</strong> של 38 ארגונים נחקרים (כולל 7 ארגוני צינור מוסדי), <strong>ניתוח פרוטוקולים</strong> של מועצות עיר,
                <strong>נתוני תקציב</strong> מגפ"ן, ו<strong>ניתוח מקורות ראשוניים</strong> (מרקוזה, פריירה, ג'ירו, UNESCO, יוזמה — במילים שלהם).
                התמונה חלקית — אבל מה שאנחנו רואים מספיק כדי לזהות מגמות.
            </p>
        </div>

        <!-- Deep dive links -->
        <div class="bg-section" style="text-align:center;">
            <h3>מחקרי עומק נוספים</h3>
            <p style="font-size:0.9em;color:#555;margin-bottom:16px;">
                כל אחד מהאתרים הבאים מרחיב על היבט ספציפי של התמונה:
            </p>
            <div class="bg-links" style="justify-content:center;">
                <a class="bg-link rosetta" href="https://aosshalem-dev.github.io/progressive-rosetta-stone/" target="_blank" rel="noopener">
                    &#x1F5FF; אבן רוזטה הפרוגרסיבית
                </a>
                <a class="bg-link sel" href="https://aosshalem-dev.github.io/sel-research/" target="_blank" rel="noopener">
                    &#x1F9E0; SEL — למידה רגשית-חברתית
                </a>
                <a class="bg-link shefi" href="https://aosshalem-dev.github.io/shefi-research/" target="_blank" rel="noopener">
                    &#x26A0; שפ"י — מגדר וזהות מינית
                </a>
                <a class="bg-link gnost" href="https://www.gnostocracy.com/?quote=534" target="_blank" rel="noopener">
                    &#x1F3AC; הנדסת תודעה — וידאו
                </a>
            </div>
        </div>

    </div>

    <!-- ═══ TAB: RANKING (default) ═══ -->
    <div id="tab-ranking" class="tab-content active">
        <h1>דירוג ערים — ציון ראיות</h1>
        <p class="subtitle">כל נקודה בציון עוקבת לראיה ספציפית | לחצו על עיר לפרטים</p>

        <!-- Hero summary -->
        <div class="hero" id="hero-section">
            <div class="hero-headline">
                ניתוח חוצה מקורות של <strong>חדירה אידיאולוגית</strong> למערכת החינוך העירונית.
                שילוב נתוני תוכניות גפ"ן, פרוטוקולי מועצות עיר, ומחקר מעמיק על <strong>7 אשכולות ארגוניים</strong> חשודים.
            </div>
            <div class="hero-stats" id="hero-stats"></div>
        </div>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="חפש עיר..." oninput="filterTable()">
            <span class="search-icon">&#128269;</span>
        </div>

        <div class="method-box">
            <div class="method-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
                <h3>שיטת החישוב</h3>
                <span class="arrow">&#9660;</span>
            </div>
            <div class="method-body">
                <ul style="margin-top:10px">
                    <li><strong>ציון ראיות</strong> = כל נקודה עוקבת לראיה ספציפית וניתנת לאימות:</li>
                    <li>• תוכניות מוכחות כבעייתיות (דירוג אנושי + ארגונים בסיכון גבוה) <span class="weight">50%</span></li>
                    <li>• החלטות מועצה מאומתות (23 ממצאים מ-537 פרוטוקולים) <span class="weight">35%</span></li>
                    <li>• פעולות עירוניות מתועדות בחדשות (עירייה+פועל בלבד) <span class="weight">15%</span></li>
                    <li class="dim" style="margin-top:8px">ציון מילות מפתח ישן מוצג להשוואה בלבד — לא נכלל בדירוג</li>
                    <li class="dim">181 סקירות אנושיות, 12 חקירות מעמיקות, מיפוי ארגונים, ניתוח פרוטוקולים</li>
                </ul>
                <div style="margin-top:10px;font-size:0.82em;color:#666">
                    מקורות:
                    <a href="https://apps.education.gov.il/gefen" target="_blank" style="color:#2a5a8a">גפ"ן — משרד החינוך</a> |
                    פרוטוקולי מועצות עיר (537 נסרקו, 23 ממצאים) |
                    <a href="https://news.google.com/?hl=iw&gl=IL" target="_blank" style="color:#2a5a8a">Google News</a> |
                    <a href="research/" target="_blank" style="color:#2a5a8a">דוחות מחקר ארגונים</a>
                </div>
            </div>
        </div>


        <div class="legend">
            <span><span class="dot" style="background:#ff4444"></span> 50+ קריטי</span>
            <span><span class="dot" style="background:#ff8800"></span> 30-49 גבוה</span>
            <span><span class="dot" style="background:#cc9900"></span> 15-29 בינוני</span>
            <span><span class="dot" style="background:#44cc44"></span> &lt;15 נמוך</span>
        </div>

        <div class="table-wrapper">
        <table id="main-table">
            <thead>
                <tr>
                    <th data-col="rank" data-type="num"># <span class="sort-arrow">&#9660;</span></th>
                    <th data-col="city" data-type="str">עיר <span class="sort-arrow">&#9660;</span></th>
                    <th data-col="evidence_score" data-type="num">ציון ראיות <span class="sort-arrow">&#9660;</span></th>
                    <th data-col="proven_programs_count" data-type="num">תוכניות מוכחות <span class="sort-arrow">&#9660;</span></th>
                    <th data-col="verified_decisions" data-type="num">החלטות מאומתות <span class="sort-arrow">&#9660;</span></th>
                    <th data-col="strong_news_actions" data-type="num">פעולות בחדשות <span class="sort-arrow">&#9660;</span></th>
                    <th data-col="high_risk_orgs" data-type="num">ארגונים בסיכון <span class="sort-arrow">&#9660;</span></th>
                    <th data-col="keyword_proxy" data-type="num" style="color:#888" title="ציון מילות מפתח — לא נכלל בדירוג, מוצג להשוואה בלבד">מילות מפתח* <span class="sort-arrow">&#9660;</span></th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
        </div>
    </div>

    <!-- ═══ TAB: EDUCATION ═══ -->
    <div id="tab-education" class="tab-content">
        <h1>תוכניות חינוך — ניתוח גפ"ן</h1>
        <p class="subtitle">תוכניות חינוך מסומנות ב-20 ערים | מיון לפי רמת חשיפה חינוכית</p>

        <div class="stats-bar" id="edu-stats"></div>

        <div class="search-bar">
            <input type="text" id="edu-search" placeholder="חפש תוכנית או ארגון..." oninput="filterEducation()">
            <span class="search-icon">&#128269;</span>
        </div>

        <div id="edu-programs-list"></div>
    </div>

    <!-- ═══ TAB: PROTOCOLS ═══ -->
    <div id="tab-protocols" class="tab-content">
        <h1>פרוטוקולים עירוניים</h1>
        <p class="subtitle">ניתוח מבוסס הקשר של פרוטוקולי מועצות עיר | 15 ערים | 8,063 פרוטוקולים</p>

        <!-- ═══ FINDINGS SECTION (context-analyzed) ═══ -->
        <div class="findings-section">
            <div class="findings-header">
                <h2>החלטות מועצה שזוהו — ניתוח מבוסס הקשר</h2>
                <p>537 פרוטוקולים שסומנו על ידי סריקת מילות מפתח נבדקו אחד-אחד בניתוח הקשרי מלא. רק החלטות מועצה ממשיות בנושאי פוליטיקת זהות מגדרית זוהו כממצאים — לא אזכורי מילות מפתח.</p>
                <div class="findings-stats">
                    <div class="findings-stat">נסרקו: <strong>537</strong> פרוטוקולים</div>
                    <div class="findings-stat">ממצאים: <strong>23</strong> החלטות</div>
                    <div class="findings-stat">שיעור דיוק: <strong>4%</strong></div>
                    <div class="findings-stat">ערים עם ממצאים: <strong>5</strong> מתוך 15</div>
                </div>
            </div>
            <div class="findings-filter-bar">
                <span class="filter-label">סינון:</span>
                <select id="findings-city-filter" onchange="renderFindings()">
                    <option value="all">כל הערים</option>
                </select>
                <select id="findings-outcome-filter" onchange="renderFindings()">
                    <option value="all">כל הסטטוסים</option>
                    <option value="approved">אושר</option>
                    <option value="rejected">נדחה</option>
                    <option value="declaration">הצהרה</option>
                    <option value="proposal">הצעה</option>
                    <option value="policy">מדיניות</option>
                </select>
                <span class="filter-label" id="findings-count"></span>
            </div>
            <div class="findings-list" id="findings-list"></div>
        </div>

        <div class="stats-bar" id="proto-stats"></div>

        <div id="proto-details-list"></div>

        <!-- Protocol Browser (legacy keyword view) -->
        <div class="proto-browser-header">
            <h2>רשימת פרוטוקולים — טקסט מלא עם הדגשת מילות מפתח (מתודולוגיה ישנה)</h2>
            <p class="subtitle" style="text-align:right">53 פרוטוקולים שנבחרו מ-5 ערים עם האותות החזקים ביותר | לחצו לפתיחת הטקסט</p>
            <p style="font-size:0.82em;color:#bf360c;text-align:right;max-width:1000px;margin:4px auto 0">
                &#9888; שימו לב: ההדגשה מבוססת על ספירה מכנית ללא ניתוח הקשר. חלק מהמילים המודגשות הן חיוביים כוזבים (&#171;קיימות&#187; = existing, שמות פרטיים כ&#171;שולי&#187;). ראו
                <span style="cursor:pointer;color:#2a5a8a;text-decoration:underline" onclick="switchTab('ranking',document.querySelectorAll('.nav-tab')[1])">כתמים עיוורים</span>
                לפירוט.
            </p>
        </div>
        <div class="proto-filter-bar">
            <select id="proto-city-filter" onchange="renderProtocolBrowser()">
                <option value="all">כל הערים</option>
            </select>
            <span class="proto-count" id="proto-browser-count"></span>
        </div>
        <div id="proto-browser-list"></div>
    </div>

    <!-- ═══ TAB: RED FLAGS ═══ -->
    <div id="tab-redflags" class="tab-content">
        <h1>דגלים אדומים — אותות לכידה מוסדית</h1>
        <p class="subtitle">זיהוי אינדיקטורים מוסדיים בפרוטוקולי מועצות עיר המצביעים על חדירה אידיאולוגית חיצונית</p>

        <!-- Intro explainer -->
        <div class="method-box" style="max-width:900px;margin:20px auto">
            <div class="method-toggle" onclick="this.classList.toggle('open');this.nextElementSibling.classList.toggle('open')">
                <h3>מה הם דגלים אדומים ולמה הם חשובים?</h3>
                <span class="arrow">&#9660;</span>
            </div>
            <div class="method-body open" style="max-height:800px">
                <div style="margin-top:12px;line-height:1.8;color:#444;font-size:0.9em">
                    <p style="margin-bottom:10px">
                        <strong>דגלים אדומים</strong> הם אינדיקטורים שזוהו בפרוטוקולי מועצות עיר, המצביעים על דפוסים של
                        <strong>לכידה מוסדית</strong> (institutional capture) — מצב שבו גורמים חיצוניים מצליחים להשפיע על
                        מדיניות עירונית דרך מנגנונים שאינם שקופים לציבור.
                    </p>
                    <p style="margin-bottom:10px">
                        ניתוח הפרוטוקולים מזהה שלוש קטגוריות עיקריות של דגלים, המבוססות על
                        <a href="https://newdiscourses.com/translations/social-justice-encyclopedia/" target="_blank" style="color:#2a5a8a">מסגרת הניתוח של New Discourses</a>
                        ועל מחקר על
                        <a href="https://www.ngo-monitor.org/reports/breaking-the-impasse/" target="_blank" style="color:#2a5a8a">מימון זר בחינוך הישראלי (NGO Monitor)</a>:
                    </p>
                </div>
            </div>
        </div>

        <!-- Category cards -->
        <div style="max-width:900px;margin:0 auto 20px">
            <div class="detail-section" style="margin-bottom:16px;border-right:4px solid #cc0000;background:#fff5f5">
                <h4 style="color:#cc0000">1. שיתוף פעולה עם UNESCO / רשתות בינלאומיות</h4>
                <div style="font-size:0.88em;color:#444;line-height:1.7;margin:8px 0">
                    <p><strong>מילות מפתח:</strong> "רשת ערים", "פיתוח בר-קיימא"</p>
                    <p style="margin-top:6px"><strong>למה זה דגל אדום?</strong></p>
                    <ul style="list-style:disc;padding-right:20px;margin:6px 0">
                        <li><strong>SDGs כמנוף אידיאולוגי</strong> — יעדי הפיתוח בר-קיימא (SDGs) של האו"ם משמשים כמסגרת "ניטרלית" להכנסת תכנים בנושאי מגדר, צדק חברתי ואקלים לתוכניות לימוד עירוניות.</li>
                        <li><strong>חד-כיווניות</strong> — רשתות ערים בינלאומיות (כמו UNESCO Global Network of Learning Cities) מחילות תקנים ערכיים אחידים שעלולים להתנגש עם ערכי הקהילה המקומית.</li>
                        <li><strong>מנגנון עוקף דמוקרטיה</strong> — החלטות שמתקבלות ברמה בינלאומית "יורדות" לעיריות ללא שיח ציבורי מקומי.</li>
                    </ul>
                    <p style="margin-top:6px;font-size:0.85em;color:#666">
                        <strong>מקורות:</strong>
                        <a href="https://uil.unesco.org/lifelong-learning/learning-cities" target="_blank" style="color:#2a5a8a">UNESCO Learning Cities</a> |
                        <a href="https://sdgs.un.org/goals" target="_blank" style="color:#2a5a8a">UN SDGs</a> |
                        <a href="https://www.ngo-monitor.org/key-issues/united-nations/un-human-rights-council/" target="_blank" style="color:#2a5a8a">NGO Monitor: UN frameworks</a>
                    </p>
                </div>
            </div>

            <div class="detail-section" style="margin-bottom:16px;border-right:4px solid #ff6600;background:#fff8f0">
                <h4 style="color:#ff6600">2. יועצים חיצוניים ומתווכי ידע</h4>
                <div style="font-size:0.88em;color:#444;line-height:1.7;margin:8px 0">
                    <p><strong>מילות מפתח:</strong> "יועץ חיצוני"</p>
                    <p style="margin-top:6px"><strong>למה זה דגל אדום?</strong></p>
                    <ul style="list-style:disc;padding-right:20px;margin:6px 0">
                        <li><strong>צינור השפעה</strong> — יועצים חיצוניים מקצועיים יכולים לשמש כ"מתווכי ידע" (knowledge brokers) המכניסים שפה ומסגרות אידיאולוגיות לתוך שיח עירוני, תחת מעטה מקצועי.</li>
                        <li><strong>חוסר שקיפות</strong> — פרוטוקולים לעיתים אינם מפרטים את הגורם השולח, שיוכו הארגוני, או מקור המימון של היועץ.</li>
                        <li><strong>דפוס חוזר</strong> — ארגונים כמו דרור ישראל, מכון הרטמן ואחרים שולחים "מומחים" לרשויות מקומיות — מה שנראה כשירות מקצועי אך למעשה הוא ערוץ לקידום אג'נדה.</li>
                    </ul>
                    <p style="margin-top:6px;font-size:0.85em;color:#666">
                        <strong>מקורות:</strong>
                        ראו דוחות מחקר מעמיק בטאב "מחקר מעמיק" — במיוחד:
                        <span style="background:#e8f0f8;padding:2px 6px;border-radius:3px;cursor:pointer" onclick="switchTab('research',document.querySelector('[data-tab=research]')||document.querySelectorAll('.nav-tab')[5])">רשת דרור ישראל</span>,
                        <span style="background:#e8f0f8;padding:2px 6px;border-radius:3px;cursor:pointer" onclick="switchTab('research',document.querySelector('[data-tab=research]')||document.querySelectorAll('.nav-tab')[5])">רשת מכון הרטמן</span>
                    </p>
                </div>
            </div>

            <div class="detail-section" style="margin-bottom:16px;border-right:4px solid #8b0000;background:#faf0f0">
                <h4 style="color:#8b0000">3. רציונל מחקרי — מדוע דגלים אלה חשובים?</h4>
                <div style="font-size:0.88em;color:#444;line-height:1.7;margin:8px 0">
                    <p>המסגרת הקונספטואלית מבוססת על שלושה מקורות מחקריים:</p>
                    <ul style="list-style:disc;padding-right:20px;margin:8px 0">
                        <li><strong>James Lindsay (New Discourses)</strong> — תיעוד שיטתי של חדירת "צדק חברתי" (Critical Social Justice) למוסדות דרך שפה מקצועית ניטרלית. הגדרת "institutional capture" כתהליך שבו אידיאולוגיה מחליפה מומחיות.</li>
                        <li><strong>NGO Monitor</strong> — מחקר על מימון זר בחינוך הישראלי: NIF, Ford Foundation, EU ועוד — מיפוי של ערוצי השפעה דרך עמותות → יועצים → רשויות מקומיות.</li>
                        <li><strong>Christopher Rufo</strong> — תיאור מנגנוני DEI/ESG כערוצי החדרה אידיאולוגית למוסדות ציבוריים, כולל מערכות חינוך עירוניות.</li>
                    </ul>
                    <p style="margin-top:8px"><strong>השיטה:</strong> סריקה אוטומטית של מילות מפתח בפרוטוקולי מועצות עיר, נורמליזציה לפי אורך הטקסט (לכל 10,000 תווים), ומיון ערים לפי צפיפות אינדיקטורים. הציון משתתף ב-<strong>20%</strong> מהציון המשולב.</p>
                    <p style="margin-top:6px;color:#bf360c;font-size:0.88em">
                        <strong>&#9888; מגבלות ידועות:</strong> לסורק כתמים עיוורים — חיוביים כוזבים ממילים דו-משמעיות (&#171;קיימות&#187;, &#171;שולי&#187;), שמות פרטיים הנספרים כתוכן, ודגלים על תוכניות לגיטימיות (&#171;רשת ערים בריאות&#187;).
                        <span style="cursor:pointer;color:#2a5a8a;text-decoration:underline" onclick="switchTab('ranking',document.querySelectorAll('.nav-tab')[1])">פירוט מלא בטאב הדירוג &#8592;</span>
                    </p>
                    <p style="font-size:0.85em;color:#666;margin-top:6px">
                        <strong>מקורות נוספים:</strong>
                        <a href="data/research_lens.html" target="_blank" style="color:#2a5a8a">מסגרת המחקר</a> |
                        <a href="data/methodology.html" target="_blank" style="color:#2a5a8a">חישובים סטטיסטיים</a> |
                        <a href="docs/METHODOLOGY.md" download style="color:#2a5a8a">מתודולוגיה מלאה</a>
                    </p>
                </div>
            </div>
        </div>

        <h2 style="text-align:center;color:#1a1a2e;margin:30px 0 15px;font-size:1.2em">ממצאים לפי עיר</h2>
        <p class="subtitle">ערים ממוינות לפי צפיפות דגלים אדומים בפרוטוקולים</p>
        <div id="redflags-list"></div>
    </div>

    <!-- ═══ TAB: RESEARCH ═══ -->
    <div id="tab-research" class="tab-content">
        <h1>מחקר מעמיק — ניתוח ארגונים חשודים</h1>
        <p class="subtitle">מחקר בסגנון 9 פרקים (עדשה אידיאולוגית-ערכית) | 7 אשכולות ארגוניים</p>

        <div class="clusters-grid" id="clusters-grid"></div>

        <div class="method-box" style="margin-top:30px; border-right: 4px solid #8b0000;">
            <h3 style="color:#8b0000;">הקשר גלובלי: ישראל אינה יחידה</h3>
            <p style="margin-bottom:12px;">
                הדפוסים שמתועדים באתר זה — חדירת ארגונים אידיאולוגיים למערכת החינוך דרך תוכניות "למידה חברתית-רגשית" (SEL),
                "הגנת ילדים", ו"חינוך מיני מקיף" (CSE) — <strong>אינם תופעה ישראלית ייחודית</strong>.
                זהו מודל גלובלי הפועל במדינות רבות בו-זמנית:
            </p>
            <ul style="list-style:none;padding:0;">
                <li style="padding:5px 0;"><strong>ארה"ב:</strong> ארגון <a href="https://casel.org" target="_blank" rel="noopener" style="color:#2a5a8a">CASEL</a> הנחה מ-2020 "SEL טרנספורמטיבי" הכולל "פירוק מבנים מדכאים". מדינות פלורידה וטקסס אסרו תכנים אלה מבתי ספר.</li>
                <li style="padding:5px 0;"><strong>בריטניה:</strong> תוכנית RSE חובה מ-2020 עוררה מחאות הורים נרחבות. <a href="https://cass.independent-review.uk/" target="_blank" rel="noopener" style="color:#2a5a8a">דוח קאס (2024)</a> קבע כי אין בסיס מספיק להוראת "זהות מגדרית" בבתי ספר.</li>
                <li style="padding:5px 0;"><strong>אוסטרליה:</strong> תוכנית Safe Schools נסגרה ב-2017 לאחר שנחשף שהכילה תכני מגדר קיצוניים לגילאי בית ספר.</li>
                <li style="padding:5px 0;"><strong>קנדה:</strong> תוכנית הלימודים של אונטריו (2015) עוררה מחאה ציבורית. ממשלת פורד ביטלה חלקים ממנה ב-2018.</li>
                <li style="padding:5px 0;"><strong>UNESCO/IPPF:</strong> <a href="https://www.unfpa.org/publications/international-technical-guidance-sexuality-education" target="_blank" rel="noopener" style="color:#2a5a8a">המדריך הבינלאומי לחינוך מיני</a> של UNESCO (2018) מהווה את הבסיס לתכניות CSE בעשרות מדינות. ארגון <a href="https://www.ippf.org" target="_blank" rel="noopener" style="color:#2a5a8a">IPPF</a> (לונדון) מסמיך את הסניף הישראלי "דלת פתוחה", שבוגריו הקימו את SEI — האגודה שמסמיכה את המחנכים המיניים בגפ"ן.</li>
                <li style="padding:5px 0;border-top:1px solid #eee;margin-top:5px;"><strong>ישראל — מסמכי האקדמיה הלאומית למדעים:</strong>
                    <a href="https://education.academy.ac.il/SystemFiles/23425.pdf" target="_blank" rel="noopener" style="color:#2a5a8a">המלצות SEL (ספטמבר 2020)</a> — המלצה ליישום כלל-מערכתי של "למידה רגשית-חברתית", אך המסמך עצמו מבהיר שביסוד SEL נדרשת הכרעה ערכית בין "ניאו-ליברליזם" ל"דמוקרטיה ביקורתית" — כלומר עדשה מרקסיסטית.
                    <a href="https://education.academy.ac.il/SystemFiles/Values%20-%20Full%20report%202211021.pdf" target="_blank" rel="noopener" style="color:#2a5a8a">חינוך ערכי (אוקטובר 2022)</a> — מסמך המשך המכניס מפורשות את המושג "פדגוגיה ביקורתית", מייחס אותו למרקסיסט פאולו פריירה, ומבהיר שמשמעותו מרקסיזם, ניאו-מרקסיזם ופוסט-קולוניאליזם. <strong>אלה לא טענות של מבקרים — אלה המילים של המקדמים עצמם.</strong>
                </li>
            </ul>
            <p style="margin-top:12px;">
                <strong>המודל המשותף:</strong> ארגון בינלאומי מגדיר סטנדרטים ← סניף מקומי מכשיר מנחים ← המנחים נכנסים לבתי ספר דרך אישור ממשלתי ← ההורים מקבלים הודעה בדיעבד (opt-out).
                בישראל, <strong>שפ"י</strong> (השירות הפסיכולוגי-ייעוצי של משרד החינוך) משמש כשער הכניסה המוסדי לתכניות אלה.
            </p>
            <p style="margin-top:10px;font-size:0.9em;">
                מחקר מפורט:
                <a href="research/Child_protection_with_ideological_overlay.html" target="_blank" style="color:#8b0000;font-weight:bold;">SEL וציפוי אידיאולוגי</a> |
                <a href="research/Gender_sexuality_education_providers.html" target="_blank" style="color:#6b2fa0;font-weight:bold;">רשת חינוך מיני ומגדרי</a> |
                <a href="research/Feminist_gender-agenda_orgs.html" target="_blank" style="color:#6b2fa0;font-weight:bold;">אג'נדה פמיניסטית-מגדרית</a> |
                <a href="research/framework_insights.html" target="_blank" style="color:#1e3a5f;font-weight:bold;">תובנות כלליות</a> |
                <a href="https://ntdtv.co.il/israel/10522" target="_blank" rel="noopener" style="color:#8b0000;font-weight:bold;">אונסק"ו כנחש גנוסטי (NTD)</a> |
                <a href="https://ntdtv.co.il/society/10951" target="_blank" rel="noopener" style="color:#8b0000;font-weight:bold;">ידע גנוסטי — רקע תיאורטי (NTD)</a> |
                <a href="https://gnostocracy.com/" target="_blank" rel="noopener" style="color:#1e3a5f;font-weight:bold;">גנוסטוקרטיה — מאגר ציטוטים</a>
            </p>
        </div>
    </div>

    <div class="links">
        <a href="research/framework_insights.html" target="_blank" style="background:#1e3a5f">&#9733; תובנות כלליות — דפוסים חוצי-ארגונים</a>
        <a href="research/Child_protection_with_ideological_overlay.html" target="_blank" style="background:#8b0000">&#9888; SEL ו&quot;הגנת ילדים&quot; — ציפוי אידיאולוגי</a>
        <a href="research/Gender_sexuality_education_providers.html" target="_blank" style="background:#6b2fa0">&#9888; חינוך מיני ומגדרי — רשת ארגונים</a>
        <a href="research/Feminist_gender-agenda_orgs.html" target="_blank" style="background:#6b2fa0">&#9888; אג'נדה פמיניסטית-מגדרית בחינוך</a>
        <a href="data.js" download="data.js">&#11015; הורד נתונים</a>
        <a href="https://aosshalem-dev.github.io/educational-programs/">&#128202; ניתוח תוכניות חינוך</a>
        <a href="research/" target="_blank">&#128196; דוחות מחקר מלאים</a>
    </div>

    <div class="about-section">
        <h3>אודות הפרויקט</h3>
        <p>
            <strong>פרויקט זהות ציונית — דירוג ערים</strong> הוא כלי מחקר ייעודי לניתוח חדירה אידיאולוגית-ערכית
            למערכת החינוך העירונית בישראל. הפרויקט משלב שלושה מקורות נתונים עצמאיים לבניית תמונה חוצת-מקורות.
        </p>
        <p>
            הדירוג אינו מייצג עמדה פוליטית אלא מבוסס על ניתוח כמותי של תוכניות חינוך, מילות מפתח בפרוטוקולים,
            ומחקר מעמיק על ארגונים הפועלים במערכת. כל ממצא מגובה במקור ציבורי הזמין לבדיקה.
        </p>
        <div class="data-sources">
            <a href="https://apps.education.gov.il/gefen" target="_blank" class="source-tag">מערכת גפ"ן — משרד החינוך</a>
            <a href="https://aosshalem-dev.github.io/educational-programs/" target="_blank" class="source-tag">ניתוח 2,859 תוכניות חינוך</a>
            <a href="https://www.guidestar.org.il" target="_blank" class="source-tag">GuideStar — רשם העמותות</a>
            <a href="https://next.obudget.org" target="_blank" class="source-tag">obudget.org — תקציב פתוח</a>
            <a href="https://votes25.bechirot.gov.il/" target="_blank" class="source-tag">תוצאות בחירות כנסת 25</a>
            <a href="research/" target="_blank" class="source-tag">46 דוחות מחקר מעמיק</a>
            <a href="data/news/" target="_blank" class="source-tag">ארכיון כתבות (5,095 כתבות)</a>
            <a href="data/ranking.html" target="_blank" class="source-tag">נתוני דירוג גולמיים</a>
            <a href="https://www.ngo-monitor.org.il" target="_blank" class="source-tag">NGO Monitor</a>
        </div>
    </div>

    <footer>
        פרויקט זהות ציונית — דירוג ערים | עדכון אחרון: פברואר 2026<br>
        מקורות: פרוטוקולים עירוניים (15 ערים) + תוכניות גפ"ן (20 ערים) + 46 דוחות מחקר מעמיק + בחירות כנסת 25 + 5,095 כתבות מקוטלגות
    </footer>

    </div><!-- .main-content -->

    <script src="data.js?v=10"></script>
    <script src="research_data.js?v=10"></script>
    <script src="protocols_data.js?v=10"></script>
    <script src="protocol_findings.js?v=1"></script>
    <script src="research_orgs.js?v=10"></script>
    <script src="suspicious_concepts.js?v=1"></script>
    <script src="depth_data.js?v=1"></script>
    <script>
    // ── Concept detection & evidence ──
    // Look up program_info entry by name when prog has no .id
    function findProgramInfoByName(progName) {
        if (!progName || !DATA.program_info) return null;
        const prefix = progName.substring(0, Math.min(15, progName.length));
        for (const [id, pi] of Object.entries(DATA.program_info)) {
            if (!pi.name) continue;
            // Match if either name contains the other's prefix
            if (pi.name.includes(prefix)) return { id, ...pi };
            const piPrefix = pi.name.substring(0, Math.min(15, pi.name.length));
            if (progName.includes(piPrefix)) return { id, ...pi };
        }
        return null;
    }

    function detectConcepts(prog, info) {
        if (typeof SUSPICIOUS_CONCEPTS === 'undefined') return [];
        const SC = SUSPICIOUS_CONCEPTS;
        const found = new Set();

        // If prog has no id, try to match via program_info by name
        let progId = prog.id;
        let resolvedInfo = info;
        if (!progId && prog.name) {
            const match = findProgramInfoByName(prog.name);
            if (match) {
                progId = match.id;
                if (!resolvedInfo || !resolvedInfo.research_desc) resolvedInfo = match;
            }
        }

        // Layer 1: Explicit mapping by program ID
        const explicit = SC.program_concepts[progId];
        if (explicit) explicit.forEach(c => found.add(c));

        // Layer 2: Keyword fallback on description + summary + name
        const text = [
            prog.research_desc || '',
            resolvedInfo.research_desc || '',
            resolvedInfo.summary || '',
            prog.name || ''
        ].join(' ');

        if (text) {
            for (const rule of SC.keyword_rules) {
                if (rule.pattern.test(text)) found.add(rule.concept);
            }
        }

        return [...found].map(id => ({ id, ...SC.concepts[id] })).filter(c => c.name_he);
    }

    function showConceptEvidence(conceptId) {
        if (typeof SUSPICIOUS_CONCEPTS === 'undefined') return;
        const c = SUSPICIOUS_CONCEPTS.concepts[conceptId];
        if (!c) return;

        const evidenceHtml = (c.evidence || []).map(e => {
            const linkHtml = e.url
                ? ` <a href="${e.url}" target="_blank" rel="noopener">[מקור]</a>`
                : '';
            return `<div class="concept-evidence-quote">
                <p>${e.text}</p>
                <div class="quote-src">\u2014 <strong>${e.source}</strong>${linkHtml}</div>
            </div>`;
        }).join('');

        const links = [];
        if (c.rosetta_url) links.push(`<a class="link-rosetta" href="${c.rosetta_url}" target="_blank" rel="noopener">\u{1F5FF} אבן רוזטה הפרוגרסיבית</a>`);
        if (c.research_url) links.push(`<a class="link-research" href="${c.research_url}" target="_blank" rel="noopener">\u{1F9E0} מחקר מלא</a>`);
        const linksHtml = links.length ? `<div class="concept-evidence-links">${links.join('')}</div>` : '';

        const overlay = document.createElement('div');
        overlay.className = 'concept-evidence-overlay';
        overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
        overlay.innerHTML = `<div class="concept-evidence-panel">
            <button class="concept-evidence-close" onclick="this.closest('.concept-evidence-overlay').remove()">&times;</button>
            <h3>${c.name_he}</h3>
            <div class="concept-dual-meaning">
                <div class="meaning-surface">
                    <h5>המשמעות הגלויה</h5>
                    <p>${c.surface_meaning}</p>
                </div>
                <div class="meaning-hidden">
                    <h5>המשמעות המתועדת</h5>
                    <p>${c.hidden_meaning}</p>
                </div>
            </div>
            ${evidenceHtml}
            ${linksHtml}
        </div>`;
        document.body.appendChild(overlay);
    }

    function buildClearanceFooter() {
        if (typeof SUSPICIOUS_CONCEPTS === 'undefined') return '';
        const cl = SUSPICIOUS_CONCEPTS.clearance;
        const items = cl.conditions.map(c => `<li>${c}</li>`).join('');
        return `<div class="clearance-section" onclick="this.classList.toggle('open')">
            <div class="clearance-toggle"><span class="arrow">\u25C0</span> ${cl.title}</div>
            <div class="clearance-body">
                <p>${cl.intro}</p>
                <ul>${items}</ul>
                <p style="margin-top:8px;font-style:italic">${cl.footer}</p>
            </div>
        </div>`;
    }

    // Find org profile from RESEARCH_ORGS by name matching
    function findOrgProfile(orgName) {
        if (!orgName || typeof RESEARCH_ORGS === 'undefined') return null;
        for (const [key, o] of Object.entries(RESEARCH_ORGS.orgs || {})) {
            if (orgName.includes(o.name_he) || o.name_he.includes(orgName) ||
                (o.name_en && orgName.toLowerCase().includes(o.name_en.toLowerCase()))) {
                return o;
            }
        }
        // Partial matches
        const shorts = {'מצמיחים':'Matzmichim','דרור':'Yesodot_Dror','הוועד למלחמ':'AIDS_Task_Force',
            'הרטמן':'Hartman','חוש"ן':'CHOSHEN','האגודה לזכויות':'ACRI'};
        for (const [partial, key] of Object.entries(shorts)) {
            if (orgName.includes(partial) && RESEARCH_ORGS.orgs[key]) return RESEARCH_ORGS.orgs[key];
        }
        return null;
    }

    function buildSuspicionDossier(prog, info, concepts) {
        if (!concepts || concepts.length === 0) return '';
        const orgName = info.org || prog.institution || '';
        const orgProfile = findOrgProfile(orgName);
        let parts = [];

        // ── 1. Org problems ──
        if (orgProfile) {
            const riskHe = {'high':'\u05d2\u05d1\u05d5\u05d4','medium-high':'\u05d1\u05d9\u05e0\u05d5\u05e0\u05d9-\u05d2\u05d1\u05d5\u05d4','medium':'\u05d1\u05d9\u05e0\u05d5\u05e0\u05d9','moderate':'\u05de\u05ea\u05d5\u05df','low-moderate':'\u05e0\u05de\u05d5\u05da-\u05de\u05ea\u05d5\u05df','low':'\u05e0\u05de\u05d5\u05da'}[orgProfile.risk] || orgProfile.risk;
            const findings = (orgProfile.key_findings || []).slice(0, 4).map(f => `<li>${f}</li>`).join('');
            const reportLink = orgProfile.report_url
                ? ` <a href="${orgProfile.report_url}" target="_blank" rel="noopener" style="font-weight:600;color:#8b0000">\u{1F4C4} \u05d3\u05d5\u05d7 \u05de\u05d7\u05e7\u05e8 \u05de\u05dc\u05d0</a>`
                : '';
            parts.push(`<div class="dossier-section">
                <h5>\u26A0 \u05d1\u05e2\u05d9\u05d5\u05ea \u05e2\u05dd \u05d4\u05d0\u05e8\u05d2\u05d5\u05df: ${orgProfile.name_he} (\u05e1\u05d9\u05db\u05d5\u05df: ${riskHe})</h5>
                <p>${orgProfile.thesis}</p>
                ${findings ? `<ul>${findings}</ul>` : ''}
                <p>\u05e0\u05d9\u05d8\u05e8\u05dc\u05d9\u05d5\u05ea: <strong>${orgProfile.neutrality}/5</strong> | \u05e9\u05e7\u05d9\u05e4\u05d5\u05ea: <strong>${orgProfile.transparency}/5</strong> | \u05de\u05d9\u05de\u05d5\u05df: ${orgProfile.funding_sources}${reportLink}</p>
            </div>`);
        }

        // ── 2. NIF funder connection ──
        const isNIF = orgProfile && orgProfile.funding_sources && /NIF|קרן חדשה/.test(orgProfile.funding_sources);
        if (isNIF) {
            parts.push(`<div class="dossier-section dossier-nif">
                <h5>\u{1F4B0} \u05e7\u05e9\u05e8 \u05dc\u05e7\u05e8\u05df \u05d4\u05d7\u05d3\u05e9\u05d4 \u05dc\u05d9\u05e9\u05e8\u05d0\u05dc (NIF)</h5>
                <p>\u05d4\u05e7\u05e8\u05df \u05d4\u05d7\u05d3\u05e9\u05d4 \u05de\u05de\u05de\u05e0\u05ea \u05d0\u05ea \u05d4\u05d0\u05e8\u05d2\u05d5\u05df \u05d4\u05d6\u05d4. \u05d1\u05d0\u05d5\u05ea\u05d5 \u05d6\u05de\u05df, \u05d4\u05d9\u05d0 \u05de\u05de\u05de\u05e0\u05ea \u05d0\u05e8\u05d2\u05d5\u05e0\u05d9\u05dd \u05e9\u05de\u05dc\u05de\u05d3\u05d9\u05dd <strong>\u05d8\u05db\u05e0\u05d9\u05e7\u05d5\u05ea \u05de\u05e0\u05d9\u05e4\u05d5\u05dc\u05e6\u05d9\u05d4 \u05de\u05e4\u05d5\u05e8\u05e9\u05d5\u05ea</strong>:</p>
                <div class="concept-evidence-quote" style="margin:8px 0">
                    <p>\u201F\u05e7\u05d5\u05d3\u05dd \u05db\u05dc \u05dc\u05d4\u05d1\u05d9\u05df \u05d0\u05d9\u05da \u05d4\u05d1\u05df \u05d0\u05d3\u05dd \u05d4\u05d0\u05d7\u05e8 \u05d7\u05d5\u05e9\u05d1 \u05e2\u05dc \u05d4\u05e1\u05d5\u05d2\u05d9\u05d4, \u05d5\u05d0\u05d6 \u05de\u05ea\u05d5\u05da \u05d4\u05d4\u05e1\u05ea\u05db\u05dc\u05d5\u05ea \u05e9\u05dc\u05d5, \u05dc\u05e0\u05e1\u05d7 \u05dc\u05d5 \u05d0\u05ea \u05d4\u05d1\u05e2\u05d9\u05d4 \u05d1\u05d0\u05d5\u05e4\u05df \u05e9<strong>\u05d4\u05ea\u05e9\u05d5\u05d1\u05d4 \u05d4\u05d0\u05e4\u05e9\u05e8\u05d9\u05ea \u05d4\u05d9\u05d7\u05d9\u05d3\u05d4</strong> \u05dc\u05e9\u05d0\u05dc\u05d4 \u05e9\u05d0\u05e0\u05d9 \u05e9\u05d5\u05d0\u05dc \u05d0\u05d5\u05ea\u05d5, \u05d4\u05d9\u05d0 \u05dc\u05e2\u05e9\u05d5\u05ea \u05d0\u05ea \u05d4\u05d3\u05d1\u05e8 \u05e9\u05d0\u05e0\u05d9 \u05e8\u05d5\u05e6\u05d4 \u05e9\u05d4\u05d5\u05d0 \u05d9\u05e2\u05e9\u05d4\u201E</p>
                    <div class="quote-src">\u2014 <strong>\u05d7\u05d2\u05d9 \u05d0\u05dc\u05e7\u05d9\u05d9\u05dd</strong>, \u05e1\u05d3\u05e0\u05ea "\u05d4\u05e0\u05d3\u05e1\u05ea \u05ea\u05d5\u05d3\u05e2\u05d4" \u05e9\u05dc \u05d0\u05e8\u05d2\u05d5\u05df \u05de\u05d7\u05d6\u05e7\u05d9\u05dd (\u05de\u05de\u05d5\u05de\u05df \u05e2"\u05d9 \u05d4\u05e7\u05e8\u05df \u05d4\u05d7\u05d3\u05e9\u05d4)
                        <a href="https://www.gnostocracy.com/?quote=534" target="_blank" rel="noopener">[\u05de\u05e7\u05d5\u05e8 + \u05d5\u05d9\u05d3\u05d0\u05d5]</a></div>
                </div>
                <p>\u05d6\u05d5 \u05dc\u05d0 \u05d4\u05e0\u05d7\u05d4 \u05ea\u05d9\u05d0\u05d5\u05e8\u05d8\u05d9\u05ea \u2014 \u05d6\u05d4 \u05e7\u05d5\u05e8\u05e1 \u05de\u05e6\u05d5\u05dc\u05dd \u05e9\u05dc \u05d0\u05e8\u05d2\u05d5\u05df \u05e9\u05d4\u05e7\u05e8\u05df \u05d4\u05d7\u05d3\u05e9\u05d4 \u05de\u05de\u05de\u05e0\u05ea. \u05d0\u05d5\u05ea\u05d4 \u05e8\u05e9\u05ea \u05d0\u05e8\u05d2\u05d5\u05e0\u05d9\u05dd \u05de\u05e4\u05e2\u05d9\u05dc\u05d4 \u05ea\u05d5\u05db\u05e0\u05d9\u05d5\u05ea \u05d1\u05d1\u05ea\u05d9 \u05e1\u05e4\u05e8.</p>
            </div>`);
        }

        // ── 3. Missing data + opacity by design ──
        parts.push(`<div class="dossier-section dossier-missing">
            <h5>\u2753 \u05de\u05d4 \u05d0\u05e0\u05d7\u05e0\u05d5 \u05dc\u05d0 \u05d9\u05d5\u05d3\u05e2\u05d9\u05dd</h5>
            <ul>
                <li>\u05de\u05d4 \u05d1\u05d3\u05d9\u05d5\u05e7 \u05e7\u05d5\u05e8\u05d4 \u05d1\u05db\u05d9\u05ea\u05d4 \u2014 \u05d7\u05d5\u05de\u05e8\u05d9 \u05d4\u05dc\u05d9\u05de\u05d5\u05d3 \u05dc\u05d0 \u05e4\u05ea\u05d5\u05d7\u05d9\u05dd \u05dc\u05e2\u05d9\u05d5\u05df \u05e6\u05d9\u05d1\u05d5\u05e8\u05d9</li>
                <li>\u05de\u05d4 \u05d4\u05de\u05e0\u05d7\u05d9\u05dd \u05d0\u05d5\u05de\u05e8\u05d9\u05dd \u05dc\u05ea\u05dc\u05de\u05d9\u05d3\u05d9\u05dd \u05de\u05e2\u05d1\u05e8 \u05dc\u05de\u05d4 \u05e9\u05db\u05ea\u05d5\u05d1 \u05d1\u05ea\u05e7\u05e6\u05d9\u05e8</li>
                <li>\u05d0\u05d9\u05dc\u05d5 \u05ea\u05d5\u05e6\u05d0\u05d5\u05ea \u05d3\u05d5\u05d5\u05d7\u05d5 \u05dc\u05d4\u05d5\u05e8\u05d9\u05dd</li>
                <li>\u05d4\u05d0\u05dd \u05d4\u05d9\u05d9\u05ea\u05d4 \u05d4\u05e1\u05db\u05de\u05ea \u05d4\u05d5\u05e8\u05d9\u05dd \u05de\u05e8\u05d0\u05e9 (opt-in) \u05d0\u05d5 \u05d4\u05d5\u05d3\u05e2\u05d4 \u05d1\u05d3\u05d9\u05e2\u05d1\u05d3 (opt-out)</li>
            </ul>
            <p><strong>\u05d6\u05d4 \u05d1\u05db\u05d5\u05d5\u05e0\u05d4.</strong> \u05d0\u05e0\u05e9\u05d9\u05dd \u05de\u05e8\u05db\u05d6\u05d9\u05d9\u05dd \u05d1\u05de\u05e2\u05e8\u05db\u05ea \u05de\u05d1\u05d9\u05e2\u05d9\u05dd \u05e2\u05de\u05d3\u05d5\u05ea \u05de\u05e4\u05d5\u05e8\u05e9\u05d5\u05ea \u05e0\u05d2\u05d3 \u05e9\u05e7\u05d9\u05e4\u05d5\u05ea.
                <a href="#" onclick="event.preventDefault();event.stopPropagation();switchTab('background',document.querySelector('.nav-tab'))">\u05dc\u05de\u05d4 \u05d6\u05d4 \u05d1\u05e2\u05d9\u05d4 \u2192</a>
            </p>
        </div>`);

        // ── 4. Suspicious terms detected ──
        const termBadges = concepts.map(c =>
            `<span class="dossier-term-link" style="background:${c.color};cursor:pointer" onclick="event.stopPropagation();showConceptEvidence('${c.id}')">${c.short_label}</span>`
        ).join('');
        parts.push(`<div class="dossier-section">
            <h5>\u{1F50D} \u05de\u05d5\u05e0\u05d7\u05d9\u05dd \u05d7\u05e9\u05d5\u05d3\u05d9\u05dd \u05e9\u05d6\u05d5\u05d4\u05d5</h5>
            <p>\u05dc\u05db\u05dc \u05de\u05d5\u05e0\u05d7 \u05d9\u05e9 \u05de\u05e9\u05de\u05e2\u05d5\u05ea \u05d2\u05dc\u05d5\u05d9\u05d4 (\u05ea\u05de\u05d9\u05de\u05d4) \u05d5\u05de\u05e9\u05de\u05e2\u05d5\u05ea \u05de\u05ea\u05d5\u05e2\u05d3\u05ea (\u05d1\u05e2\u05d9\u05d9\u05ea\u05d9\u05ea). \u05dc\u05d7\u05e6\u05d5 \u05dc\u05e4\u05e8\u05d8\u05d9\u05dd:</p>
            <div class="dossier-terms">${termBadges}</div>
            <div class="dossier-deep-links">
                <a href="https://aosshalem-dev.github.io/progressive-rosetta-stone/" target="_blank" rel="noopener" style="background:#8b0000" onclick="event.stopPropagation()">\u{1F5FF} \u05d0\u05d1\u05df \u05e8\u05d5\u05d6\u05d8\u05d4 \u05d4\u05e4\u05e8\u05d5\u05d2\u05e8\u05e1\u05d9\u05d1\u05d9\u05ea</a>
                <a href="https://aosshalem-dev.github.io/sel-research/" target="_blank" rel="noopener" style="background:#1565c0" onclick="event.stopPropagation()">\u{1F9E0} \u05de\u05d7\u05e7\u05e8 SEL</a>
                <a href="https://aosshalem-dev.github.io/shefi-research/" target="_blank" rel="noopener" style="background:#6a1b9a" onclick="event.stopPropagation()">\u26A0 \u05e9\u05e4"\u05d9 \u2014 \u05de\u05d2\u05d3\u05e8 \u05d5\u05d6\u05d4\u05d5\u05ea \u05de\u05d9\u05e0\u05d9\u05ea</a>
            </div>
        </div>`);

        return parts.join('');
    }

    // ── Tab switching ──
    function switchTab(tab, el) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        if (el) el.classList.add('active');

        // Lazy-render tab content
        if (tab === 'education' && !document.getElementById('edu-programs-list').innerHTML) renderEducation();
        if (tab === 'protocols' && !document.getElementById('proto-details-list').innerHTML) {
            renderFindings();
            renderProtocols();
            renderProtocolBrowser();
        }
        if (tab === 'redflags' && !document.getElementById('redflags-list').innerHTML) renderRedFlags();
        if (tab === 'research' && !document.getElementById('clusters-grid').innerHTML) renderResearch();
    }

    // ── City name -> protocol key mapping ──
    const CITY_KEY_MAP = {
        'אריאל': 'ariel', 'באר שבע': 'BEER_SHEVA', 'אפרת': 'EFRAT',
        'עמנואל': 'EMANUEL', 'גבעת שמואל': 'GIVAT_SHMUEL', 'גבעתיים': 'GIVATAYIM',
        'חיפה': 'HAIFA', 'הרצליה': 'HERZLIYA', 'הוד השרון': 'HOD_HASHARON',
        'כרמיאל': 'KARMIEL', 'קרית גת': 'KIRYAT_GAT', 'קרית אונו': 'KIRYAT_ONO',
        'נתיבות': 'NETIVOT', 'רעננה': 'RAANANA', 'ראש העין': 'ROSH_HAAYIN',
        'תל אביב-יפו': 'TEL_AVIV', 'קרית שמונה': 'KIRYAT_SHMONA', 'רמת השרון': 'RAMAT_HASHARON',
    };

    function scoreColor(score) {
        if (score >= 50) return '#ff4444';
        if (score >= 30) return '#ff8800';
        if (score >= 15) return '#b89900';
        return '#44aa44';
    }
    function evidenceColor(score) {
        if (score >= 50) return '#ff4444';
        if (score >= 30) return '#ff8800';
        if (score >= 15) return '#b89900';
        if (score > 0) return '#44aa44';
        return '#666';
    }

    function ratingClass(r) {
        if (r >= 5) return 'r5';
        if (r >= 4) return 'r4';
        if (r >= 3) return 'r3';
        return 'r2';
    }

    function riskBadgeClass(score) {
        if (score >= 5) return 'risk-high';
        if (score >= 4) return 'risk-medium-high';
        if (score >= 3) return 'risk-medium';
        return 'risk-low';
    }

    function buildPieChart(progPct, religPct, otherPct, size) {
        const r = size / 2;
        const cx = r, cy = r;
        const slices = [
            { pct: progPct, color: '#6644cc' },
            { pct: religPct, color: '#cc8844' },
            { pct: otherPct, color: '#bbb' }
        ].filter(s => s.pct > 0);
        let paths = '';
        let startAngle = -90;
        for (const slice of slices) {
            const angle = (slice.pct / 100) * 360;
            const endAngle = startAngle + angle;
            const startRad = (startAngle * Math.PI) / 180;
            const endRad = (endAngle * Math.PI) / 180;
            const x1 = cx + r * Math.cos(startRad);
            const y1 = cy + r * Math.sin(startRad);
            const x2 = cx + r * Math.cos(endRad);
            const y2 = cy + r * Math.sin(endRad);
            const largeArc = angle > 180 ? 1 : 0;
            if (slice.pct >= 100) {
                paths += `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${slice.color}"/>`;
            } else {
                paths += `<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${largeArc} 1 ${x2},${y2} Z" fill="${slice.color}"/>`;
            }
            startAngle = endAngle;
        }
        return `<svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="display:block">${paths}</svg>`;
    }

    function buildPoleBar(label, value, max, color) {
        const pct = Math.min((value / max) * 100, 100);
        return `<div class="pole-bar-container">
            <div class="pole-bar-label">${label}</div>
            <div class="pole-bar-bg">
                <div class="pole-bar-fill" style="width:${pct}%;background:${color}"></div>
                <div class="pole-bar-value">${value}</div>
            </div>
        </div>`;
    }

    function buildKeywordPills(details) {
        if (!details || typeof details !== 'object') return '';
        let pills = [];
        for (const [cat, keywords] of Object.entries(details)) {
            if (typeof keywords !== 'object') continue;
            for (const [word, count] of Object.entries(keywords)) {
                pills.push({word, count});
            }
        }
        pills.sort((a, b) => b.count - a.count);
        return pills.slice(0, 20).map(p =>
            `<li><span class="count">${p.count}</span>${p.word}</li>`
        ).join('');
    }

    // ── Find research cluster for a program ──
    function findCluster(prog) {
        if (typeof RESEARCH === 'undefined') return null;
        // Check direct ID mapping
        const cid = RESEARCH.program_cluster_map[prog.id];
        if (cid) return RESEARCH.clusters[cid];
        // Check name patterns
        for (const [pattern, clusterId] of Object.entries(RESEARCH.program_name_patterns)) {
            if (prog.name && prog.name.includes(pattern)) {
                return RESEARCH.clusters[clusterId];
            }
        }
        return null;
    }

    function buildResearchPanel(cluster) {
        if (!cluster) return '';
        const findings = (cluster.key_findings || []).slice(0, 5);
        const summary = cluster.summary.length > 200 ? cluster.summary.slice(0, 200) + '...' : cluster.summary;
        return `<div class="research-panel">
            <h5>
                &#128270; מחקר מעמיק: ${cluster.name_he}
                <span class="risk-badge ${riskBadgeClass(cluster.risk_score)}">סיכון: ${cluster.risk_level}</span>
            </h5>
            <div style="font-size:0.85em;color:#555;margin-bottom:8px">${summary}</div>
            ${findings.length > 0 ? `
                <ul class="finding-list">
                    ${findings.map(f => `<li>${f}</li>`).join('')}
                </ul>` : ''}
            ${cluster.report_url ? `<a class="report-link" href="${cluster.report_url}" target="_blank">&#128196; קרא דוח מלא</a>` : ''}
        </div>`;
    }

    // Map org names to research report URLs for linking
    function findOrgReport(orgName) {
        if (!orgName || typeof RESEARCH_ORGS === 'undefined') return null;
        for (const [key, o] of Object.entries(RESEARCH_ORGS.orgs || {})) {
            if (orgName.includes(o.name_he) || o.name_he.includes(orgName) ||
                (o.name_en && orgName.toLowerCase().includes(o.name_en.toLowerCase()))) {
                return o.report_url || null;
            }
        }
        // Partial matches for common short names
        const partials = {
            'הוועד למלחמ': 'research/deep_AIDS_Task_Force.html',
            'מחנכים לשינוי': 'research/deep_Efshar_Acheret.html',
            'חוש"ן': 'research/deep_CHOSHEN.html',
            'מגע בתיאום': 'research/deep_Maga_BeTiaum.html',
            'מידע אמין': 'research/deep_Meyda_Amin.html',
            'מצמיחים': 'research/deep_Matzmichim.html',
            'Mind Lab': 'research/deep_Mind_Lab.html',
            'אשכולות חשיבה': 'research/deep_Mind_Lab.html',
            'הרטמן': 'research/deep_Hartman.html',
            'דרור': 'research/deep_Yesodot_Dror.html',
            'יסודות': 'research/deep_Yesodot_Dror.html',
            'גשר': 'research/deep_Gesher.html',
            'אליאנס': 'research/deep_Alliance_Israel.html',
            'ידידות טורונטו': 'research/deep_Yedidut_Toronto.html',
            'תיקון': 'research/deep_Tikkun.html',
            'חבצלת': 'research/deep_Havatzelet.html',
            'השומר הצעיר': 'research/deep_Havatzelet.html',
            'רוסינג': 'research/deep_Rossing_Center.html',
            'יד ביד': 'research/deep_Yad_BYad.html',
            'לדעת': 'research/deep_Ladaat.html',
            'תהודה': 'research/deep_Tehuda.html',
            'אור גלברד': 'research/deep_Or_Gelbard.html',
            'טבע האדם': 'research/deep_Teva_HaAdam.html',
            'מהפך תודעתי': 'research/deep_Todaa.html',
            'קהלים שלובים': 'research/deep_Kehalim_Shluvim.html',
            'המרחב החברתי': 'research/deep_Markam.html',
            'מרקם': 'research/deep_Markam.html',
            'שער שוויון': 'research/deep_Shaar_Shivion.html',
            'המכון הדמוקרטי': 'research/deep_Democratic_Institute.html',
            'אפשר אחרת': 'research/deep_Efshar_Acheret.html',
            'חברותא': 'research/deep_Chevruta.html',
            'יסוד': 'research/deep_Yesod.html',
            'זכויות האזרח': 'research/deep_ACRI.html',
            'ACRI': 'research/deep_ACRI.html',
            'איגוד מרכזי הסיוע': 'research/deep_Sexual_Assault_Centers.html',
            'מרכזי סיוע': 'research/deep_Sexual_Assault_Centers.html',
            'ליד"ה': 'research/deep_Leyada.html',
            'ליד האוניברסיטה': 'research/deep_Leyada.html',
            'קדמה': 'research/deep_Kadma.html',
            'סייף סקול': 'research/deep_SafeSchool.html',
            'SafeSchool': 'research/deep_SafeSchool.html'
        };
        for (const [partial, url] of Object.entries(partials)) {
            if (orgName.includes(partial)) return url;
        }
        return null;
    }

    let _cardIdx = 0;
    function buildProgramCard(prog) {
        const uid = _cardIdx++;
        const info = DATA.program_info[prog.id] || {};
        const summary = info.summary || '';
        const rDesc = info.research_desc || prog.research_desc || '';
        const rNotes = info.research_notes || prog.research_notes || '';
        const cluster = findCluster(prog);
        const orgName = info.org || prog.institution || '';
        const orgReportUrl = findOrgReport(orgName) || findOrgReport(prog.name || '');

        // Check if this program has a depth chain
        const depthData = (typeof DEPTH_CHAINS !== 'undefined') ? DEPTH_CHAINS[prog.id] : null;

        let detailParts = [];

        // ── Close button ──
        detailParts.push(`<span class="prog-close-btn" onclick="closeProg('pc-${uid}', event)" title="סגור">&times;</span>`);

        // ── 1. GEFEN catalog text (verbatim, always first) ──
        if (summary) {
            detailParts.push(`<div style="margin-bottom:10px"><strong>תיאור התכנית באתר גפ"ן:</strong> ${summary}</div>`);
        }

        // ── 2. Full GEFEN description — skip for depth chain programs (it's Gemini content) ──
        if (!depthData && info.gefen_description && info.gefen_description !== summary) {
            detailParts.push(`<div style="margin-bottom:10px"><strong>מידע מלא מגפ"ן:</strong> ${info.gefen_description}</div>`);
        }

        // ── 3. Our deep research description (depth chain overrides generic) ──
        if (depthData && depthData.deep_description) {
            detailParts.push(depthData.deep_description);
        } else {
            if (rDesc) detailParts.push(`<div class="research-comment"><strong>תיאור מחקרי:</strong> ${rDesc}</div>`);
            if (rNotes) detailParts.push(`<div class="research-comment"><strong>הערות:</strong> ${rNotes}</div>`);
        }

        // ── 4. Basic info ──
        const orgLink = orgReportUrl
            ? `<a href="${orgReportUrl}" target="_blank" rel="noopener" style="color:#2980b9;text-decoration:underline">${orgName || '\u2014'}</a>`
            : (orgName || '\u2014');
        detailParts.push(`<div><strong>ארגון:</strong> ${orgLink}</div>`);
        if (info.field) detailParts.push(`<div><strong>תחום:</strong> ${info.field}</div>`);
        if (info.schools) detailParts.push(`<div><strong>בתי ספר:</strong> ${info.schools} &nbsp;|&nbsp; <strong>ערים:</strong> ${info.num_cities || '\u2014'}</div>`);
        detailParts.push(`<div><strong>מקור דירוג:</strong> ${prog.source || '\u2014'}</div>`);

        // ── 5. Key people (skip Gemini suspicion text if depth chain exists) ──
        if (info.key_people && info.key_people.length > 0) {
            const peopleHtml = info.key_people.map(kp => {
                const susp = depthData ? '' : (kp.suspicion ? ' \u2014 <span style="color:#c0392b">' + kp.suspicion + '</span>' : '');
                return `<li><strong>${kp.name}</strong>${kp.role ? ' (' + kp.role + ')' : ''}${susp}</li>`;
            }).join('');
            detailParts.push(`<div><strong>אנשי מפתח:</strong><ul style="margin:4px 0">${peopleHtml}</ul></div>`);
        }

        // ── 6. Source links ──
        let sourceLinks = [];
        if (info.website_url) sourceLinks.push(`<a href="${info.website_url}" target="_blank" rel="noopener" style="color:#2a5a8a">אתר התכנית</a>`);
        if (orgName) sourceLinks.push(`<a href="https://www.guidestar.org.il/search?q=${encodeURIComponent(orgName)}" target="_blank" rel="noopener" style="color:#2a5a8a">חיפוש GuideStar</a>`);
        if (orgReportUrl) sourceLinks.push(`<a href="${orgReportUrl}" target="_blank" rel="noopener" style="color:#c0392b;font-weight:bold">דוח מחקר מעמיק</a>`);
        if (sourceLinks.length) detailParts.push(`<div style="margin-top:8px;padding-top:8px;border-top:1px solid #eee;font-size:0.85em;"><strong>מקורות:</strong> ${sourceLinks.join(' | ')}</div>`);

        // ── 7. DEPTH CHAIN — "Go Deeper" section ──
        if (depthData && depthData.depth_chain && depthData.depth_chain.length > 0) {
            let depthHtml = `<div class="depth-section">
                <h5>רד לעומק הדירוג</h5>`;

            depthData.depth_chain.forEach((level, idx) => {
                depthHtml += `<div class="depth-level" id="depth-${prog.id}-${level.id}">
                    <div class="depth-header" onclick="toggleDepthLevel(this)">
                        <span class="depth-icon">${level.icon || '📌'}</span>
                        <div class="depth-header-text">
                            <div class="depth-title">${level.title_he}</div>
                            <div class="depth-subtitle">${level.subtitle_he}</div>
                        </div>
                        <span class="depth-arrow">▼</span>
                    </div>
                    <div class="depth-body">
                        <div class="depth-summary">${level.summary_he}</div>
                        ${level.content_he}
                        ${level.next_prompt ? `<div class="depth-next-prompt">${level.next_prompt} ↓</div>` : ''}
                    </div>
                </div>`;
            });

            // Related links
            if (depthData.related_links && depthData.related_links.length > 0) {
                depthHtml += `<div class="depth-related"><h6>קישורים למחקר נוסף:</h6>`;
                depthData.related_links.forEach(link => {
                    depthHtml += `<a class="depth-link" href="${link.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">
                        <span class="depth-link-icon">${link.icon || '🔗'}</span>
                        <div class="depth-link-text">
                            <div class="depth-link-title">${link.title_he}</div>
                            ${link.description_he ? `<div class="depth-link-desc">${link.description_he}</div>` : ''}
                        </div>
                    </a>`;
                });
                depthHtml += `</div>`;
            }

            depthHtml += `</div>`;
            detailParts.push(depthHtml);
        }

        // ── 8. Research panel (cluster) — keep for non-depth programs ──
        if (cluster && !depthData) {
            detailParts.push(buildResearchPanel(cluster));
        }

        // ── 9. Gemini data — only show for programs WITHOUT depth chain ──
        if (!depthData) {
            if (info.gemini_risk_score !== undefined) {
                const riskColor = info.gemini_risk_score >= 7 ? '#c0392b' : info.gemini_risk_score >= 4 ? '#e67e22' : '#27ae60';
                detailParts.push(`<div style="opacity:0.6"><strong>ציון סיכון (Gemini):</strong> <span style="color:${riskColor};font-weight:700">${info.gemini_risk_score}/10</span>${info.gemini_risk_justification ? ' \u2014 ' + info.gemini_risk_justification : ''}</div>`);
            }
            if (info.ideology_markers && info.ideology_markers.length > 0) {
                const markerHtml = info.ideology_markers.map(m => {
                    const mColor = m.level === 'high' ? '#c0392b' : m.level === 'medium' ? '#e67e22' : '#888';
                    return `<span style="display:inline-block;background:${mColor};color:#fff;padding:1px 6px;border-radius:3px;font-size:0.78em;margin:2px">${m.text}</span>`;
                }).join('');
                detailParts.push(`<div style="opacity:0.6"><strong>סמנים אידיאולוגיים (Gemini):</strong><div style="margin-top:4px">${markerHtml}</div></div>`);
            }
            if (info.funding_signals && info.funding_signals.length > 0) {
                const fundHtml = info.funding_signals.map(f => `<li>${f}</li>`).join('');
                detailParts.push(`<div><strong>איתותי מימון:</strong><ul style="margin:4px 0">${fundHtml}</ul></div>`);
            }
            if (info.partnerships && info.partnerships.length > 0) {
                const partHtml = info.partnerships.map(p => `<li>${p}</li>`).join('');
                detailParts.push(`<div><strong>שיתופי פעולה:</strong><ul style="margin:4px 0">${partHtml}</ul></div>`);
            }
            if (info.gemini_evidence && info.gemini_evidence.length > 0) {
                const evHtml = info.gemini_evidence.map(e => `<li>${e}</li>`).join('');
                detailParts.push(`<div style="opacity:0.6"><strong>ראיות (Gemini):</strong><ul style="margin:4px 0">${evHtml}</ul></div>`);
            }
            if (info.gemini_sources && info.gemini_sources.length > 0) {
                const srcHtml = info.gemini_sources.map(s =>
                    s.url ? `<li><a href="${s.url}" target="_blank" rel="noopener" style="color:#2a5a8a">${s.title || s.url}</a></li>`
                           : `<li>${s.title}</li>`
                ).join('');
                detailParts.push(`<div style="opacity:0.6"><strong>מקורות (Gemini):</strong><ul style="margin:4px 0">${srcHtml}</ul></div>`);
            }
        }

        const hasResearch = rDesc || rNotes || depthData;
        const researchBadge = hasResearch ? '<span class="research-badge">מחקר</span>' : '';
        const clusterBadge = cluster ? `<span class="cluster-badge">${cluster.name_he}</span>` : '';
        const depthBadge = depthData ? '<span class="cluster-badge" style="background:#cc0000">ראיות מעמיקות</span>' : '';

        // Concept detection
        const concepts = detectConcepts(prog, info);
        const conceptBadges = concepts.map(c =>
            `<span class="concept-badge" style="background:${c.color}" onclick="event.stopPropagation();showConceptEvidence('${c.id}')">${c.short_label}</span>`
        ).join('');

        // Full suspicion dossier for programs with detected concepts
        if (concepts.length > 0) {
            detailParts.push(buildSuspicionDossier(prog, info, concepts));
            detailParts.push(buildClearanceFooter());
        }

        return `<div class="program-card" onclick="toggleProg('pc-${uid}')">
            <div class="prog-header">
                <span class="prog-name">${prog.name} ${clusterBadge} ${depthBadge} ${researchBadge} ${conceptBadges}</span>
                <span class="prog-rating ${ratingClass(prog.rating)}">${prog.rating}</span>
            </div>
            <div class="prog-meta">
                תקציב: \u20AA${Math.round(prog.budget).toLocaleString()} &nbsp;|&nbsp; ${orgReportUrl
                    ? `<a href="${orgReportUrl}" target="_blank" rel="noopener" style="color:#2980b9" onclick="event.stopPropagation()">${orgName || prog.institution || ''}</a>`
                    : (orgName || prog.institution || '')}
            </div>
            <div class="prog-detail" id="pc-${uid}">
                ${detailParts.join('')}
            </div>
        </div>`;
    }

    let _orgCardIdx = 0;
    function buildOrgPanel(cityName) {
        if (typeof RESEARCH_ORGS === 'undefined') return '';
        const orgKeys = RESEARCH_ORGS.city_orgs[cityName];
        if (!orgKeys || orgKeys.length === 0) return '';

        const riskClass = r => r === 'high' ? 'risk-high' : r === 'medium-high' ? 'risk-medium-high' : r === 'medium' ? 'risk-medium' : r === 'moderate' ? 'risk-medium' : 'risk-low';
        const riskHe = r => ({'high':'\u05d2\u05d1\u05d5\u05d4','medium-high':'\u05d1\u05d9\u05e0\u05d5\u05e0\u05d9-\u05d2\u05d1\u05d5\u05d4','medium':'\u05d1\u05d9\u05e0\u05d5\u05e0\u05d9','moderate':'\u05de\u05ea\u05d5\u05df','low-moderate':'\u05e0\u05de\u05d5\u05da-\u05de\u05ea\u05d5\u05df','low':'\u05e0\u05de\u05d5\u05da'}[r] || r);

        const cards = orgKeys.map(key => {
            const o = RESEARCH_ORGS.orgs[key];
            if (!o) return '';
            const uid = _orgCardIdx++;
            const findings = o.key_findings || [];
            const links = o.source_links || [];
            const ideoTag = o.ideology_detected
                ? '<span style="background:#cc0000;color:#fff;padding:1px 6px;border-radius:3px;font-size:0.7em;margin-right:6px">\u05d0\u05d9\u05d3\u05d9\u05d0\u05d5\u05dc\u05d5\u05d2\u05d9\u05d4</span>'
                : '<span style="background:#44aa66;color:#fff;padding:1px 6px;border-radius:3px;font-size:0.7em;margin-right:6px">\u05e0\u05d9\u05d8\u05e8\u05dc\u05d9</span>';

            const srcLinks = links.map(l =>
                `<a href="${l.url}" target="_blank" rel="noopener" class="org-source-link">${l.label}</a>`
            ).join(' ');
            const reportLink = o.report_url
                ? `<a href="${o.report_url}" target="_blank" class="org-report-link">\u{1F4C4} \u05d3\u05d5\u05d7 \u05de\u05d7\u05e7\u05e8 \u05de\u05dc\u05d0</a>`
                : '';

            return `<div class="org-card ${riskClass(o.risk)}" onclick="document.getElementById('org-detail-${uid}').classList.toggle('visible');this.classList.toggle('expanded')" style="cursor:pointer">
                <div class="org-card-header">
                    <span class="org-card-name">${o.name_he} ${ideoTag}</span>
                    <span class="org-risk-badge ${riskClass(o.risk)}">${riskHe(o.risk)}</span>
                </div>
                <div class="org-card-reg">${o.name_en} | ${o.entity_type} | \u05e8\u05d9\u05e9\u05d5\u05dd: ${o.reg}${o.founded ? ' | \u05e0\u05d5\u05e1\u05d3: ' + o.founded : ''}</div>
                <div class="org-card-thesis">${o.thesis}</div>
                <div class="org-card-stats">
                    <div class="org-stat"><strong>\u20AA${(o.revenue_nis / 1000000).toFixed(1)}M</strong> \u05ea\u05e7\u05e6\u05d9\u05d1</div>
                    <div class="org-stat"><strong>${Math.round(o.gov_pct)}%</strong> \u05de\u05de\u05e9\u05dc\u05ea\u05d9</div>
                    <div class="org-stat"><strong>${o.staff}</strong> \u05e2\u05d5\u05d1\u05d3\u05d9\u05dd</div>
                    <div class="org-stat"><strong>${o.school_count}</strong> \u05d1\u05ea\u05d9 \u05e1\u05e4\u05e8</div>
                    ${o.program_budget > 0 ? `<div class="org-stat"><strong>\u20AA${Math.round(o.program_budget).toLocaleString()}</strong> \u05ea\u05e7\u05e6\u05d9\u05d1 \u05d2\u05e4\u05df</div>` : ''}
                    <div class="org-stat">\u05e0\u05d9\u05d8\u05e8\u05dc\u05d9\u05d5\u05ea: <strong>${o.neutrality}/5</strong></div>
                    <div class="org-stat">\u05e9\u05e7\u05d9\u05e4\u05d5\u05ea: <strong>${o.transparency}/5</strong></div>
                </div>
                <div class="org-expand-hint" style="text-align:center;font-size:0.75em;color:#888;margin-top:4px">\u25BC \u05dc\u05d7\u05e5 \u05dc\u05e4\u05e8\u05d8\u05d9\u05dd \u05de\u05dc\u05d0\u05d9\u05dd \u25BC</div>
                <div class="prog-detail" id="org-detail-${uid}">
                    <div style="font-size:0.8em;color:#666;margin-bottom:6px"><strong>\u05de\u05d9\u05de\u05d5\u05df:</strong> ${o.funding_sources}</div>
                    ${findings.length > 0 ? `<ul class="org-findings">${findings.map(f => `<li>${f}</li>`).join('')}</ul>` : ''}
                    <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;align-items:center">
                        ${reportLink}
                        ${srcLinks}
                    </div>
                </div>
            </div>`;
        }).join('');

        return `<div class="detail-section org-profiles-section">
            <h4>\u05d0\u05e8\u05d2\u05d5\u05e0\u05d9\u05dd \u05e0\u05d7\u05e7\u05e8\u05d9\u05dd \u05d1\u05e2\u05d9\u05e8 (${orgKeys.length} \u05de\u05ea\u05d5\u05da 14 \u05e0\u05d7\u05e7\u05e8\u05d9\u05dd) &nbsp;<a href="research/" style="font-size:0.75em;font-weight:normal;color:#2980b9">כל הדוחות &rarr;</a></h4>
            ${cards}
        </div>`;
    }

    function buildDetailPanel(entry) {
        // === Pillar 1: Proven Programs ===
        let programsPanel = '';
        const provenProgs = entry.proven_programs || [];
        if (provenProgs.length > 0) {
            const progCards = provenProgs.slice(0, 10).map(p => {
                const puid = _cardIdx++;
                const tierBadge = p.tier === 'A'
                    ? `<span style="background:#c0392b;color:#fff;padding:1px 6px;border-radius:3px;font-size:0.75em;margin-left:6px">Tier A (R${p.rating})</span>`
                    : `<span style="background:#d35400;color:#fff;padding:1px 6px;border-radius:3px;font-size:0.75em;margin-left:6px">Tier B (${p.org_key || 'org'})</span>`;

                // Resolve program info by name if no id
                const pInfo = findProgramInfoByName(p.name) || {};
                const pOrgName = pInfo.org || p.org || '';

                // Detect concepts (now uses name-based ID resolution)
                const pConcepts = detectConcepts(p, pInfo);
                const pBadges = pConcepts.map(c =>
                    `<span class="concept-badge" style="background:${c.color}" onclick="event.stopPropagation();showConceptEvidence('${c.id}')">${c.short_label}</span>`
                ).join('');

                // Build detail — EVERY program is clickable
                let pParts = [];

                // Program description — full text from Gefen, never truncated
                const pDesc = pInfo.gefen_description || pInfo.summary || '';
                if (pDesc) pParts.push(`<div style="font-size:0.84em;color:#444;margin-bottom:6px"><strong>\u05ea\u05d9\u05d0\u05d5\u05e8 \u05d4\u05ea\u05db\u05e0\u05d9\u05ea \u05d1\u05d0\u05ea\u05e8 \u05d2\u05e4"\u05df:</strong> ${pDesc}</div>`);
                if (pInfo.research_desc) pParts.push(`<div class="research-comment"><strong>\u05ea\u05d9\u05d0\u05d5\u05e8 \u05de\u05d7\u05e7\u05e8\u05d9:</strong> ${pInfo.research_desc}</div>`);
                if (pInfo.field) pParts.push(`<div style="font-size:0.84em;color:#444"><strong>\u05ea\u05d7\u05d5\u05dd:</strong> ${pInfo.field}</div>`);
                if (pInfo.schools) pParts.push(`<div style="font-size:0.84em;color:#444"><strong>\u05d1\u05ea\u05d9 \u05e1\u05e4\u05e8:</strong> ${pInfo.schools} | <strong>\u05e2\u05e8\u05d9\u05dd:</strong> ${pInfo.num_cities || '\u2014'}</div>`);

                // Gemini risk score
                if (pInfo.gemini_risk_score !== undefined) {
                    const riskColor = pInfo.gemini_risk_score >= 7 ? '#c0392b' : pInfo.gemini_risk_score >= 4 ? '#e67e22' : '#27ae60';
                    pParts.push(`<div style="font-size:0.84em;margin:4px 0"><strong>\u05e6\u05d9\u05d5\u05df \u05e1\u05d9\u05db\u05d5\u05df (Gemini):</strong> <span style="color:${riskColor};font-weight:700">${pInfo.gemini_risk_score}/10</span>${pInfo.gemini_risk_justification ? ` \u2014 ${pInfo.gemini_risk_justification}` : ''}</div>`);
                }

                // Key people
                if (pInfo.key_people && pInfo.key_people.length > 0) {
                    const peopleHtml = pInfo.key_people.map(p2 =>
                        `<li><strong>${p2.name}</strong>${p2.role ? ' (' + p2.role + ')' : ''}${p2.suspicion ? ' \u2014 <span style="color:#c0392b">' + p2.suspicion + '</span>' : ''}</li>`
                    ).join('');
                    pParts.push(`<div style="font-size:0.84em;margin:4px 0"><strong>\u05d0\u05e0\u05e9\u05d9 \u05de\u05e4\u05ea\u05d7:</strong><ul style="margin:4px 0">${peopleHtml}</ul></div>`);
                }

                // Ideology markers from Gemini
                if (pInfo.ideology_markers && pInfo.ideology_markers.length > 0) {
                    const markerHtml = pInfo.ideology_markers.map(m => {
                        const mColor = m.level === 'high' ? '#c0392b' : m.level === 'medium' ? '#e67e22' : '#888';
                        return `<span style="display:inline-block;background:${mColor};color:#fff;padding:1px 6px;border-radius:3px;font-size:0.78em;margin:2px">${m.text}</span>`;
                    }).join('');
                    pParts.push(`<div style="font-size:0.84em;margin:4px 0"><strong>\u05e1\u05de\u05e0\u05d9\u05dd \u05d0\u05d9\u05d3\u05d9\u05d0\u05d5\u05dc\u05d5\u05d2\u05d9\u05d9\u05dd (Gemini):</strong><div style="margin-top:4px">${markerHtml}</div></div>`);
                }

                // Funding signals
                if (pInfo.funding_signals && pInfo.funding_signals.length > 0) {
                    const fundHtml = pInfo.funding_signals.map(f => `<li>${f}</li>`).join('');
                    pParts.push(`<div style="font-size:0.84em;margin:4px 0"><strong>\u05d0\u05d9\u05ea\u05d5\u05ea\u05d9 \u05de\u05d9\u05de\u05d5\u05df:</strong><ul style="margin:4px 0">${fundHtml}</ul></div>`);
                }

                // Partnerships
                if (pInfo.partnerships && pInfo.partnerships.length > 0) {
                    const partHtml = pInfo.partnerships.map(pt => `<li>${pt}</li>`).join('');
                    pParts.push(`<div style="font-size:0.84em;margin:4px 0"><strong>\u05e9\u05d9\u05ea\u05d5\u05e4\u05d9 \u05e4\u05e2\u05d5\u05dc\u05d4:</strong><ul style="margin:4px 0">${partHtml}</ul></div>`);
                }

                // Gemini evidence & sources
                if (pInfo.gemini_evidence && pInfo.gemini_evidence.length > 0) {
                    const evHtml = pInfo.gemini_evidence.map(e => `<li>${e}</li>`).join('');
                    pParts.push(`<div style="font-size:0.84em;margin:4px 0"><strong>\u05e8\u05d0\u05d9\u05d5\u05ea (Gemini):</strong><ul style="margin:4px 0">${evHtml}</ul></div>`);
                }
                if (pInfo.gemini_sources && pInfo.gemini_sources.length > 0) {
                    const srcHtml = pInfo.gemini_sources.map(s =>
                        s.url ? `<li><a href="${s.url}" target="_blank" rel="noopener" style="color:#2a5a8a" onclick="event.stopPropagation()">${s.title || s.url}</a></li>`
                               : `<li>${s.title}</li>`
                    ).join('');
                    pParts.push(`<div style="font-size:0.84em;margin:4px 0"><strong>\u05de\u05e7\u05d5\u05e8\u05d5\u05ea (Gemini):</strong><ul style="margin:4px 0">${srcHtml}</ul></div>`);
                }

                // Source links — use website_url instead of dead Gefen link
                let pLinks = [];
                if (pInfo.website_url) pLinks.push(`<a href="${pInfo.website_url}" target="_blank" rel="noopener" style="color:#2a5a8a" onclick="event.stopPropagation()">\u05d0\u05ea\u05e8 \u05d4\u05ea\u05db\u05e0\u05d9\u05ea</a>`);
                const pOrgReport = findOrgReport(pOrgName) || findOrgReport(p.name || '');
                if (pOrgReport) pLinks.push(`<a href="${pOrgReport}" target="_blank" rel="noopener" style="color:#c0392b;font-weight:bold" onclick="event.stopPropagation()">\u05d3\u05d5\u05d7 \u05de\u05d7\u05e7\u05e8 \u05de\u05e2\u05de\u05d9\u05e7</a>`);
                if (pOrgName) pLinks.push(`<a href="https://www.guidestar.org.il/search?q=${encodeURIComponent(pOrgName)}" target="_blank" rel="noopener" style="color:#2a5a8a" onclick="event.stopPropagation()">GuideStar</a>`);
                if (pLinks.length) pParts.push(`<div style="margin-top:6px;padding-top:6px;border-top:1px solid #eee;font-size:0.82em"><strong>\u05de\u05e7\u05d5\u05e8\u05d5\u05ea:</strong> ${pLinks.join(' | ')}</div>`);

                // Suspicion dossier (if concepts detected)
                if (pConcepts.length > 0) {
                    pParts.push(buildSuspicionDossier(p, pInfo, pConcepts));
                    pParts.push(buildClearanceFooter());
                }

                const pDetail = pParts.join('');

                return `<div onclick="document.getElementById('pp-${puid}').classList.toggle('visible');this.classList.toggle('expanded')" style="cursor:pointer;background:#fff5f5;border:1px solid #e8d0d0;border-radius:6px;padding:8px 12px;margin-bottom:6px">
                    <div style="font-weight:600;font-size:0.88em">${p.name} ${tierBadge} ${pBadges}</div>
                    <div style="font-size:0.8em;color:#666;margin-top:2px">
                        ${p.org} | ${p.budget.toLocaleString('he-IL', {maximumFractionDigits:0})} \u20aa | ${p.deployments} \u05e4\u05e8\u05d9\u05e1\u05d5\u05ea
                    </div>
                    <div style="text-align:center;font-size:0.7em;color:#999;margin-top:3px">\u25BC \u05dc\u05d7\u05e6\u05d5 \u05dc\u05e4\u05e8\u05d8\u05d9\u05dd \u25BC</div>
                    <div class="prog-detail" id="pp-${puid}">${pDetail}</div>
                </div>`;
            }).join('');

            programsPanel = `
                <div class="detail-section">
                    <h4>תוכניות מוכחות כבעייתיות (${provenProgs.length}) \u2014 ציון: ${entry.education_pillar_score}</h4>
                    <div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap">
                        <div style="background:#fce4ec;border-radius:6px;padding:8px 14px;text-align:center;min-width:100px">
                            <div style="font-size:1.6em;font-weight:700;color:#c0392b">${provenProgs.length}</div>
                            <div style="font-size:0.78em;color:#555">תוכניות</div>
                        </div>
                        <div style="background:#fce4ec;border-radius:6px;padding:8px 14px;text-align:center;min-width:100px">
                            <div style="font-size:1.6em;font-weight:700;color:#c0392b">${Math.round(entry.proven_budget_pct)}%</div>
                            <div style="font-size:0.78em;color:#555">מתקציב חינוך</div>
                        </div>
                        <div style="background:#f3e5f5;border-radius:6px;padding:8px 14px;text-align:center;min-width:100px">
                            <div style="font-size:1.4em;font-weight:700;color:#7b1fa2">${entry.proven_budget ? entry.proven_budget.toLocaleString('he-IL', {maximumFractionDigits:0}) : 0}</div>
                            <div style="font-size:0.78em;color:#555">\u20aa תקציב מוכח</div>
                        </div>
                    </div>
                    ${progCards}
                    ${provenProgs.length > 10 ? `<div class="dim" style="margin-top:4px">ועוד ${provenProgs.length - 10} תוכניות...</div>` : ''}
                    <div style="margin-top:8px;font-size:0.8em">
                        מקור: 181 סקירות אנושיות (human_reviewed_programs.json) + 6 ארגונים בסיכון גבוה (research_orgs.js)
                    </div>
                </div>`;
        }

        // === Pillar 2: Verified Council Decisions ===
        let protocolPanel = '';
        const findings = entry.protocol_findings_ids || [];
        if (findings.length > 0) {
            // Look up findings from PROTOCOL_FINDINGS if available
            let findingCards = '';
            if (typeof PROTOCOL_FINDINGS !== 'undefined' && PROTOCOL_FINDINGS.findings) {
                const cityFindings = PROTOCOL_FINDINGS.findings.filter(f =>
                    findings.includes(f.id)
                );
                findingCards = cityFindings.map(f => {
                    const outcomeBadge = {
                        'approved': '\u2705 אושר',
                        'unanimously_approved': '\u2705 אושר פה אחד',
                        'signed': '\u2705 נחתם',
                        'established': '\u2705 הוקם',
                        'policy': '\u2705 מדיניות',
                        'confirmed': '\u2705 אושר',
                        'appointed': '\u2705 מינוי',
                        'declaration': '\ud83d\udce3 הצהרה',
                        'active': '\ud83e\udd1d שיתוף פעולה',
                        'proposal': '\ud83d\udccb הצעה',
                        'agenda': '\ud83d\udcc5 סדר יום',
                        'rejected': '\u274c נדחה',
                        'removed': '\u274c הוסר',
                    }[f.outcome] || f.outcome_he || f.outcome;
                    return `<div style="background:#e3f2fd;border:1px solid #bbdefb;border-radius:6px;padding:8px 12px;margin-bottom:6px">
                        <div style="font-weight:600;font-size:0.88em">${outcomeBadge} \u2014 ${f.category_he || ''}</div>
                        <div style="font-size:0.82em;color:#444;margin-top:4px">${f.summary_he ? f.summary_he.substring(0, 200) + (f.summary_he.length > 200 ? '...' : '') : ''}</div>
                        <div style="font-size:0.75em;color:#888;margin-top:2px">${f.date || ''} | ${f.document || ''}</div>
                    </div>`;
                }).join('');
            }

            protocolPanel = `
                <div class="detail-section">
                    <h4>החלטות מועצה מאומתות (${findings.length}) \u2014 ציון: ${entry.protocol_pillar_score}</h4>
                    <div style="background:#e3f2fd;border-radius:6px;padding:8px 14px;text-align:center;display:inline-block;margin-bottom:10px">
                        <div style="font-size:1.6em;font-weight:700;color:#1565c0">${findings.length}</div>
                        <div style="font-size:0.78em;color:#555">ממצאים מאומתים</div>
                    </div>
                    <div style="font-size:0.82em;color:#666;margin-bottom:8px">סכום משוקלל: ${entry.protocol_weighted_sum} (אושר=1.0, הצהרה=0.7, הצעה=0.4, סדר יום=0.2, נדחה=-0.5)</div>
                    ${findingCards}
                    <div style="margin-top:8px;font-size:0.8em">
                        מקור: סקירה ידנית של 537 פרוטוקולים מסומנים |
                        <span style="cursor:pointer;color:#2a5a8a;text-decoration:underline" onclick="event.stopPropagation();switchTab('protocols',document.querySelectorAll('.nav-tab')[3])">צפה בפרוטוקולים</span>
                    </div>
                </div>`;
        }

        // === Pillar 3: News Actions ===
        let newsPanel = '';
        const newsActions = entry.news_actions_detail || [];
        if (newsActions.length > 0) {
            const newsItems = newsActions.map(a =>
                `<div style="margin-bottom:4px;font-size:0.82em;padding:4px 0;border-bottom:1px solid #f0f0f0">
                    <a href="${a.link}" target="_blank" rel="noopener" style="color:#2980b9;text-decoration:none">${a.title}</a>
                    <span style="color:#888;font-size:0.85em"> \u2014 ${a.source || ''}</span>
                    <span style="background:#e8f5e9;color:#2e7d32;padding:1px 6px;border-radius:3px;font-size:0.72em;margin-right:6px">${a.evidence}</span>
                </div>`
            ).join('');

            newsPanel = `
                <div class="detail-section">
                    <h4>פעולות עירוניות מתועדות בחדשות (${newsActions.length}) \u2014 ציון: ${entry.news_pillar_score}</h4>
                    ${newsItems}
                    <div class="dim" style="margin-top:6px;font-size:0.8em">
                        רק כתבות עם עירייה+פועל (anchor+verb). אזכורים בלבד (anchor+domain) לא נספרים.
                    </div>
                </div>`;
        }

        // === High-Risk Orgs ===
        let orgsPanel = '';
        const hrOrgs = entry.high_risk_orgs || [];
        if (hrOrgs.length > 0 && typeof RESEARCH_ORGS !== 'undefined') {
            const orgCards = hrOrgs.map(key => {
                const org = RESEARCH_ORGS.orgs[key];
                if (!org) return '';
                return `<div style="background:#fff3e0;border:1px solid #ffe0b2;border-radius:6px;padding:8px 12px;margin-bottom:6px">
                    <div style="font-weight:600;font-size:0.88em">${org.name_he}
                        <span style="background:#e65100;color:#fff;padding:1px 6px;border-radius:3px;font-size:0.72em;margin-right:6px">סיכון גבוה</span>
                    </div>
                    <div style="font-size:0.8em;color:#666;margin-top:2px">${org.thesis ? org.thesis.substring(0, 150) + '...' : ''}</div>
                    ${org.report_url ? `<a href="${org.report_url}" target="_blank" rel="noopener" style="font-size:0.78em;color:#2980b9" onclick="event.stopPropagation()">דוח מחקר מלא</a>` : ''}
                </div>`;
            }).filter(Boolean).join('');

            if (orgCards) {
                orgsPanel = `
                    <div class="detail-section">
                        <h4>ארגונים בסיכון גבוה בעיר (${hrOrgs.length})</h4>
                        ${orgCards}
                    </div>`;
            }
        }
        // Fallback to legacy org panel if RESEARCH_ORGS not loaded
        if (!orgsPanel) {
            orgsPanel = buildOrgPanel(entry.city);
        }

        // === Legacy keyword panel (collapsed) ===
        let legacyPanel = '';
        if (entry.keyword_proxy != null) {
            legacyPanel = `
                <div class="detail-section" style="opacity:0.6">
                    <h4 style="color:#888">ציון מילות מפתח ישן: ${entry.keyword_proxy} <span class="dim" style="font-weight:normal">(לא נכלל בדירוג)</span></h4>
                    <div style="font-size:0.8em;color:#888">
                        Pole A: ${entry.pole_a ?? '\u2014'} | Pole B: ${entry.pole_b ?? '\u2014'} | חשיפה חינוכית: ${entry.exposure_score ?? '\u2014'}%
                    </div>
                </div>`;
        }

        if (!programsPanel && !protocolPanel && !newsPanel && !orgsPanel) {
            return '<div class="detail-section"><h4>אין ראיות ספציפיות לעיר זו</h4><div class="dim">ציון ראיות: 0 — לא נמצאו תוכניות מוכחות, החלטות מועצה, או פעולות מתועדות</div></div>';
        }

        return `<div class="detail-grid">${programsPanel}${protocolPanel}${newsPanel}${orgsPanel}${legacyPanel}</div>`;
    }

    function toggleCity(idx) {
        const row = document.getElementById(`detail-${idx}`);
        const cityRow = document.getElementById(`city-${idx}`);
        const wasVisible = row.classList.contains('visible');

        document.querySelectorAll('.detail-row').forEach(r => r.classList.remove('visible'));
        document.querySelectorAll('.city-row').forEach(r => r.classList.remove('active'));

        if (!wasVisible) {
            row.classList.add('visible');
            cityRow.classList.add('active');
        }
    }

    function toggleProg(id) {
        const el = document.getElementById(id);
        if (!el) return;
        // Only open — don't toggle close. Use X button to close.
        if (!el.classList.contains('visible')) {
            el.classList.add('visible');
            el.closest('.program-card').classList.add('expanded');
        }
    }
    function closeProg(id, event) {
        if (event) event.stopPropagation();
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove('visible');
            el.closest('.program-card').classList.remove('expanded');
        }
    }
    function toggleDepthLevel(el) {
        event.stopPropagation();
        el.closest('.depth-level').classList.toggle('open');
    }

    // ── News article loader (on-demand per city) — v3 action-based ──
    const _newsCache = {};
    async function loadNewsArticles(cityKey, btn) {
        const container = document.getElementById(`news-articles-${cityKey}`);
        if (!container) return;
        if (container.style.display !== 'none') {
            container.style.display = 'none';
            btn.textContent = btn.textContent.replace('הסתר', 'הצג');
            return;
        }
        if (_newsCache[cityKey]) {
            container.style.display = 'block';
            btn.textContent = btn.textContent.replace('הצג', 'הסתר');
            return;
        }
        btn.textContent = 'טוען כתבות...';
        btn.disabled = true;
        try {
            const resp = await fetch(`data/news/${cityKey}.json`);
            if (!resp.ok) throw new Error('No data');
            const data = await resp.json();
            _newsCache[cityKey] = data;

            const categoryColors = {
                municipal_action: '#2e7d32',
                municipal_cooperation: '#1565c0',
                topic_mention: '#888'
            };

            let html = '';
            if (data.categories) {
                for (const [catKey, catData] of Object.entries(data.categories)) {
                    if (catData.count === 0) continue;
                    const color = categoryColors[catKey] || '#555';
                    html += `<div style="margin-bottom:12px">
                        <div onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'"
                             style="cursor:pointer;font-weight:600;font-size:0.9em;color:${color};padding:4px 0">
                            ${catData.label} (${catData.count} כתבות) ▾
                        </div>
                        <div style="display:none;font-size:0.82em;max-height:300px;overflow-y:auto;padding-right:8px;border-right:2px solid ${color}30">`;
                    for (const a of catData.articles) {
                        const dateStr = a.published ? new Date(a.published).toLocaleDateString('he-IL') : '';
                        const evidenceTag = a.evidence ? `<span style="color:#999;font-size:0.8em;margin-right:4px">[${a.evidence}]</span>` : '';
                        html += `<div style="margin-bottom:6px;padding:3px 0;border-bottom:1px solid #f0f0f0">
                            <a href="${a.url}" target="_blank" rel="noopener" style="color:#2980b9;text-decoration:none;font-size:0.95em">${a.title}</a>
                            <span style="color:#888;font-size:0.85em"> — ${a.source} ${dateStr}</span>
                            ${evidenceTag}
                        </div>`;
                    }
                    html += '</div></div>';
                }
            } else if (data.topics) {
                // Fallback: v2-style topic-based structure
                const topicLabels = {
                    lgbt_municipal: 'להט"ב ומוניציפלי', gender_equality: 'שוויון מגדרי',
                    sustainability: 'קיימות', social_justice: 'צדק חברתי',
                    diversity_inclusion: 'גיוון והכלה', education_progressive: 'חינוך פרוגרסיבי'
                };
                for (const [topicKey, topicData] of Object.entries(data.topics)) {
                    if (topicData.count === 0) continue;
                    const label = topicLabels[topicKey] || topicKey;
                    html += `<div style="margin-bottom:12px">
                        <div onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'"
                             style="cursor:pointer;font-weight:600;font-size:0.9em;color:#339966;padding:4px 0">
                            ${label} (${topicData.count} כתבות) ▾
                        </div>
                        <div style="display:none;font-size:0.82em;max-height:300px;overflow-y:auto;padding-right:8px;border-right:2px solid #e0e0e0">`;
                    for (const a of topicData.articles) {
                        const dateStr = a.published ? new Date(a.published).toLocaleDateString('he-IL') : '';
                        html += `<div style="margin-bottom:6px;padding:3px 0;border-bottom:1px solid #f0f0f0">
                            <a href="${a.url}" target="_blank" rel="noopener" style="color:#2980b9;text-decoration:none;font-size:0.95em">${a.title}</a>
                            <span style="color:#888;font-size:0.85em"> — ${a.source} ${dateStr}</span>
                        </div>`;
                    }
                    html += '</div></div>';
                }
            }
            container.innerHTML = html || '<div style="color:#888;font-size:0.85em">אין כתבות זמינות</div>';
            container.style.display = 'block';
            btn.textContent = btn.textContent.replace('טוען כתבות...', 'הסתר כתבות');
            btn.disabled = false;
        } catch (e) {
            container.innerHTML = '<div style="color:#c00;font-size:0.85em">שגיאה בטעינת כתבות</div>';
            container.style.display = 'block';
            btn.textContent = 'שגיאה';
            btn.disabled = false;
        }
    }

    // ── Search filter ──
    let searchTerm = '';
    function filterTable() {
        searchTerm = document.getElementById('search-input').value.trim();
        render();
    }

    // ── Sorting ──
    let sortCol = 'evidence_score';
    let sortDir = -1;

    function getAllEntries() {
        return (DATA.rankings || []).map(e => ({...e, _group: 'ranked'}));
    }

    function sortEntries(entries) {
        const th = document.querySelector(`th[data-col="${sortCol}"]`);
        const type = th ? th.dataset.type : 'num';

        return entries.slice().sort((a, b) => {
            let va = a[sortCol];
            let vb = b[sortCol];
            // Handle array fields (like high_risk_orgs) — sort by length
            if (Array.isArray(va)) va = va.length;
            if (Array.isArray(vb)) vb = vb.length;
            if (va == null && vb == null) return 0;
            if (va == null) return 1;
            if (vb == null) return -1;
            if (type === 'num') {
                va = parseFloat(va) || 0;
                vb = parseFloat(vb) || 0;
                return (va - vb) * sortDir;
            } else {
                return String(va).localeCompare(String(vb), 'he') * sortDir;
            }
        });
    }

    function updateSortUI() {
        document.querySelectorAll('th[data-col]').forEach(th => {
            const arrow = th.querySelector('.sort-arrow');
            if (th.dataset.col === sortCol) {
                th.classList.add('sorted');
                arrow.textContent = sortDir === -1 ? '\u25BC' : '\u25B2';
            } else {
                th.classList.remove('sorted');
                arrow.textContent = '\u25BC';
            }
        });
    }

    document.querySelector('thead').addEventListener('click', function(e) {
        const th = e.target.closest('th[data-col]');
        if (!th) return;
        const col = th.dataset.col;
        if (sortCol === col) {
            sortDir *= -1;
        } else {
            sortCol = col;
            sortDir = col === 'city' ? 1 : -1;
        }
        updateSortUI();
        render();
    });

    // ── Main table render ──
    function render() {
        const tbody = document.getElementById('table-body');
        let all = sortEntries(getAllEntries());

        // Apply search filter
        if (searchTerm) {
            all = all.filter(e => e.city && e.city.includes(searchTerm));
        }

        let html = '';
        all.forEach((e, i) => {
            const color = e.evidence_score != null ? evidenceColor(e.evidence_score) : '#888';
            const nOrgs = (e.high_risk_orgs || []).length;

            html += `<tr class="city-row" id="city-${i}" onclick="toggleCity(${i})">
                <td class="rank">${e.rank || i+1}</td>
                <td class="city">${e.city} \u25BE</td>
                <td class="score" style="color:${color};font-weight:bold">${e.evidence_score ?? '\u2014'}</td>
                <td>${e.proven_programs_count || 0}</td>
                <td>${e.verified_decisions || 0}</td>
                <td>${e.strong_news_actions || 0}</td>
                <td>${nOrgs || 0}</td>
                <td class="dim" style="color:#888">${e.keyword_proxy != null ? e.keyword_proxy : '\u2014'}</td>
            </tr>
            <tr class="detail-row" id="detail-${i}">
                <td colspan="8" class="detail-cell">${buildDetailPanel(e)}</td>
            </tr>`;
        });

        tbody.innerHTML = html;
    }

    // ── Education tab ──
    function renderEducation() {
        // Collect and dedup programs first, then compute stats
        const allProgs = [];
        for (const [city, progs] of Object.entries(DATA.worst_programs || {})) {
            for (const p of progs) {
                allProgs.push({...p, city});
            }
        }

        // Sort by rating desc, then budget desc
        allProgs.sort((a, b) => (b.rating - a.rating) || (b.budget - a.budget));

        // Deduplicate by id
        const seen = new Set();
        const unique = allProgs.filter(p => {
            if (seen.has(p.id)) return false;
            seen.add(p.id);
            return true;
        });

        // Compute budget from unique programs only
        let totalBudget = 0;
        for (const p of unique) totalBudget += p.budget || 0;

        const cityCount = Object.keys(DATA.worst_programs || {}).length;
        const highRisk = unique.filter(p => p.rating >= 4).length;

        document.getElementById('edu-stats').innerHTML = `
            <div class="stat-item"><div class="stat-value">${cityCount}</div><div class="stat-label">ערים</div></div>
            <div class="stat-item"><div class="stat-value">${unique.length}</div><div class="stat-label">תוכניות ייחודיות</div></div>
            <div class="stat-item"><div class="stat-value">${highRisk}</div><div class="stat-label">סיכון גבוה (4-5)</div></div>
            <div class="stat-item"><div class="stat-value">\u20AA${(totalBudget/1000000).toFixed(1)} מיליון</div><div class="stat-label">תקציב כולל</div></div>
        `;
        document.getElementById('edu-stats').innerHTML += '<div style="font-size:0.78em;color:#888;text-align:center;width:100%;margin-top:4px">מקור: <a href="https://apps.education.gov.il/gefen" target="_blank" rel="noopener" style="color:#2a5a8a">קטלוג גפ"ן — משרד החינוך</a> | <a href="https://aosshalem-dev.github.io/educational-programs/" target="_blank" rel="noopener" style="color:#2a5a8a">ניתוח מלא 2,859 תוכניות</a> | <a href="research/" target="_blank" rel="noopener" style="color:#2a5a8a">46 דוחות מחקר</a></div>';

        const container = document.getElementById('edu-programs-list');
        container.innerHTML = `<div style="max-width:900px;margin:0 auto">
            <div class="program-list" id="edu-prog-cards">
                ${unique.slice(0, 100).map(p => buildProgramCard(p)).join('')}
            </div>
            ${unique.length > 100 ? `<p class="dim" style="text-align:center;margin-top:15px">מציג 100 מתוך ${unique.length} תוכניות. השתמש בחיפוש לסינון.</p>` : ''}
        </div>`;
    }

    function filterEducation() {
        const term = document.getElementById('edu-search').value.trim();
        const cards = document.querySelectorAll('#edu-prog-cards .program-card');
        cards.forEach(card => {
            const text = card.textContent;
            card.style.display = (!term || text.includes(term)) ? '' : 'none';
        });
    }

    // ── Protocol Findings (context-analyzed) ──
    function renderFindings() {
        if (typeof PROTOCOL_FINDINGS === 'undefined') return;
        const findings = PROTOCOL_FINDINGS.findings;
        const listEl = document.getElementById('findings-list');
        const cityFilter = document.getElementById('findings-city-filter');
        const countEl = document.getElementById('findings-count');

        // Populate city filter
        const cities = [...new Set(findings.map(f => f.city))];
        const cityNames = {};
        findings.forEach(f => { cityNames[f.city] = f.city_he; });
        cities.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = cityNames[c] + ' (' + findings.filter(f => f.city === c).length + ')';
            cityFilter.appendChild(opt);
        });

        renderFindingsList();
    }

    function renderFindingsList() {
        if (typeof PROTOCOL_FINDINGS === 'undefined') return;
        const findings = PROTOCOL_FINDINGS.findings;
        const listEl = document.getElementById('findings-list');
        const cityVal = document.getElementById('findings-city-filter').value;
        const outcomeVal = document.getElementById('findings-outcome-filter').value;
        const countEl = document.getElementById('findings-count');

        let filtered = findings;
        if (cityVal !== 'all') filtered = filtered.filter(f => f.city === cityVal);
        if (outcomeVal !== 'all') filtered = filtered.filter(f => f.outcome === outcomeVal);

        countEl.textContent = filtered.length + ' ממצאים';

        const outcomeBadgeClass = {
            approved: 'badge-approved', rejected: 'badge-rejected',
            declaration: 'badge-declaration', proposal: 'badge-proposal',
            policy: 'badge-policy', signed: 'badge-signed',
            established: 'badge-established', appointed: 'badge-appointed',
            agenda: 'badge-agenda', active: 'badge-active',
            confirmed: 'badge-confirmed', removed: 'badge-removed'
        };

        listEl.innerHTML = filtered.map(f => {
            const badgeCls = outcomeBadgeClass[f.outcome] || 'badge-proposal';
            const dateStr = f.date || 'ללא תאריך';
            return `
            <div class="finding-card">
                <div class="finding-top">
                    <span class="finding-city">${f.city_he}</span>
                    <div class="finding-badges">
                        <span class="finding-badge ${badgeCls}">${f.outcome_he}</span>
                        <span class="finding-badge badge-cat">${f.category_he}</span>
                    </div>
                </div>
                <div class="finding-summary">${f.summary_he}</div>
                <div class="finding-quote" onclick="this.classList.toggle('expanded')">${f.quote_he}</div>
                <div class="finding-meta">
                    <span>${dateStr}</span>
                    <span>${f.document}</span>
                    ${f.proposer ? '<span>מציע: ' + f.proposer + '</span>' : ''}
                    <a href="${f.source_url}" target="_blank">מקור: אתר העירייה</a>
                </div>
            </div>`;
        }).join('');
    }

    // The onchange handlers in HTML call renderFindings() — after initial setup,
    // subsequent calls just re-render the list (city filter already populated)
    var _findingsInitialized = false;
    var _origRenderFindings = renderFindings;
    renderFindings = function() {
        if (!_findingsInitialized) {
            _origRenderFindings();
            _findingsInitialized = true;
        } else {
            renderFindingsList();
        }
    };

    // ── Protocols tab ──
    function renderProtocols() {
        const proto = DATA.protocol_details || {};
        const cities = Object.keys(proto);
        const allEntries = getAllEntries();

        // Compute aggregate stats
        const protoEntries = allEntries.filter(e => e.pole_b != null);
        const avgPoleB = protoEntries.length > 0 ? (protoEntries.reduce((s, e) => s + (e.pole_b || 0), 0) / protoEntries.length).toFixed(2) : '—';
        const redFlagCities = protoEntries.filter(e => e.red_flag > 0).length;

        document.getElementById('proto-stats').innerHTML = `
            <div class="stat-item"><div class="stat-value">${cities.length}</div><div class="stat-label">ערים עם פרוטוקולים</div></div>
            <div class="stat-item"><div class="stat-value">${avgPoleB}</div><div class="stat-label">ממוצע ציר ב'</div></div>
            <div class="stat-item"><div class="stat-value">${redFlagCities}</div><div class="stat-label">ערים עם דגלים אדומים</div></div>
        `;
        document.getElementById('proto-stats').innerHTML += '<div style="font-size:0.78em;color:#888;text-align:center;width:100%;margin-top:4px">מקור: פרוטוקולי מועצות עיר — סריקת מילות מפתח אוטומטית | <a href="data/ranking.html" target="_blank" rel="noopener" style="color:#2a5a8a">נתוני דירוג גולמיים</a></div>';

        // Find city name for each key
        const keyToCity = {};
        for (const [name, key] of Object.entries(CITY_KEY_MAP)) {
            keyToCity[key] = name;
        }

        let html = '<div style="max-width:1000px;margin:0 auto">';
        for (const [key, details] of Object.entries(proto)) {
            const cityName = keyToCity[key] || key;
            // Find the ranking entry for pole scores
            const entry = getAllEntries().find(e => (e.protocol_key || CITY_KEY_MAP[e.city]) === key) || {};

            html += `<div class="detail-section" style="margin-bottom:16px">
                <h4>${cityName}</h4>
                <div class="detail-grid" style="margin-top:10px">
                    <div>
                        <strong>ציר א' \u2014 זהות יהודית/ציונית (${entry.pole_a || '\u2014'})</strong>
                        ${buildPoleBar('ציון', entry.pole_a || 0, 10, '#4488cc')}
                        <ul class="kw-list">${buildKeywordPills(details.pole_a_details)}</ul>
                    </div>
                    <div>
                        <strong>ציר ב' \u2014 אותות פרוגרסיביים (${entry.pole_b ?? '\u2014'})</strong>
                        ${buildPoleBar('\u05de\u05ea\u05d5\u05e7\u05df', entry.pole_b || 0, 3, '#ff8800')}
                        <ul class="kw-list">${buildKeywordPills(details.pole_b_details)}</ul>
                    </div>
                </div>
                <div style="font-size:0.78em;color:#999;margin-top:6px;border-top:1px solid #eee;padding-top:4px">
                    מקור: פרוטוקולי מועצת העיר |
                    <a href="data/ranking.html" target="_blank" rel="noopener" style="color:#2a5a8a">נתונים גולמיים</a> |
                    <a href="research/" target="_blank" rel="noopener" style="color:#2a5a8a">דוחות מחקר</a>
                </div>
            </div>`;
        }
        html += '</div>';
        document.getElementById('proto-details-list').innerHTML = html;
    }

    // ── Red Flags tab ──
    const RF_CATEGORY_INFO = {
        'unesco_cooperation': {
            label: 'שיתוף UNESCO / רשתות בינלאומיות',
            icon: '\uD83C\uDF10',
            color: '#cc0000',
            explanation: 'הופעת מונחים המצביעים על השתלבות ברשתות בינלאומיות (רשת ערים לומדות, פיתוח בר-קיימא). מנגנון להחלת מדיניות ערכית אחידה על רשויות מקומיות.',
        },
        'external_consultants': {
            label: 'יועצים חיצוניים',
            icon: '\uD83D\uDC64',
            color: '#ff6600',
            explanation: 'אזכור יועצים חיצוניים בפרוטוקולים. עלול להצביע על ערוץ השפעה אידיאולוגי דרך "מומחיות" מקצועית ללא שקיפות לגבי הגורם השולח.',
        },
    };

    function renderRedFlags() {
        const proto = DATA.protocol_details || {};
        const allEntries = getAllEntries();
        const entries = allEntries.filter(e => e.red_flag > 0).sort((a, b) => (b.red_flag || 0) - (a.red_flag || 0));

        // Aggregate stats
        const totalFlags = entries.reduce((s, e) => s + (e.red_flag || 0), 0);
        const citiesWithFlags = entries.length;
        const totalCities = new Set(allEntries.map(e => e.city)).size;

        let html = '<div style="max-width:900px;margin:0 auto">';

        // Stats bar
        html += `<div class="stats-bar" style="margin-bottom:20px">
            <div class="stat-item"><div class="stat-value" style="color:#cc0000">${citiesWithFlags}</div><div class="stat-label">ערים עם דגלים</div></div>
            <div class="stat-item"><div class="stat-value">${totalCities - citiesWithFlags}</div><div class="stat-label">ערים ללא דגלים</div></div>
            <div class="stat-item"><div class="stat-value">15%</div><div class="stat-label">משקל בציון המשולב</div></div>
        </div>`;

        if (entries.length === 0) {
            html += '<p style="text-align:center;color:#888;padding:20px">אין דגלים אדומים בנתונים הנוכחיים</p>';
        }

        for (const entry of entries) {
            const key = entry.protocol_key || CITY_KEY_MAP[entry.city];
            const details = key ? (proto[key] || {}) : {};
            const rfDetails = details.red_flag_details || {};

            if (Object.keys(rfDetails).length === 0) continue;

            // Build category breakdown
            let categoryHtml = '';
            for (const [catKey, keywords] of Object.entries(rfDetails)) {
                const catInfo = RF_CATEGORY_INFO[catKey] || { label: catKey, icon: '\u26A0', color: '#888', explanation: '' };
                const kwEntries = Object.entries(keywords);
                const totalCount = kwEntries.reduce((s, [, c]) => s + c, 0);

                categoryHtml += `
                    <div style="background:#fafafa;border:1px solid #e8e0e0;border-radius:6px;padding:10px 14px;margin:8px 0">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                            <strong style="color:${catInfo.color}">${catInfo.icon} ${catInfo.label}</strong>
                            <span style="background:${catInfo.color};color:#fff;padding:2px 8px;border-radius:4px;font-size:0.75em">${totalCount} אזכורים</span>
                        </div>
                        <div style="font-size:0.82em;color:#666;margin-bottom:6px">${catInfo.explanation}</div>
                        <ul class="kw-list" style="margin:4px 0 0">
                            ${kwEntries.map(([word, count]) => `<li><span class="count">${count}</span>${word}</li>`).join('')}
                        </ul>
                    </div>`;
            }

            // Coverage info
            const coverage = entry.protocol_coverage || '\u2014';

            html += `<div class="detail-section" style="margin-bottom:16px;border-right:4px solid #ff4444">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
                    <h4 style="margin:0">${entry.city}</h4>
                    <div style="display:flex;gap:10px;align-items:center;font-size:0.8em;color:#888">
                        <span>ציון דגלים: <strong style="color:#cc0000">${entry.red_flag}</strong></span>
                        <span>כיסוי פרוטוקולים: ${coverage}</span>
                    </div>
                </div>
                ${categoryHtml}
                <div style="font-size:0.78em;color:#999;margin-top:8px;border-top:1px solid #eee;padding-top:6px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px">
                    <span>הציון מנורמל לפי אורך הטקסט (אזכורים ל-10,000 תווים) ותורם 20% לציון המשולב.
                    <span style="cursor:pointer;color:#2a5a8a" onclick="switchTab('ranking',document.querySelectorAll('.nav-tab')[1])">צפה בדירוג \u25B8</span></span>
                    ${typeof PROTOCOLS !== 'undefined' && PROTOCOLS[key] ? '<span class="proto-view-link" onclick="event.stopPropagation();showCityProtocols(\'' + key + '\')">צפה בפרוטוקולים \u25B8</span>' : ''}
                </div>
            </div>`;
        }

        // Add "clean cities" summary
        const cleanCities = allEntries.filter(e => e.pole_b != null && (!e.red_flag || e.red_flag === 0)).map(e => e.city);
        if (cleanCities.length > 0) {
            html += `<div class="detail-section" style="margin-bottom:16px;border-right:4px solid #44aa44;background:#f5fff5">
                <h4 style="color:#44aa44">ערים ללא דגלים אדומים (${cleanCities.length})</h4>
                <div style="font-size:0.88em;color:#555;margin:8px 0">בערים אלה לא נמצאו אינדיקטורים של לכידה מוסדית בפרוטוקולים שנסרקו:</div>
                <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px">
                    ${cleanCities.map(c => `<span style="background:#e8f8e8;padding:4px 12px;border-radius:4px;font-size:0.85em;color:#2a6a2a">${c}</span>`).join('')}
                </div>
            </div>`;
        }

        html += '</div>';
        document.getElementById('redflags-list').innerHTML = html;
    }

    // ── Research tab ──
    function renderResearch() {
        if (typeof RESEARCH === 'undefined') {
            document.getElementById('clusters-grid').innerHTML = '<p style="text-align:center;color:#888">נתוני מחקר לא נטענו</p>';
            return;
        }

        const grid = document.getElementById('clusters-grid');
        let html = '';
        for (const [id, cluster] of Object.entries(RESEARCH.clusters)) {
            const findings = (cluster.key_findings || []).slice(0, 4);
            html += `<div class="cluster-card">
                <h4>${cluster.name_he}
                    <span class="risk-badge ${riskBadgeClass(cluster.risk_score)}" style="font-size:0.7em;margin-right:8px">
                        סיכון: ${cluster.risk_level}
                    </span>
                </h4>
                <div class="cluster-orgs">ארגונים: ${cluster.orgs.join(', ')}</div>
                <div class="cluster-summary">${cluster.summary}</div>
                ${findings.length > 0 ? `
                    <ul class="cluster-findings">
                        ${findings.map(f => `<li>${f}</li>`).join('')}
                    </ul>` : ''}
                ${cluster.report_url ? `<a class="report-link" href="${cluster.report_url}" target="_blank">&#128196; קרא דוח מלא</a>` : ''}
            </div>`;
        }
        grid.innerHTML = html;
    }

    // ── Hero stats ──
    function renderHeroStats() {
        const all = getAllEntries();
        const totalCities = new Set(all.map(e => e.city)).size;

        // Deduplicated program count and budget
        const seenIds = new Set();
        let totalProgs = 0, totalBudget = 0;
        for (const progs of Object.values(DATA.worst_programs || {})) {
            for (const p of progs) {
                if (!seenIds.has(p.id)) {
                    seenIds.add(p.id);
                    totalProgs++;
                    totalBudget += p.budget || 0;
                }
            }
        }
        const protoCities = Object.keys(DATA.protocol_details || {}).length;
        const clusterCount = typeof RESEARCH !== 'undefined' ? Object.keys(RESEARCH.clusters).length : 0;

        document.getElementById('hero-stats').innerHTML = `
            <div class="hero-stat"><div class="val">${totalCities}</div><div class="lbl">ערים בדירוג</div></div>
            <div class="hero-stat"><div class="val">${totalProgs.toLocaleString()}</div><div class="lbl">תוכניות נותחו</div></div>
            <div class="hero-stat"><div class="val">\u20AA${Math.round(totalBudget/1000000)} מיליון</div><div class="lbl">תקציב מסומן</div></div>
            <div class="hero-stat"><div class="val">${protoCities}</div><div class="lbl">ערים עם פרוטוקולים</div></div>
            <div class="hero-stat"><div class="val">${clusterCount}</div><div class="lbl">אשכולות ארגוניים</div></div>
        `;
        document.getElementById('hero-stats').innerHTML += '<div style="font-size:0.72em;color:rgba(255,255,255,0.6);text-align:center;width:100%;margin-top:6px">מקורות: <a href="https://apps.education.gov.il/gefen" target="_blank" style="color:rgba(255,255,255,0.8)">גפ"ן</a> · <a href="https://votes25.bechirot.gov.il/" target="_blank" style="color:rgba(255,255,255,0.8)">בחירות כנסת 25</a> · <a href="https://news.google.com/?hl=iw&gl=IL" target="_blank" style="color:rgba(255,255,255,0.8)">Google News</a> · פרוטוקולי מועצות · <a href="research/" target="_blank" style="color:rgba(255,255,255,0.8)">46 דוחות מחקר</a></div>';
    }

    // ── Protocol Browser ──
    function highlightKeywords(text) {
        if (typeof HIGHLIGHT_KEYWORDS === 'undefined') return text.replace(/</g, '&lt;');
        let escaped = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        // Build regex from all keywords — red flags first (higher priority)
        const rfKws = (HIGHLIGHT_KEYWORDS.red_flag || []).filter(k => k.length > 0);
        const pbKws = (HIGHLIGHT_KEYWORDS.pole_b || []).filter(k => k.length > 0);
        // Red flags
        if (rfKws.length > 0) {
            const rfPattern = rfKws.map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
            escaped = escaped.replace(new RegExp(rfPattern, 'gi'), m => `<mark class="red-flag">${m}</mark>`);
        }
        // Pole B keywords
        if (pbKws.length > 0) {
            const pbPattern = pbKws.map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|');
            escaped = escaped.replace(new RegExp(pbPattern, 'gi'), m => {
                // Don't double-highlight if already inside a mark tag
                return `<mark class="pole-b">${m}</mark>`;
            });
        }
        return escaped;
    }

    function hitBadgeClass(count) {
        if (count >= 5) return 'proto-hit-high';
        if (count >= 2) return 'proto-hit-medium';
        if (count >= 1) return 'proto-hit-low';
        return 'proto-hit-none';
    }

    let _protoIdx = 0;
    function renderProtocolBrowser() {
        if (typeof PROTOCOLS === 'undefined') {
            document.getElementById('proto-browser-list').innerHTML =
                '<p style="text-align:center;color:#888;padding:20px">נתוני פרוטוקולים לא נטענו</p>';
            return;
        }

        const filter = document.getElementById('proto-city-filter').value;
        const container = document.getElementById('proto-browser-list');

        // Populate filter dropdown (once)
        const select = document.getElementById('proto-city-filter');
        if (select.options.length <= 1) {
            for (const [key, cityData] of Object.entries(PROTOCOLS)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = cityData.city_name + ' (' + cityData.extracted_count + ')';
                select.appendChild(opt);
            }
        }

        // Collect protocols to show
        let allProtos = [];
        for (const [key, cityData] of Object.entries(PROTOCOLS)) {
            if (filter !== 'all' && filter !== key) continue;
            for (const p of cityData.protocols) {
                allProtos.push({...p, city_key: key, city_name: cityData.city_name, source_url: cityData.source_url || ''});
            }
        }

        // Sort by hit count desc
        allProtos.sort((a, b) => b.hit_count - a.hit_count);

        document.getElementById('proto-browser-count').textContent =
            allProtos.length + ' פרוטוקולים' + (allProtos.filter(p => p.hit_count > 0).length
                ? ' | ' + allProtos.filter(p => p.hit_count > 0).length + ' עם מילות מפתח'
                : '');

        let html = '';
        for (const p of allProtos) {
            const uid = 'pbr-' + (_protoIdx++);
            const dateStr = p.date && p.date !== 'UNDATED' ? p.date : 'ללא תאריך';
            const kwHits = p.keyword_hits || {};
            const kwPills = Object.entries(kwHits)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([kw, c]) => {
                    const isRed = (HIGHLIGHT_KEYWORDS.red_flag || []).includes(kw);
                    return '<span class="proto-kw-pill' + (isRed ? ' red' : '') + '">' + c + '× ' + kw + '</span>';
                }).join('');

            const sourceLink = p.source_url
                ? '<a href="' + p.source_url + '" target="_blank" onclick="event.stopPropagation()" style="color:#2a5a8a;font-size:0.8em;text-decoration:none">&#128279; מקור</a>'
                : '';

            html += '<div class="proto-card" onclick="toggleProtoCard(\'' + uid + '\',this)">' +
                '<div class="proto-card-header">' +
                    '<div>' +
                        '<div class="proto-card-title">' + p.city_name + ' — ' + p.filename.replace(/\.pdf$/, '') + '</div>' +
                        '<div class="proto-card-meta">' + dateStr + ' | ' + (p.text_length || 0).toLocaleString() + ' תווים ' + sourceLink + '</div>' +
                    '</div>' +
                    '<div class="proto-card-badges">' +
                        '<span class="proto-hit-badge ' + hitBadgeClass(p.hit_count) + '">' +
                            p.hit_count + ' מילות מפתח' +
                        '</span>' +
                    '</div>' +
                '</div>' +
                (kwPills ? '<div class="proto-kw-summary">' + kwPills + '</div>' : '') +
                '<div class="proto-card-text" id="' + uid + '"></div>' +
            '</div>';
        }

        container.innerHTML = html;

        // Store protocol data for lazy rendering
        container._protocols = allProtos;
    }

    function toggleProtoCard(uid, card) {
        const el = document.getElementById(uid);
        if (!el) return;
        const wasVisible = el.classList.contains('visible');
        el.classList.toggle('visible');
        card.classList.toggle('expanded');

        // Lazy-render text with highlighting on first open
        if (!wasVisible && !el.dataset.rendered) {
            const container = document.getElementById('proto-browser-list');
            const idx = parseInt(uid.replace('pbr-', ''));
            // Find protocol by matching uid offset
            const cards = container.querySelectorAll('.proto-card');
            let cardIdx = 0;
            for (let i = 0; i < cards.length; i++) {
                if (cards[i] === card) { cardIdx = i; break; }
            }
            const protos = container._protocols;
            if (protos && protos[cardIdx]) {
                el.innerHTML = highlightKeywords(protos[cardIdx].text);
            }
            el.dataset.rendered = '1';
        }
    }

    // Switch to protocols tab filtered to a specific city
    function showCityProtocols(cityKey) {
        switchTab('protocols', document.querySelectorAll('.nav-tab')[3]);
        // Wait for DOM to settle, then set filter
        setTimeout(() => {
            const select = document.getElementById('proto-city-filter');
            if (select) {
                select.value = cityKey;
                renderProtocolBrowser();
                // Scroll to protocol browser
                const header = document.querySelector('.proto-browser-header');
                if (header) header.scrollIntoView({behavior: 'smooth'});
            }
        }, 100);
    }

    // ── Initial render ──
    renderHeroStats();
    render();
    updateSortUI();
    </script>
</body>
</html>
